<!DOCTYPE html>
<!-- Private Quiz Creator - Lukavac v1.0 -->
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Privatni Kviz - Lukavac</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Metal+Mania&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand:      #b75800;
            --brand-dark: #632705;
            --brand-mid:  #d97706;
            --brand-light:#ffd995;
            --brand-pale: #fffff1;
            --green:      #10b981;
            --blue:       #3b82f6;
            --red:        #ef4444;
            --card-shadow:0 4px 20px rgba(183,88,0,.13);
        }
        * { box-sizing:border-box; margin:0; padding:0; }

        body {
            background: linear-gradient(135deg, #e8c99a 0%, #b87333 50%, #e8c99a 100%);
            font-family: 'Nunito', 'Segoe UI', sans-serif;
            min-height: 100vh;
            padding-bottom: 40px;
        }
        .hallock { font-family:'Metal Mania',cursive; }

        /* â”€â”€ TOP BAR â”€â”€ */
        .topbar {
            background:white;
            box-shadow:0 2px 12px rgba(0,0,0,.12);
            padding:10px 16px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            position:sticky; top:0; z-index:100;
        }
        .topbar-logo { font-family:'Metal Mania',cursive; font-size:1.3rem; color:var(--brand); }
        .topbar-back { background:var(--brand-pale); border:1.5px solid var(--brand-light); border-radius:10px; padding:6px 14px; font-size:.82rem; font-weight:700; color:var(--brand); cursor:pointer; text-decoration:none; }

        /* â”€â”€ STEPS NAV â”€â”€ */
        .steps-nav {
            display:flex;
            gap:0;
            background:white;
            border-radius:16px;
            box-shadow:var(--card-shadow);
            padding:6px;
            margin:14px 16px;
            overflow-x:auto;
        }
        .step-btn {
            flex:1;
            padding:9px 6px;
            border:none;
            border-radius:12px;
            background:transparent;
            font-family:'Metal Mania',cursive;
            font-size:.78rem;
            color:var(--brand-dark);
            cursor:pointer;
            transition:all .2s;
            white-space:nowrap;
            min-width:0;
            text-align:center;
        }
        .step-btn.active {
            background:linear-gradient(135deg,var(--brand-light),var(--brand));
            color:white;
            box-shadow:0 4px 12px rgba(183,88,0,.3);
        }
        .step-btn .step-num {
            display:block;
            font-family:'Nunito',sans-serif;
            font-size:.62rem;
            font-weight:800;
            opacity:.7;
            margin-bottom:1px;
        }

        /* â”€â”€ MAIN CONTENT â”€â”€ */
        .max-w { max-width:600px; margin:0 auto; padding:0 16px; }
        .card { background:white; border-radius:16px; box-shadow:var(--card-shadow); padding:18px; margin-bottom:14px; }
        .card-title { font-family:'Metal Mania',cursive; font-size:1.05rem; color:var(--brand); margin-bottom:14px; padding-bottom:9px; border-bottom:3px solid var(--brand); display:flex; align-items:center; gap:7px; }
        .section { display:none; }
        .section.active { display:block; }

        /* â”€â”€ FORMS â”€â”€ */
        .form-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
        .form-row.single { grid-template-columns:1fr; }
        .form-group { margin-bottom:12px; }
        .form-label { display:block; font-weight:800; font-size:.8rem; color:var(--brand-dark); margin-bottom:5px; text-transform:uppercase; letter-spacing:.04em; }
        .form-input {
            width:100%; border:2px solid var(--brand-light); border-radius:10px;
            padding:9px 13px; font-family:'Nunito',sans-serif; font-size:.88rem;
            color:#1f2937; transition:border-color .2s; background:var(--brand-pale);
        }
        .form-input:focus { border-color:var(--brand); outline:none; background:white; }
        select.form-input { cursor:pointer; }
        textarea.form-input { min-height:90px; resize:vertical; }

        /* â”€â”€ BUTTONS â”€â”€ */
        .btn { border:none; border-radius:12px; padding:10px 18px; font-family:'Metal Mania',cursive; font-size:.9rem; cursor:pointer; transition:all .2s; display:inline-flex; align-items:center; gap:6px; }
        .btn:hover { transform:translateY(-2px); box-shadow:0 6px 18px rgba(0,0,0,.18); }
        .btn-brand { background:linear-gradient(135deg,var(--brand-light),var(--brand)); color:white; }
        .btn-green { background:linear-gradient(135deg,#a7f3d0,var(--green)); color:white; }
        .btn-blue  { background:linear-gradient(135deg,#bfdbfe,var(--blue)); color:white; }
        .btn-red   { background:linear-gradient(135deg,#fecaca,var(--red)); color:white; }
        .btn-ghost { background:white; border:1.5px solid var(--brand-light); color:var(--brand); }
        .btn-full  { width:100%; justify-content:center; padding:13px; }
        .btn-sm    { padding:5px 12px; font-size:.78rem; border-radius:8px; }

        /* â”€â”€ QUESTIONS TABLE â”€â”€ */
        .q-row {
            background:var(--brand-pale);
            border:1.5px solid var(--brand-light);
            border-radius:12px;
            padding:12px 14px;
            margin-bottom:10px;
            position:relative;
        }
        .q-row-header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:10px;
        }
        .q-num { font-family:'Metal Mania',cursive; font-size:1rem; color:var(--brand); }
        .answers-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px; }
        .answer-opt {
            display:flex; gap:6px; align-items:center;
            background:white; border:1.5px solid #e5e7eb; border-radius:8px; padding:6px 8px;
        }
        .answer-opt.correct { border-color:var(--green); background:#f0fdf4; }
        .answer-opt input[type=radio] { accent-color:var(--green); width:16px; height:16px; flex-shrink:0; cursor:pointer; }
        .answer-opt input[type=text] { flex:1; border:none; background:transparent; font-size:.82rem; font-family:'Nunito',sans-serif; outline:none; }

        /* â”€â”€ PLAYERS INVITE â”€â”€ */
        .player-chip {
            display:inline-flex; align-items:center; gap:5px;
            background:var(--brand-pale); border:1.5px solid var(--brand-light);
            border-radius:20px; padding:4px 10px 4px 7px;
            font-size:.8rem; font-weight:700; color:var(--brand-dark);
            margin:3px;
        }
        .player-chip button { background:none; border:none; cursor:pointer; color:#9ca3af; font-size:.9rem; line-height:1; padding:0; }
        .player-chip button:hover { color:var(--red); }

        /* â”€â”€ NOTIF SETTINGS â”€â”€ */
        .notif-row {
            display:flex; align-items:center; gap:10px;
            padding:9px 12px; border:1.5px solid var(--brand-light);
            border-radius:10px; margin-bottom:7px;
            background:var(--brand-pale);
        }
        .notif-row input[type=checkbox] { width:17px; height:17px; accent-color:var(--brand); flex-shrink:0; }

        /* â”€â”€ REVIEW TABLE â”€â”€ */
        .review-row { display:flex; justify-content:space-between; align-items:flex-start; padding:9px 0; border-bottom:1px solid #f3f4f6; font-size:.86rem; }
        .review-label { color:#6b7280; font-weight:700; font-size:.76rem; text-transform:uppercase; }
        .review-val   { color:#1f2937; font-weight:700; text-align:right; }

        /* â”€â”€ MODAL â”€â”€ */
        .modal-backdrop { display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:500; align-items:center; justify-content:center; padding:16px; }
        .modal-backdrop.open { display:flex; }
        .modal-card { background:white; border-radius:20px; padding:22px; max-width:440px; width:100%; box-shadow:0 20px 60px rgba(0,0,0,.25); }

        /* â”€â”€ DISPLAY MODE â”€â”€ */
        #display-mode {
            display:none;
            position:fixed; inset:0;
            background:#0f0f0f;
            z-index:9999;
            flex-direction:column;
            align-items:center;
            justify-content:center;
        }
        #display-mode.active { display:flex; }

        /* â”€â”€ MISC â”€â”€ */
        .badge { display:inline-flex; align-items:center; gap:4px; padding:2px 10px; border-radius:20px; font-size:.7rem; font-weight:800; text-transform:uppercase; }
        .badge-green { background:#d1fae5; color:#065f46; border:1px solid #a7f3d0; }
        .badge-orange { background:var(--brand-pale); color:var(--brand); border:1px solid var(--brand-light); }
        .badge-blue { background:#dbeafe; color:#1d4ed8; border:1px solid #93c5fd; }

        .tag-info { background:#eff6ff; border:1.5px solid #bfdbfe; border-radius:10px; padding:10px 14px; font-size:.8rem; color:#1d4ed8; margin-bottom:12px; }

        @keyframes spin { to { transform:rotate(360deg); } }
        .spinner { width:24px; height:24px; border:3px solid var(--brand-light); border-top-color:var(--brand); border-radius:50%; animation:spin .7s linear infinite; margin:0 auto; }

        @keyframes fadeUp { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:translateY(0); } }
        .fade-up { animation:fadeUp .3s ease; }

        /* â”€â”€ PROGRESS BAR â”€â”€ */
        .prog-bar { background:#e5e7eb; border-radius:99px; height:8px; overflow:hidden; }
        .prog-fill { background:linear-gradient(90deg,var(--brand-light),var(--brand)); height:100%; border-radius:99px; transition:width .4s ease; }

        /* CSV download link */
        a.csv-link { color:var(--blue); font-weight:700; text-decoration:underline; cursor:pointer; font-size:.82rem; }
    </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â• TOP BAR â•â•â•â•â•â•â•â• -->
<div class="topbar">
    <div class="topbar-logo">ğŸ¦Š PRIVATNI KVIZ</div>
    <div style="display:flex;align-items:center;gap:8px;">
        <div style="font-size:.8rem;color:#6b7280;" id="topbar-name">â€”</div>
        <a href="dashboard.html" class="topbar-back">â† Dashboard</a>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â• STEPS NAV â•â•â•â•â•â•â•â• -->
<div class="steps-nav">
    <button class="step-btn active" onclick="goStep(0)" id="step-btn-0">
        <span class="step-num">KORAK 1</span>Osnove
    </button>
    <button class="step-btn" onclick="goStep(1)" id="step-btn-1">
        <span class="step-num">KORAK 2</span>Pitanja
    </button>
    <button class="step-btn" onclick="goStep(2)" id="step-btn-2">
        <span class="step-num">KORAK 3</span>Postavke
    </button>
    <button class="step-btn" onclick="goStep(3)" id="step-btn-3">
        <span class="step-num">KORAK 4</span>IgraÄi
    </button>
    <button class="step-btn" onclick="goStep(4)" id="step-btn-4">
        <span class="step-num">KORAK 5</span>Pregled
    </button>
</div>

<div class="max-w">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     KORAK 1 â€” OSNOVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="section-0" class="section active fade-up">

    <div class="card">
        <div class="card-title">ğŸ“‹ Naziv i Tip Kviza</div>
        <div class="form-group">
            <label class="form-label">Naziv kviza (dodaje se uz "Lukavac")</label>
            <input type="text" class="form-input" id="pq-title" placeholder="npr. Maturalno Slavlje, Obiteljski Kviz...">
            <div style="font-size:.74rem;color:#9ca3af;margin-top:4px;">Prikazivat Ä‡e se kao: <strong id="name-preview" style="color:var(--brand);">LUKAVAC ...</strong></div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Datum i Vrijeme</label>
                <input type="datetime-local" class="form-input" id="pq-start">
            </div>
            <div class="form-group">
                <label class="form-label">Lozinka za ulaz</label>
                <input type="text" class="form-input" id="pq-password" value="1234">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Min. IgraÄa</label>
                <input type="number" class="form-input" id="pq-min" value="2" min="2">
            </div>
            <div class="form-group">
                <label class="form-label">Max. IgraÄa</label>
                <input type="number" class="form-input" id="pq-max" value="20" min="2">
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Opis / Napomena za igraÄe (opcionalno)</label>
            <textarea class="form-input" id="pq-desc" placeholder="Kratki opis, pravila, ugoÄ‘aj..."></textarea>
        </div>
    </div>

    <div class="card">
        <div class="card-title">ğŸ”’ Vidljivost Kviza</div>
        <label style="display:flex;align-items:flex-start;gap:12px;cursor:pointer;padding:10px;background:var(--brand-pale);border:1.5px solid var(--brand-light);border-radius:12px;margin-bottom:10px;">
            <input type="radio" name="pq-visibility" id="vis-private" value="private" checked style="width:18px;height:18px;accent-color:var(--brand);margin-top:2px;flex-shrink:0;">
            <div>
                <div style="font-weight:800;font-size:.88rem;color:var(--brand-dark);">ğŸ”’ Privatan â€” samo pozvani igraÄi</div>
                <div style="font-size:.75rem;color:#6b7280;margin-top:2px;">Nema odobrenja admina, odmah aktivan. Samo osobe koje pozivaÅ¡ iz imenika mogu sudjelovati.</div>
            </div>
        </label>
        <label style="display:flex;align-items:flex-start;gap:12px;cursor:pointer;padding:10px;background:#f0fdf4;border:1.5px solid #a7f3d0;border-radius:12px;">
            <input type="radio" name="pq-visibility" id="vis-public" value="public" style="width:18px;height:18px;accent-color:var(--green);margin-top:2px;flex-shrink:0;">
            <div>
                <div style="font-weight:800;font-size:.88rem;color:#065f46;">ğŸŒ Javan â€” zahtijeva odobrenje admina</div>
                <div style="font-size:.75rem;color:#6b7280;margin-top:2px;">Kviz ide na pregled adminu. Nakon odobrenja pojavljuje se svim igraÄima. Tvoje ime kao autora bit Ä‡e vidljivo.</div>
            </div>
        </label>
    </div>

    <button onclick="goStep(1)" class="btn btn-brand btn-full">Dalje: Pitanja â†’</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     KORAK 2 â€” PITANJA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="section-1" class="section fade-up">

    <div class="card">
        <div class="card-title">â“ Pitanja Kviza</div>

        <!-- Import/Export CSV -->
        <div style="background:#eff6ff;border:1.5px solid #bfdbfe;border-radius:12px;padding:12px 14px;margin-bottom:14px;">
            <div style="font-weight:800;font-size:.85rem;color:#1d4ed8;margin-bottom:6px;">ğŸ“¥ Uvoz / Izvoz pitanja</div>
            <div style="font-size:.78rem;color:#3b82f6;margin-bottom:8px;">
                Preuzmi CSV predloÅ¾ak, popuni u Excelu, pa uvezi. Ili izvezi trenutna pitanja u CSV.
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button onclick="downloadCSVTemplate()" class="btn btn-blue btn-sm">â¬‡ï¸ Preuzmi CSV predloÅ¾ak</button>
                <label class="btn btn-ghost btn-sm" style="cursor:pointer;">
                    ğŸ“‚ Uvezi CSV
                    <input type="file" accept=".csv" onchange="importCSV(this)" style="display:none;">
                </label>
                <button onclick="exportQuestionsCSV()" class="btn btn-ghost btn-sm">â¬†ï¸ Izvezi CSV</button>
                <button onclick="sendCSVByEmail()" class="btn btn-ghost btn-sm">ğŸ“§ PoÅ¡alji na mail</button>
            </div>
        </div>

        <!-- Questions list -->
        <div id="questions-list"></div>

        <button onclick="addQuestion()" class="btn btn-brand btn-full" style="margin-top:4px;">
            â• Dodaj Pitanje
        </button>
    </div>

    <div style="display:flex;gap:10px;">
        <button onclick="goStep(0)" class="btn btn-ghost" style="flex:1;">â† Natrag</button>
        <button onclick="goStep(2)" class="btn btn-brand" style="flex:2;">Dalje: Postavke â†’</button>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     KORAK 3 â€” POSTAVKE KVIZA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="section-2" class="section fade-up">

    <div class="card">
        <div class="card-title">â±ï¸ Timeri i Krugovi</div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Broj Krugova</label>
                <input type="number" class="form-input" id="pq-rounds" value="3" min="1" max="10" oninput="buildRoundsUI()">
            </div>
            <div class="form-group">
                <label class="form-label">Pitanja po Krugu</label>
                <input type="number" class="form-input" id="pq-qpr" value="5" min="1" oninput="syncQCount()">
            </div>
            <div class="form-group">
                <label class="form-label">Timer Odgovora (sek)</label>
                <input type="number" class="form-input" id="pq-timer-ans" value="30" min="5">
            </div>
            <div class="form-group">
                <label class="form-label">Timer Pauze (sek)</label>
                <input type="number" class="form-input" id="pq-timer-pause" value="5" min="1">
            </div>
        </div>
        <div id="rounds-ui"></div>
    </div>

    <div class="card">
        <div class="card-title">ğŸ’° Nagrade i Tokeni</div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Nagradni Fond (â‚¬)</label>
                <input type="number" class="form-input" id="pq-prize" value="0" min="0">
                <small style="color:#9ca3af;font-size:.72rem;">Za privatni kviz moÅ¾e biti 0â‚¬ â€” Äisto zabavno</small>
            </div>
            <div class="form-group">
                <label class="form-label">Cijena Ulaza (tokeni)</label>
                <input type="number" class="form-input" id="pq-tokens" value="0" min="0">
                <small style="color:#9ca3af;font-size:.72rem;">0 = besplatan ulaz za pozvane</small>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-title">ğŸ”” Automatske Notifikacije</div>
        <p style="font-size:.8rem;color:#6b7280;margin-bottom:12px;">Pozvani igraÄi automatski dobivaju ove obavijesti:</p>
        <div id="pq-notif-list">
            <!-- Built by buildNotifCheckboxes() -->
        </div>
    </div>

    <div class="card">
        <div class="card-title">ğŸ–¥ï¸ Display Postavke</div>
        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px;background:var(--brand-pale);border:1.5px solid var(--brand-light);border-radius:12px;">
            <input type="checkbox" id="pq-author-display" checked style="width:18px;height:18px;accent-color:var(--brand);">
            <div>
                <div style="font-weight:800;font-size:.88rem;color:var(--brand-dark);">ğŸ“º Prati kviz uÅ¾ivo kao autor</div>
                <div style="font-size:.75rem;color:#6b7280;margin-top:2px;">Kad kviz startava, automatski se otvara display prikaz u tvojem browseru â€” gledaÅ¡ odgovore igraÄa u realnom vremenu.</div>
            </div>
        </label>
    </div>

    <div style="display:flex;gap:10px;">
        <button onclick="goStep(1)" class="btn btn-ghost" style="flex:1;">â† Natrag</button>
        <button onclick="goStep(3)" class="btn btn-brand" style="flex:2;">Dalje: IgraÄi â†’</button>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     KORAK 4 â€” IGRAÄŒI (IMENIK)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="section-3" class="section fade-up">

    <div class="card">
        <div class="card-title">ğŸ‘¥ Pozovi IgraÄe</div>

        <div class="tag-info">
            ğŸ”’ <strong>Privatni poziv</strong> â€” ne treba odobrenje admina. Pozvani igraÄi dobivaju notifikaciju unutar aplikacije te mogu odmah potvrditi ili odbiti.
        </div>

        <!-- Search bar -->
        <div style="position:relative;margin-bottom:12px;">
            <input type="text" class="form-input" id="player-search"
                   placeholder="ğŸ” TraÅ¾i igraÄa po nadimku ili imenu..."
                   oninput="searchPlayers(this.value)">
        </div>

        <!-- Search results -->
        <div id="player-results" style="max-height:200px;overflow-y:auto;margin-bottom:12px;"></div>

        <!-- Selected chips -->
        <div style="font-weight:800;font-size:.78rem;color:var(--brand-dark);text-transform:uppercase;letter-spacing:.05em;margin-bottom:7px;">Pozvani igraÄi:</div>
        <div id="invited-chips" style="min-height:40px;display:flex;flex-wrap:wrap;gap:3px;padding:8px;background:var(--brand-pale);border:1.5px solid var(--brand-light);border-radius:12px;">
            <span style="font-size:.78rem;color:#9ca3af;align-self:center;" id="no-invited-msg">JoÅ¡ nisi pozvao nikog</span>
        </div>
        <div style="font-size:.74rem;color:#9ca3af;margin-top:5px;" id="invited-count">0 pozvanih igraÄa</div>

        <!-- Friends / recent -->
        <div style="margin-top:14px;">
            <div style="font-weight:800;font-size:.78rem;color:var(--brand-dark);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px;">â­ Moji Poznanici</div>
            <div id="friends-list">
                <div class="spinner" style="margin:10px auto;"></div>
            </div>
        </div>
    </div>

    <div style="display:flex;gap:10px;">
        <button onclick="goStep(2)" class="btn btn-ghost" style="flex:1;">â† Natrag</button>
        <button onclick="goStep(4)" class="btn btn-brand" style="flex:2;">Dalje: Pregled â†’</button>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     KORAK 5 â€” PREGLED I OBJAVA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="section-4" class="section fade-up">

    <div class="card">
        <div class="card-title">âœ… Pregled Kviza</div>
        <div style="margin-bottom:4px;font-size:.8rem;font-weight:700;color:var(--brand);">CUNNING</div>
        <div class="hallock" style="font-size:1.6rem;color:var(--brand-dark);margin-bottom:14px;" id="review-title">â€”</div>
        <div id="review-details"></div>
    </div>

    <div class="card">
        <div class="card-title">ğŸš€ Objavi Kviz</div>

        <!-- Progress indicator -->
        <div id="publish-checklist" style="margin-bottom:16px;"></div>

        <div id="publish-error" style="display:none;background:#fef2f2;border:1.5px solid #fca5a5;border-radius:10px;padding:10px 14px;font-size:.82rem;color:#ef4444;margin-bottom:12px;"></div>

        <button onclick="publishQuiz()" class="btn btn-brand btn-full" style="padding:15px;font-size:1rem;" id="publish-btn">
            ğŸš€ Objavi Privatni Kviz
        </button>

        <div style="text-align:center;margin-top:10px;">
            <span style="font-size:.74rem;color:#9ca3af;">Kviz Ä‡e biti odmah aktivan i pozvani igraÄi bit Ä‡e obavijeÅ¡teni.</span>
        </div>
    </div>

    <button onclick="goStep(3)" class="btn btn-ghost btn-full">â† Natrag</button>
</div>

</div><!-- /max-w -->

<!-- â•â•â•â•â•â•â•â• DISPLAY MODE (fullscreen author view) â•â•â•â•â•â•â•â• -->
<div id="display-mode">
    <div style="text-align:center;color:white;padding:20px;width:100%;max-width:800px;">
        <div class="hallock" style="font-size:2rem;color:var(--brand-light);margin-bottom:6px;" id="dm-quiz-name">KVIZ</div>
        <div style="font-size:.85rem;color:#9ca3af;margin-bottom:30px;">ğŸ‘ï¸ Autorski Prikaz â€” gledaÅ¡ odgovore igraÄa u realnom vremenu</div>

        <!-- Current question -->
        <div style="background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:20px;padding:24px;margin-bottom:20px;">
            <div style="font-size:.72rem;color:var(--brand-light);font-weight:800;text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px;" id="dm-phase">ÄŒekanje na start...</div>
            <div style="font-size:1.3rem;font-weight:800;color:white;line-height:1.4;margin-bottom:16px;" id="dm-question">â€”</div>
            <div id="dm-answers" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"></div>
        </div>

        <!-- Players live grid -->
        <div>
            <div style="font-size:.75rem;color:#9ca3af;font-weight:700;text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px;">IgraÄi <span id="dm-player-count" style="color:var(--brand-light);">0</span></div>
            <div id="dm-players-grid" style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;"></div>
        </div>

        <button onclick="exitDisplay()" style="margin-top:24px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:white;border-radius:12px;padding:8px 20px;cursor:pointer;font-size:.82rem;">
            âœ• Zatvori prikaz
        </button>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â• SUCCESS MODAL â•â•â•â•â•â•â•â• -->
<div id="success-modal" class="modal-backdrop">
    <div class="modal-card" style="text-align:center;">
        <div style="font-size:3rem;margin-bottom:8px;">ğŸ‰</div>
        <div class="hallock" style="font-size:1.4rem;color:var(--brand);margin-bottom:6px;">Kviz Objavljen!</div>
        <div style="font-size:.85rem;color:#6b7280;margin-bottom:4px;" id="success-msg">UspjeÅ¡no kreiran privatni kviz.</div>
        <div style="font-size:.8rem;color:var(--brand);font-weight:700;margin-bottom:18px;" id="success-submsg"></div>
        <div style="display:flex;gap:10px;flex-direction:column;">
            <button onclick="window.location.href='dashboard.html'" class="btn btn-brand btn-full">â† Na Dashboard</button>
            <button onclick="resetForm()" class="btn btn-ghost btn-full">â• Napravi Novi Kviz</button>
        </div>
    </div>
</div>

<script>
// â”€â”€â”€ GLOBALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let playerProfileId = sessionStorage.getItem('playerProfileId');
let playerProfile   = null;
let allPlayers      = [];
let invitedIds      = new Set();
let questions       = []; // array of { text, answers:[{text,correct}], difficulty }
let currentStep     = 0;

const NOTIF_TEMPLATES = [
    { id:'n2h',   label:'2 sata prije',    offset:-2*3600000, msg:'ğŸ® Za 2h startava {name}! Pripremi se.', type:'warning' },
    { id:'n30m',  label:'30 minuta prije', offset:-30*60000,  msg:'â° Za 30min startava {name}!', type:'warning' },
    { id:'n10m',  label:'10 minuta prije', offset:-10*60000,  msg:'ğŸš¨ Za 10min startava {name}! UÄ‘i odmah.', type:'warning' },
    { id:'n2m',   label:'2 minute prije',  offset:-2*60000,   msg:'ğŸ”´ {name} za 2 MINUTE! Idi na aplikaciju!', type:'quiz' },
    { id:'nstart',label:'Na startu',        offset:0,          msg:'ğŸ® {name} je poÄeo! Klikni i igraj!', type:'quiz' },
];

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onload = function() {
    if (!playerProfileId) { window.location.href = 'login.html'; return; }
    const raw = sessionStorage.getItem('playerProfile');
    if (raw) { playerProfile = JSON.parse(raw); }

    // Refresh from Firebase
    database.ref(`playerProfiles/${playerProfileId}`).once('value').then(snap => {
        playerProfile = { id: playerProfileId, ...snap.val() };
        sessionStorage.setItem('playerProfile', JSON.stringify(playerProfile));
        const nick = playerProfile.nickname || playerProfile.firstName || 'â€”';
        document.getElementById('topbar-name').textContent = nick;
    });

    // Load all players for search + friends
    database.ref('playerProfiles').once('value').then(snap => {
        const data = snap.val() || {};
        allPlayers = Object.entries(data)
            .map(([id, p]) => ({ id, ...p }))
            .filter(p => p.id !== playerProfileId);
        loadFriendsList();
    });

    // Set default start time to tomorrow at 20:00
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(20, 0, 0, 0);
    document.getElementById('pq-start').value = tomorrow.toISOString().slice(0, 16);

    // Init UI
    addQuestion(); addQuestion(); addQuestion(); // start with 3 blank
    buildRoundsUI();
    buildNotifCheckboxes();
    updateNamePreview();
    buildReview();

    document.getElementById('pq-title').addEventListener('input', updateNamePreview);
};

// â”€â”€â”€ STEPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goStep(n) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.step-btn').forEach((b,i) => b.classList.toggle('active', i===n));
    document.getElementById(`section-${n}`).classList.add('active');
    currentStep = n;
    if (n === 3) loadFriendsList();
    if (n === 4) buildReview();
    window.scrollTo({top:0, behavior:'smooth'});
}

// â”€â”€â”€ NAME PREVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateNamePreview() {
    const v = document.getElementById('pq-title').value.trim().toUpperCase() || '...';
    document.getElementById('name-preview').textContent = `LUKAVAC ${v}`;
}

// â”€â”€â”€ QUESTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let qCount = 0;
function addQuestion(data) {
    qCount++;
    const id = qCount;
    const el = document.getElementById('questions-list');
    const div = document.createElement('div');
    div.className = 'q-row fade-up';
    div.id = `q-row-${id}`;
    div.innerHTML = `
        <div class="q-row-header">
            <span class="q-num">â“ Pitanje ${id}</span>
            <div style="display:flex;gap:6px;align-items:center;">
                <select id="q-diff-${id}" style="border:1.5px solid var(--brand-light);border-radius:8px;padding:4px 8px;font-size:.75rem;color:var(--brand-dark);background:var(--brand-pale);">
                    <option value="easy">ğŸŸ¢ Lako</option>
                    <option value="medium" selected>ğŸŸ¡ Srednje</option>
                    <option value="hard">ğŸ”´ TeÅ¡ko</option>
                </select>
                <button onclick="removeQuestion(${id})" style="background:#fef2f2;border:1.5px solid #fca5a5;border-radius:8px;padding:4px 9px;cursor:pointer;color:#ef4444;font-size:.78rem;font-weight:700;">âœ•</button>
            </div>
        </div>
        <input type="text" class="form-input" id="q-text-${id}"
               placeholder="UpiÅ¡i tekst pitanja..."
               value="${data?.text||''}"
               style="margin-bottom:10px;">
        <div style="font-size:.74rem;font-weight:800;color:var(--brand-dark);text-transform:uppercase;letter-spacing:.04em;margin-bottom:6px;">Odgovori (oznaÄi toÄan):</div>
        <div class="answers-grid">
            ${[0,1,2,3].map(i => {
                const ans = data?.answers?.[i] || {};
                return `<label class="answer-opt ${ans.correct?'correct':''}" id="ans-label-${id}-${i}">
                    <input type="radio" name="correct-${id}" value="${i}" ${ans.correct?'checked':''} onchange="markCorrect(${id},${i})">
                    <input type="text" id="ans-${id}-${i}" placeholder="${['A','B','C','D'][i]}) ..." value="${ans.text||''}" style="width:100%;">
                </label>`;
            }).join('')}
        </div>
    `;
    el.appendChild(div);
}

function markCorrect(qid, ansIdx) {
    for (let i=0;i<4;i++) {
        const lbl = document.getElementById(`ans-label-${qid}-${i}`);
        if (lbl) lbl.classList.toggle('correct', i===ansIdx);
    }
}

function removeQuestion(id) {
    const el = document.getElementById(`q-row-${id}`);
    if (el) el.remove();
}

function collectQuestions() {
    const rows = document.querySelectorAll('.q-row');
    const result = [];
    rows.forEach(row => {
        const id  = row.id.replace('q-row-','');
        const txt = document.getElementById(`q-text-${id}`)?.value?.trim();
        if (!txt) return;
        const answers = [0,1,2,3].map(i => ({
            text:    document.getElementById(`ans-${id}-${i}`)?.value?.trim() || '',
            correct: document.querySelector(`input[name="correct-${id}"]:checked`)?.value == i
        }));
        const difficulty = document.getElementById(`q-diff-${id}`)?.value || 'medium';
        result.push({ text: txt, answers, difficulty });
    });
    return result;
}

// â”€â”€â”€ CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function downloadCSVTemplate() {
    const header = 'pitanje,odgovor_a,odgovor_b,odgovor_c,odgovor_d,tocno(a/b/c/d),tezina(easy/medium/hard)';
    const example = [
        'Koji je glavni grad Hrvatske?,Zagreb,Split,Rijeka,Osijek,a,easy',
        'Koliko noga ima hobotnica?,4,6,8,10,c,medium',
        '"Tko je napisao ""Hamlet""?",Shakespeare,Dickens,Tolkien,Goethe,a,hard',
    ].join('\n');
    const csv = header + '\n' + example;
    const blob = new Blob(['\uFEFF'+csv], {type:'text/csv;charset=utf-8'});
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url; a.download = 'lukavac_pitanja_predlozak.csv';
    a.click(); URL.revokeObjectURL(url);
}

function importCSV(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        const text = e.target.result.replace(/^\uFEFF/,'');
        const lines = text.split('\n').filter(l=>l.trim());
        let imported = 0;
        // Skip header
        for (let i=1;i<lines.length;i++) {
            const cols = parseCSVLine(lines[i]);
            if (cols.length < 5) continue;
            const [qtxt, a, b, c, d, correct, diff] = cols;
            if (!qtxt) continue;
            const correctIdx = {'a':0,'b':1,'c':2,'d':3}[correct?.toLowerCase()?.trim()] ?? 0;
            const answers = [a,b,c,d].map((t,idx) => ({text:t.trim(), correct: idx===correctIdx}));
            addQuestion({ text: qtxt.trim(), answers, difficulty: diff?.trim()||'medium' });
            imported++;
        }
        alert(`âœ… Uvezeno ${imported} pitanja!`);
        input.value = '';
    };
    reader.readAsText(file, 'UTF-8');
}

function parseCSVLine(line) {
    const result = []; let cur = ''; let inQ = false;
    for (let i=0;i<line.length;i++) {
        const ch = line[i];
        if (ch==='"' && !inQ) { inQ=true; }
        else if (ch==='"' && inQ && line[i+1]==='"') { cur+='"'; i++; }
        else if (ch==='"' && inQ) { inQ=false; }
        else if (ch===',' && !inQ) { result.push(cur); cur=''; }
        else cur+=ch;
    }
    result.push(cur);
    return result;
}

function exportQuestionsCSV() {
    const qs = collectQuestions();
    if (!qs.length) { alert('Nema pitanja za izvoz!'); return; }
    const header = 'pitanje,odgovor_a,odgovor_b,odgovor_c,odgovor_d,tocno(a/b/c/d),tezina';
    const rows = qs.map(q => {
        const ci = q.answers.findIndex(a=>a.correct);
        const lbl = ['a','b','c','d'][ci] || 'a';
        return [q.text,...q.answers.map(a=>a.text),lbl,q.difficulty].map(v=>`"${(v||'').replace(/"/g,'""')}"`).join(',');
    });
    const csv = header + '\n' + rows.join('\n');
    const blob = new Blob(['\uFEFF'+csv], {type:'text/csv;charset=utf-8'});
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href=url; a.download='lukavac_pitanja.csv'; a.click(); URL.revokeObjectURL(url);
}

function sendCSVByEmail() {
    const qs = collectQuestions();
    if (!qs.length) { alert('Nema pitanja za slanje!'); return; }
    const email = playerProfile?.email || prompt('Unesi email adresu:');
    if (!email) return;

    const header = 'pitanje,odgovor_a,odgovor_b,odgovor_c,odgovor_d,tocno,tezina\n';
    const rows = qs.map(q => {
        const ci = q.answers.findIndex(a=>a.correct);
        return [q.text,...q.answers.map(a=>a.text),['a','b','c','d'][ci]||'a',q.difficulty].join(',');
    });
    const body = encodeURIComponent(header + rows.join('\n'));
    const subject = encodeURIComponent(`Lukavac pitanja â€” ${document.getElementById('pq-title').value||'Kviz'}`);
    window.open(`mailto:${email}?subject=${subject}&body=${body}`);
}

// â”€â”€â”€ ROUNDS UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildRoundsUI() {
    const n = parseInt(document.getElementById('pq-rounds').value) || 3;
    const qpr = parseInt(document.getElementById('pq-qpr').value) || 5;
    let html = `<div style="margin-top:12px;font-size:.78rem;font-weight:800;color:var(--brand-dark);text-transform:uppercase;letter-spacing:.04em;margin-bottom:8px;">Eliminacija po krugovima:</div>`;
    for (let i=0;i<n;i++) {
        html += `
        <div style="background:var(--brand-pale);border:1.5px solid var(--brand-light);border-radius:10px;padding:10px 12px;margin-bottom:7px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
            <span style="font-family:'Metal Mania',cursive;font-size:.95rem;color:var(--brand);min-width:70px;">Krug ${i+1}</span>
            <div style="display:flex;align-items:center;gap:6px;">
                <label style="font-size:.74rem;font-weight:700;color:#6b7280;">Ostaje:</label>
                <input type="number" id="pq-remain-${i}" value="${i===n-1?1:50}" min="1"
                       style="width:60px;border:1.5px solid var(--brand-light);border-radius:7px;padding:4px 7px;font-size:.82rem;">
                <select id="pq-remain-type-${i}" style="border:1.5px solid var(--brand-light);border-radius:7px;padding:4px 7px;font-size:.78rem;">
                    <option value="percent">%</option>
                    <option value="number" ${i===n-1?'selected':''}>igraÄa</option>
                </select>
            </div>
        </div>`;
    }
    document.getElementById('rounds-ui').innerHTML = html;
}

function syncQCount() { buildRoundsUI(); }

// â”€â”€â”€ NOTIF CHECKBOXES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildNotifCheckboxes() {
    let html = '';
    NOTIF_TEMPLATES.forEach(t => {
        html += `
        <div class="notif-row">
            <input type="checkbox" id="notif-${t.id}" checked>
            <div style="flex:1;">
                <div style="font-weight:700;font-size:.83rem;color:var(--brand-dark);">${t.label}</div>
                <input type="text" id="notif-msg-${t.id}" value="${t.msg}"
                       style="width:100%;border:1px solid #e5e7eb;border-radius:7px;padding:4px 8px;font-size:.75rem;margin-top:3px;background:white;font-family:'Nunito',sans-serif;">
            </div>
        </div>`;
    });
    document.getElementById('pq-notif-list').innerHTML = html;
}

// â”€â”€â”€ PLAYERS SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function searchPlayers(q) {
    const el = document.getElementById('player-results');
    if (!q.trim()) { el.innerHTML=''; return; }
    const lower = q.toLowerCase();
    const matches = allPlayers.filter(p =>
        (p.nickname||'').toLowerCase().includes(lower) ||
        (p.firstName||'').toLowerCase().includes(lower) ||
        (p.lastName||'').toLowerCase().includes(lower)
    ).slice(0, 8);

    if (!matches.length) { el.innerHTML='<div style="font-size:.8rem;color:#9ca3af;padding:8px;">Nema rezultata</div>'; return; }
    el.innerHTML = matches.map(p => {
        const name = p.nickname || `${p.firstName||''} ${p.lastName||''}`.trim() || 'â€”';
        const invited = invitedIds.has(p.id);
        return `<div style="display:flex;align-items:center;gap:10px;padding:8px 10px;border:1.5px solid ${invited?'var(--brand-light)':'#e5e7eb'};border-radius:10px;margin-bottom:5px;background:${invited?'var(--brand-pale)':'white'};">
            <div style="flex:1;">
                <div style="font-weight:700;font-size:.86rem;">${name}</div>
                <div style="font-size:.7rem;color:#9ca3af;">ğŸ¥‡ ${p.stats?.wins||0} pobj. Â· â­ ${p.stats?.averageRating?parseFloat(p.stats.averageRating).toFixed(1):'â€”'}</div>
            </div>
            ${invited
                ? `<button onclick="uninvite('${p.id}')" class="btn btn-ghost btn-sm" style="font-family:'Nunito',sans-serif;font-size:.75rem;">âœ“ Pozvan</button>`
                : `<button onclick="invite('${p.id}','${name.replace(/'/g,' ')}')" class="btn btn-green btn-sm" style="font-family:'Nunito',sans-serif;font-size:.75rem;">+ Pozovi</button>`}
        </div>`;
    }).join('');
}

function invite(id, name) {
    if (invitedIds.has(id)) return;
    invitedIds.add(id);
    renderInvitedChips();
    const q = document.getElementById('player-search').value;
    if (q) searchPlayers(q);
}

function uninvite(id) {
    invitedIds.delete(id);
    renderInvitedChips();
    const q = document.getElementById('player-search').value;
    if (q) searchPlayers(q);
}

function renderInvitedChips() {
    const el = document.getElementById('invited-chips');
    const noMsg = document.getElementById('no-invited-msg');
    if (!invitedIds.size) {
        el.innerHTML = ''; el.appendChild(noMsg); noMsg.style.display='';
        document.getElementById('invited-count').textContent = '0 pozvanih igraÄa';
        return;
    }
    noMsg.style.display = 'none';
    let html = '';
    invitedIds.forEach(id => {
        const p = allPlayers.find(x=>x.id===id);
        const name = p ? (p.nickname||p.firstName||'â€”') : id;
        html += `<span class="player-chip">${name} <button onclick="uninvite('${id}')">âœ•</button></span>`;
    });
    el.innerHTML = html;
    document.getElementById('invited-count').textContent = `${invitedIds.size} pozvanih igraÄa`;
}

function loadFriendsList() {
    const el = document.getElementById('friends-list');
    database.ref(`playerProfiles/${playerProfileId}/friends`).once('value').then(snap => {
        const friends = snap.val();
        if (!friends || !Object.keys(friends).length) {
            el.innerHTML = '<div style="font-size:.8rem;color:#9ca3af;text-align:center;padding:12px;">NemaÅ¡ dodanih poznanika. Dodaj ih iz popisa igraÄa kviza.</div>';
            return;
        }
        let html = '<div style="display:flex;flex-wrap:wrap;gap:6px;">';
        Object.entries(friends).forEach(([fid, f]) => {
            const name = f.name || fid;
            const inv  = invitedIds.has(fid);
            html += `<div style="display:inline-flex;align-items:center;gap:7px;padding:7px 12px;
                         background:${inv?'var(--brand-pale)':'white'};border:1.5px solid ${inv?'var(--brand)':'var(--brand-light)'};
                         border-radius:20px;font-size:.82rem;font-weight:700;color:var(--brand-dark);">
                ${name}
                ${inv
                    ? `<button onclick="uninvite('${fid}')" style="background:none;border:none;cursor:pointer;color:#ef4444;font-size:.85rem;font-weight:900;">âœ•</button>`
                    : `<button onclick="invite('${fid}','${name.replace(/'/g,' ')}')" style="background:none;border:none;cursor:pointer;color:var(--green);font-size:.85rem;font-weight:900;">+</button>`}
            </div>`;
        });
        html += '</div>';
        el.innerHTML = html;
    });
}

// â”€â”€â”€ REVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildReview() {
    const title = document.getElementById('pq-title')?.value?.trim() || 'â€”';
    const start = document.getElementById('pq-start')?.value;
    const vis   = document.querySelector('input[name="pq-visibility"]:checked')?.value || 'private';
    const qs    = collectQuestions();
    const rounds= document.getElementById('pq-rounds')?.value || 3;

    document.getElementById('review-title').textContent = `LUKAVAC ${title.toUpperCase()}`;

    const details = [
        ['ğŸ“… Datum i Vrijeme', start ? new Date(start).toLocaleString('hr-HR') : 'â€”'],
        ['â“ Broj Pitanja', `${qs.length} pitanja`],
        ['ğŸ”„ Krugovi', `${rounds} krugova`],
        ['ğŸ’° Nagradni Fond', `${document.getElementById('pq-prize')?.value||0}â‚¬`],
        ['ğŸª™ Cijena Ulaza', `${document.getElementById('pq-tokens')?.value||0} tokena`],
        ['ğŸ‘¥ Pozvani IgraÄi', `${invitedIds.size} igraÄa`],
        ['ğŸ”’ Vidljivost', vis==='public' ? 'ğŸŒ Javan (Äeka odobrenje)' : 'ğŸ”’ Privatan'],
        ['âœï¸ Autor', playerProfile?.nickname || playerProfile?.firstName || 'â€”'],
    ];
    document.getElementById('review-details').innerHTML = details.map(([l,v]) =>
        `<div class="review-row"><span class="review-label">${l}</span><span class="review-val">${v}</span></div>`
    ).join('');

    // Checklist
    const checks = [
        { ok: !!title, label: 'Naziv kviza' },
        { ok: !!start, label: 'Datum i vrijeme' },
        { ok: qs.length >= 1, label: `Pitanja (${qs.length}/1+)` },
        { ok: invitedIds.size >= 1, label: `Pozvani igraÄi (${invitedIds.size}/1+)` },
    ];
    document.getElementById('publish-checklist').innerHTML = checks.map(c =>
        `<div style="display:flex;align-items:center;gap:8px;padding:5px 0;">
            <span style="font-size:1rem;">${c.ok?'âœ…':'â¬œ'}</span>
            <span style="font-size:.83rem;color:${c.ok?'#065f46':'#9ca3af'};font-weight:${c.ok?700:600};">${c.label}</span>
        </div>`
    ).join('');
}

// â”€â”€â”€ PUBLISH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function publishQuiz() {
    const title   = document.getElementById('pq-title').value.trim();
    const startVal= document.getElementById('pq-start').value;
    const vis     = document.querySelector('input[name="pq-visibility"]:checked').value;
    const qs      = collectQuestions();
    const authorName = playerProfile?.nickname || playerProfile?.firstName || 'Nepoznat';

    // Validate
    const errors = [];
    if (!title)          errors.push('Unesi naziv kviza.');
    if (!startVal)       errors.push('Odaberi datum i vrijeme.');
    if (qs.length < 1)   errors.push('Dodaj barem 1 pitanje.');
    if (invitedIds.size < 1) errors.push('Pozovi barem 1 igraÄa.');

    const errEl = document.getElementById('publish-error');
    if (errors.length) {
        errEl.style.display=''; errEl.textContent = errors.join(' â€¢ ');
        return;
    }
    errEl.style.display = 'none';

    const startTime = new Date(startVal).getTime();
    const quizName  = `LUKAVAC ${title.toUpperCase()}`;
    const numRounds = parseInt(document.getElementById('pq-rounds').value)||3;
    const qpr       = parseInt(document.getElementById('pq-qpr').value)||5;

    // Build rounds array
    const rounds = [];
    for (let i=0;i<numRounds;i++) {
        rounds.push({
            questions:      qpr,
            remainingType:  document.getElementById(`pq-remain-type-${i}`)?.value||'percent',
            remainingValue: parseInt(document.getElementById(`pq-remain-${i}`)?.value)||50,
            timeAnswer:     parseInt(document.getElementById('pq-timer-ans').value)||30,
            timePause:      parseInt(document.getElementById('pq-timer-pause').value)||5,
            autoKickPlayers:true, autoNextRound:true, earlyContinue:true,
            values:[200,100,-50,-100,-200]
        });
    }

    // Collect notif configs
    const notifConfigs = NOTIF_TEMPLATES
        .filter(t => document.getElementById(`notif-${t.id}`)?.checked)
        .map(t => ({
            offsetMs: t.offset,
            msg: (document.getElementById(`notif-msg-${t.id}`)?.value || t.msg)
                .replace(/{name}/g, quizName)
                .replace(/{time}/g, new Date(startTime).toLocaleTimeString('hr-HR',{hour:'2-digit',minute:'2-digit'})),
            type: t.type
        }));

    const quizData = {
        name:       quizName,
        nameSuffix: title.toUpperCase(),
        type:       'private',
        isPrivate:  vis === 'private',
        visibility: vis,
        authorId:   playerProfileId,
        authorName: vis === 'public' ? authorName : null,
        startTime,
        prizePool:  parseInt(document.getElementById('pq-prize').value)||0,
        tokenCost:  parseInt(document.getElementById('pq-tokens').value)||0,
        minPlayers: parseInt(document.getElementById('pq-min').value)||2,
        maxPlayers: parseInt(document.getElementById('pq-max').value)||20,
        description:document.getElementById('pq-desc').value,
        questionCount: qs.length,
        numRounds,
        questions:  qs,
        registeredPlayers: [...invitedIds],
        playerCount: invitedIds.size,
        status:      vis === 'public' ? 'pending_review' : 'scheduled',
        createdAt:   Date.now(),
        settings: {
            password:   document.getElementById('pq-password').value||'1234',
            minPlayers: parseInt(document.getElementById('pq-min').value)||2,
            maxPlayers: parseInt(document.getElementById('pq-max').value)||20,
            numRounds, roundEndTimer:10, noviKrugTimer:5,
            showHeaderBar:true, leaderboardPosition:'bottom',
            rounds
        }
    };

    const btn = document.getElementById('publish-btn');
    btn.textContent = 'â³ Objavljujem...'; btn.disabled = true;

    database.ref('scheduledQuizzes').push(quizData).then(ref => {
        const qid = ref.key;

        // Register author
        database.ref(`playerProfiles/${playerProfileId}/registeredQuizzes/${qid}`).set({
            quizId: qid, registeredAt: Date.now(), status:'registered', tokensPaid:0
        });

        // Send invite notifications to all invited players
        const inviteMsg = `ğŸ“© ${authorName} te poziva na kviz: "${quizName}" koji startava ${new Date(startTime).toLocaleString('hr-HR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'})}. Provjeri Moje Kvizove!`;
        const invitePromises = [...invitedIds].map(pid =>
            database.ref(`notifications/${pid}`).push({
                message: inviteMsg, type:'quiz', quizId: qid,
                timestamp: Date.now(), read: false, from: playerProfileId
            })
        );

        // Schedule timed notifications
        const snBatch = {};
        notifConfigs.forEach(n => {
            const sendAt = startTime + n.offsetMs;
            if (sendAt < Date.now() - 30000) return;
            const key = database.ref('scheduledNotifications').push().key;
            snBatch[key] = {
                quizId: qid, quizName, sendAt, message: n.msg, type: n.type,
                players: [...invitedIds, playerProfileId], sent: false, createdAt: Date.now()
            };
        });
        if (Object.keys(snBatch).length) database.ref('scheduledNotifications').update(snBatch);

        // If public â€” notify admin
        if (vis === 'public') {
            database.ref('adminNotifLog').push({
                message: `ğŸŒ Novi javni privatni kviz na pregled: "${quizName}" od ${authorName}`,
                quizId: qid, type:'info', timestamp: Date.now(), read: false
            });
        }

        // Setup display mode listener if author wants to watch
        if (document.getElementById('pq-author-display').checked) {
            setupDisplayMode(qid, quizName);
        }

        Promise.all(invitePromises).then(() => {
            document.getElementById('success-msg').textContent =
                vis === 'private'
                    ? `Kviz "${quizName}" je zakazan! ${invitedIds.size} igraÄa je pozvano.`
                    : `Kviz "${quizName}" je poslan na pregled adminu.`;
            document.getElementById('success-submsg').textContent =
                vis === 'public' ? 'ğŸ“¬ Dobit Ä‡eÅ¡ notifikaciju kad admin odobri ili odbije kviz.' : '';
            document.getElementById('success-modal').classList.add('open');
        });

        btn.textContent = 'ğŸš€ Objavi Privatni Kviz'; btn.disabled = false;
    }).catch(e => {
        alert('âŒ GreÅ¡ka: ' + e.message);
        btn.textContent = 'ğŸš€ Objavi Privatni Kviz'; btn.disabled = false;
    });
}

// â”€â”€â”€ DISPLAY MODE (author live view) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupDisplayMode(qid, quizName) {
    document.getElementById('dm-quiz-name').textContent = quizName;

    // Listen for quiz state
    database.ref('gameState').on('value', snap => {
        const gs = snap.val();
        if (!gs) return;
        if (gs.quizId && gs.quizId !== qid) return; // different quiz

        const phase = gs.phase || 'waiting';
        document.getElementById('dm-phase').textContent =
            phase==='answering' ? `â±ï¸ Pitanje ${gs.questionIndex||1} â€” Odgovaranje` :
            phase==='revealing' ? 'ğŸ” Otkrivanje odgovora' :
            phase==='leaderboard' ? 'ğŸ† Ljestvica' :
            phase==='waiting'   ? 'â³ ÄŒekanje na start...' :
            phase==='gameEnd'   ? 'ğŸ Kviz zavrÅ¡en!' : phase;

        if (gs.currentQuestion) {
            document.getElementById('dm-question').textContent = gs.currentQuestion.text || 'â€”';
            const opts = gs.currentQuestion.answers || [];
            document.getElementById('dm-answers').innerHTML = opts.map((a,i) =>
                `<div style="background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:10px;padding:10px 14px;text-align:left;font-size:.88rem;color:white;font-weight:600;">
                    <span style="opacity:.6;font-size:.75rem;">${['A','B','C','D'][i]}) </span>${a.text}
                    ${a.correct?'<span style="float:right;color:#a7f3d0;font-weight:800;">âœ“</span>':''}
                </div>`
            ).join('');
        }

        // Show players
        if (gs.players) {
            const pArr = Object.values(gs.players);
            document.getElementById('dm-player-count').textContent = pArr.length;
            document.getElementById('dm-players-grid').innerHTML = pArr.map(p => {
                const answered = p.hasAnswered;
                const score    = p.score || 0;
                return `<div style="background:rgba(255,255,255,${answered?'.18':'.07'});border:1px solid rgba(255,255,255,${answered?'.35':'.12'});border-radius:10px;padding:8px 12px;min-width:100px;text-align:center;transition:all .3s;">
                    <div style="font-size:.82rem;font-weight:800;color:${answered?'#a7f3d0':'white'};margin-bottom:2px;">${p.name||'â€”'}</div>
                    <div style="font-size:.7rem;color:rgba(255,255,255,.6);">${score}â‚¬ ${answered?'âœ“':''}</div>
                </div>`;
            }).join('');
        }

        // Auto-open display when quiz goes live
        if (phase !== 'waiting' && phase !== 'gameEnd') {
            document.getElementById('display-mode').classList.add('active');
        }
    });
}

function exitDisplay() {
    document.getElementById('display-mode').classList.remove('active');
}

// â”€â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetForm() {
    document.getElementById('success-modal').classList.remove('open');
    document.getElementById('pq-title').value = '';
    document.getElementById('questions-list').innerHTML = '';
    invitedIds.clear();
    qCount = 0;
    addQuestion(); addQuestion(); addQuestion();
    renderInvitedChips();
    updateNamePreview();
    goStep(0);
}
</script>
</body>
</html>
