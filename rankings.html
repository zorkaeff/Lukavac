<!DOCTYPE html>
<!-- Rankings v1.0 -->
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rang Lista - Lukavac</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Tillana:wght@400;500;600;700;800&family=Metal+Mania&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand:      #b75800;
            --brand-dark: #632705;
            --brand-mid:  #d97706;
            --brand-light:#ffd995;
            --brand-pale: #fffff1;
            --green:      #10b981;
            --green-dark: #059669;
            --red:        #ef4444;
            --card-shadow:0 4px 15px rgba(0,0,0,.13);
        }
        * { box-sizing:border-box; margin:0; padding:0; }
        body {
            background: linear-gradient(135deg, #e8c99a 0%, #b87333 50%, #e8c99a 100%);
            font-family: 'Tillana','Segoe UI',sans-serif;
            min-height: 100vh;
        }

        /* TOP BAR */
        .topbar {
            background: white;
            box-shadow: 0 2px 12px rgba(0,0,0,.12);
            padding: 10px 16px;
            display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 100; gap: 10px;
        }
        .topbar-title { font-family:'Metal Mania',cursive; font-size:1.3rem; color:var(--brand); }
        .topbar-back {
            background:var(--brand-pale); border:1.5px solid var(--brand-light);
            border-radius:10px; padding:6px 14px; font-size:.82rem; font-weight:700;
            color:var(--brand); cursor:pointer; text-decoration:none; white-space:nowrap;
        }
        .topbar-back:hover { background:var(--brand-light); }

        /* LAYOUT */
        .page-wrap { max-width: 900px; margin: 0 auto; padding: 14px 12px 50px; }

        /* STATS BAR */
        .stats-bar { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-bottom:14px; }
        .stat-box {
            background: linear-gradient(135deg, var(--brand-pale), var(--brand-light));
            border: 1.5px solid var(--brand);
            border-radius: 13px; padding: 11px 6px 12px; text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,.07); position:relative; overflow:hidden;
        }
        .stat-box::after {
            content:''; position:absolute; bottom:0; left:0; right:0; height:3px;
            background: linear-gradient(90deg,var(--brand-light),var(--brand),var(--brand-dark));
        }
        .stat-box .sv { font-family:'Metal Mania',cursive; font-size:1.2rem; color:var(--brand); line-height:1; margin-bottom:2px; }
        .stat-box .sl { font-family:'Metal Mania',cursive; font-size:.6rem; color:var(--brand-dark); letter-spacing:.02em; }
        .stat-box.green { border-color:#a7f3d0; }
        .stat-box.green .sv  { color:var(--green); }
        .stat-box.green::after { background:linear-gradient(90deg,#a7f3d0,var(--green),#059669); }
        .stat-box.blue  { border-color:#bfdbfe; }
        .stat-box.blue .sv   { color:#3b82f6; }
        .stat-box.blue::after  { background:linear-gradient(90deg,#bfdbfe,#3b82f6,#1d4ed8); }
        .stat-box.purple { border-color:#ddd6fe; }
        .stat-box.purple .sv { color:#7c3aed; }
        .stat-box.purple::after { background:linear-gradient(90deg,#ddd6fe,#7c3aed,#4c1d95); }

        /* MODE TABS */
        .mode-card {
            background:white; border-radius:16px; box-shadow:var(--card-shadow);
            padding:12px 14px 14px; margin-bottom:14px;
        }
        .mode-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:7px; }
        .mode-btn {
            padding:9px 4px; border-radius:11px; border:1.5px solid var(--brand-light);
            background:var(--brand-pale); font-family:'Metal Mania',cursive; font-size:.65rem;
            color:var(--brand-dark); cursor:pointer; transition:all .18s; text-align:center; line-height:1.3;
        }
        .mode-btn:hover { border-color:var(--brand); background:var(--brand-light); }
        .mode-btn.active {
            background:linear-gradient(135deg,var(--brand-light),var(--brand));
            color:white; border-color:var(--brand);
            box-shadow:0 3px 10px rgba(183,88,0,.3);
        }
        .mode-btn .mi { font-size:.95rem; display:block; margin-bottom:2px; }

        /* SEARCH */
        .search-wrap { position:relative; margin-top:11px; }
        .search-input {
            width:100%; border:2px solid var(--brand-light); border-radius:12px;
            padding:10px 14px 10px 38px; font-family:'Tillana',sans-serif; font-size:.9rem;
            color:#1f2937; background:var(--brand-pale); transition:border-color .2s;
        }
        .search-input:focus { border-color:var(--brand); outline:none; background:white; }
        .search-icon { position:absolute; left:12px; top:50%; transform:translateY(-50%); font-size:1rem; pointer-events:none; }

        /* SECTION TITLE */
        .section-title {
            font-family:'Metal Mania',cursive; font-size:1.05rem; color:var(--brand);
            margin-bottom:10px; padding-bottom:7px; border-bottom:3px solid var(--brand);
            display:flex; align-items:center; gap:7px;
        }
        .section-title .count-badge {
            background:var(--brand); color:white; border-radius:20px;
            padding:0 8px; font-size:.65rem; margin-left:auto;
        }

        /* PODIUM */
        .podium-wrap {
            background:white; border-radius:16px; box-shadow:var(--card-shadow);
            padding:16px 14px 10px; margin-bottom:14px;
        }
        .podium { display:flex; align-items:flex-end; justify-content:center; gap:8px; padding-bottom:4px; }
        .podium-col { display:flex; flex-direction:column; align-items:center; gap:5px; flex:1; max-width:140px; }
        .podium-avatar {
            border-radius:50%; border:3px solid var(--brand-light);
            background:var(--brand-pale); display:flex; align-items:center; justify-content:center;
            font-size:1.3rem; overflow:hidden; position:relative;
            width:50px; height:50px;
        }
        .podium-col.p1 .podium-avatar { width:64px; height:64px; border-color:var(--brand); }
        .podium-col.p1 .podium-avatar::before { content:'üëë'; position:absolute; top:-18px; font-size:.9rem; }
        .podium-col.p2 .podium-avatar { border-color:#94a3b8; }
        .podium-col.p3 .podium-avatar { border-color:#c2410c; }
        .podium-name {
            font-family:'Metal Mania',cursive; font-size:.7rem; color:var(--brand-dark);
            text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:120px;
        }
        .podium-col.p1 .podium-name { font-size:.82rem; color:var(--brand); }
        .podium-val { font-family:'Metal Mania',cursive; font-size:.78rem; text-align:center; }
        .podium-block {
            border-radius:10px 10px 0 0; width:100%;
            display:flex; align-items:center; justify-content:center; padding:8px 4px; font-size:1.4rem;
        }
        .podium-col.p1 .podium-block { background:linear-gradient(180deg,#fef3c7,#fde68a); height:74px; }
        .podium-col.p2 .podium-block { background:linear-gradient(180deg,#f1f5f9,#e2e8f0); height:52px; }
        .podium-col.p3 .podium-block { background:linear-gradient(180deg,#fff7ed,#fed7aa); height:40px; }

        /* MY POSITION BANNER */
        .my-pos-banner {
            background:linear-gradient(135deg,var(--brand-pale),var(--brand-light));
            border:2px solid var(--brand); border-radius:14px; padding:12px 15px;
            margin-bottom:12px; display:flex; align-items:center; gap:12px;
            box-shadow:0 3px 10px rgba(183,88,0,.15);
        }
        .mpb-rank  { font-family:'Metal Mania',cursive; font-size:1.6rem; color:var(--brand); flex-shrink:0; }
        .mpb-label { font-size:.65rem; font-weight:800; text-transform:uppercase; letter-spacing:.07em; color:#9ca3af; }
        .mpb-name  { font-family:'Metal Mania',cursive; font-size:.9rem; color:var(--brand-dark); }
        .mpb-val   { font-family:'Metal Mania',cursive; font-size:1rem; color:var(--brand); margin-left:auto; flex-shrink:0; }

        /* PLAYER ROWS */
        .player-card {
            background:white; border-radius:13px; box-shadow:0 2px 8px rgba(0,0,0,.06);
            margin-bottom:7px; border:1.5px solid transparent;
            transition:transform .17s, box-shadow .17s;
            display:flex; align-items:center;
        }
        .player-card:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(183,88,0,.18); border-color:var(--brand-light); }
        .player-card.is-me {
            border-color:var(--brand);
            background:linear-gradient(135deg,var(--brand-pale),#fff8e6);
            box-shadow:0 0 0 2px rgba(183,88,0,.15),0 4px 14px rgba(183,88,0,.15);
        }
        .player-card.rank-1 { border-color:#d97706; background:linear-gradient(135deg,#fefce8,#fef3c7); }
        .player-card.rank-2 { border-color:#94a3b8; background:linear-gradient(135deg,#f8fafc,#f1f5f9); }
        .player-card.rank-3 { border-color:#c2410c; background:linear-gradient(135deg,#fff7ed,#ffedd5); }

        .pc-rank {
            min-width:46px; align-self:stretch; display:flex; align-items:center; justify-content:center;
            font-family:'Metal Mania',cursive; font-size:.95rem; color:var(--brand);
            border-right:1px solid rgba(0,0,0,.05); flex-shrink:0; padding:0 4px;
        }
        .player-card.rank-1 .pc-rank { color:#d97706; }
        .player-card.rank-2 .pc-rank { color:#64748b; }
        .player-card.rank-3 .pc-rank { color:#c2410c; }

        .pc-avatar {
            width:38px; height:38px; border-radius:50%; margin:0 10px;
            border:2px solid var(--brand-light); background:var(--brand-pale);
            display:flex; align-items:center; justify-content:center;
            font-size:.95rem; overflow:hidden; flex-shrink:0;
        }
        .player-card.is-me .pc-avatar { border-color:var(--brand); }

        .pc-info { flex:1; padding:10px 0; min-width:0; }
        .pc-name {
            font-family:'Metal Mania',cursive; font-size:.88rem; color:var(--brand-dark);
            white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
        }
        .player-card.is-me .pc-name { color:var(--brand); }
        .pc-sub { font-size:.62rem; color:#9ca3af; margin-top:2px; display:flex; gap:8px; flex-wrap:wrap; }

        .pc-val { padding:0 14px; text-align:right; flex-shrink:0; }
        .pc-val .pv { font-family:'Metal Mania',cursive; font-size:1.1rem; }
        .pc-val .pvl { font-size:.58rem; color:#9ca3af; font-family:'Tillana',sans-serif; margin-top:1px; }

        .me-badge {
            font-size:.55rem; background:linear-gradient(135deg,var(--brand-light),var(--brand));
            color:white; border-radius:7px; padding:1px 5px; margin-left:4px;
            font-family:'Tillana',sans-serif; font-weight:800; vertical-align:middle;
        }

        /* EMPTY / SPINNER */
        .empty-msg { text-align:center; color:#9ca3af; padding:30px 10px; font-size:.88rem; }
        @keyframes spin { to{transform:rotate(360deg)} }
        .spinner { width:26px; height:26px; border:3px solid var(--brand-light); border-top-color:var(--brand); border-radius:50%; animation:spin .7s linear infinite; margin:0 auto 8px; }
        @keyframes fadeUp { from{opacity:0;transform:translateY(7px)} to{opacity:1;transform:translateY(0)} }
        .fade-up { animation:fadeUp .22s ease; }

        @media(max-width:500px) {
            .stats-bar { grid-template-columns:repeat(2,1fr); }
            .pc-sub { display:none; }
        }
    </style>
</head>
<body>

<div class="topbar">
    <div class="topbar-title">üèÜ RANG LISTA</div>
    <div style="display:flex;align-items:center;gap:8px;">
        <span style="font-family:'Metal Mania',cursive;font-size:.78rem;color:#9ca3af;" id="topbar-player">‚Äî</span>
        <a href="dashboard.html" class="topbar-back">‚Üê Dashboard</a>
    </div>
</div>

<div class="page-wrap">

    <!-- STATS -->
    <div class="stats-bar">
        <div class="stat-box">
            <div class="sv" id="stat-players">‚Äî</div>
            <div class="sl">üë• Igraƒça</div>
        </div>
        <div class="stat-box green">
            <div class="sv" id="stat-earn">‚Äî</div>
            <div class="sl">üí∞ Ukupna Zarada</div>
        </div>
        <div class="stat-box blue">
            <div class="sv" id="stat-games">‚Äî</div>
            <div class="sl">üéÆ Ukupno Igara</div>
        </div>
        <div class="stat-box purple">
            <div class="sv" id="stat-leader">‚Äî</div>
            <div class="sl">ü•á Lider</div>
        </div>
    </div>

    <!-- MODE TABS + SEARCH -->
    <div class="mode-card">
        <div class="mode-grid">
            <button class="mode-btn active" data-mode="earnings" onclick="setMode('earnings',this)"><span class="mi">üí∞</span>Zarada</button>
            <button class="mode-btn" data-mode="wins"     onclick="setMode('wins',this)"><span class="mi">ü•á</span>Pobjede</button>
            <button class="mode-btn" data-mode="rating"   onclick="setMode('rating',this)"><span class="mi">‚≠ê</span>Ocjena</button>
            <button class="mode-btn" data-mode="games"    onclick="setMode('games',this)"><span class="mi">üéÆ</span>Igre</button>
            <button class="mode-btn" data-mode="finals"   onclick="setMode('finals',this)"><span class="mi">üéØ</span>Finala</button>
            <button class="mode-btn" data-mode="cunning"  onclick="setMode('cunning',this)"><span class="mi">ü¶ä</span>Lukavac</button>
            <button class="mode-btn" data-mode="avg"      onclick="setMode('avg',this)"><span class="mi">üìà</span>Prosjek ‚Ç¨</button>
            <button class="mode-btn" data-mode="tokens"   onclick="setMode('tokens',this)"><span class="mi">ü™ô</span>Tokeni</button>
        </div>
        <div class="search-wrap">
            <span class="search-icon">üîç</span>
            <input type="text" class="search-input" id="search-input"
                   placeholder="Tra≈æi igraƒça po nadimku..." oninput="renderList()">
        </div>
    </div>

    <!-- PODIUM -->
    <div class="podium-wrap">
        <div class="section-title" id="podium-title">üèÜ Top 3 ‚Äî Zarada</div>
        <div class="podium" id="podium">
            <div style="text-align:center;padding:20px;width:100%;"><div class="spinner"></div></div>
        </div>
    </div>

    <!-- MY POSITION -->
    <div id="my-pos-wrap" style="display:none;">
        <div class="my-pos-banner">
            <div class="mpb-rank" id="mpb-rank">#‚Äî</div>
            <div style="flex:1;">
                <div class="mpb-label">Tvoja pozicija</div>
                <div class="mpb-name" id="mpb-name">‚Äî</div>
            </div>
            <div class="mpb-val" id="mpb-val">‚Äî</div>
        </div>
    </div>

    <!-- LIST -->
    <div class="section-title">
        <span id="list-title">üìã Rang Lista ‚Äî Zarada</span>
        <span class="count-badge" id="list-count">0</span>
    </div>
    <div id="players-list">
        <div style="text-align:center;padding:30px;">
            <div class="spinner"></div>
            <div style="color:#9ca3af;font-size:.85rem;margin-top:4px;">Uƒçitavam igraƒçe...</div>
        </div>
    </div>

</div>

<script>
const playerProfileId = sessionStorage.getItem('playerProfileId');
const playerProfile   = JSON.parse(sessionStorage.getItem('playerProfile') || 'null');
const myNick = playerProfile ? (playerProfile.nickname || playerProfile.firstName || null) : null;

let allPlayers  = [];
let currentMode = 'earnings';

const MODES = {
    earnings: { label:'Zarada',       icon:'üí∞', val:p=>p.stats?.totalEarnings||0,                                            fmt:v=>v+'‚Ç¨',          color:'#10b981' },
    wins:     { label:'Pobjede',      icon:'ü•á', val:p=>p.wins||0,                                                             fmt:v=>v+' pobj.',     color:'#f59e0b' },
    rating:   { label:'Ocjena',       icon:'‚≠ê', val:p=>parseFloat((p.stats?.averageRating||0).toFixed(2)),                    fmt:v=>v.toFixed(2)+'/10', color:'#f59e0b' },
    games:    { label:'Igre',         icon:'üéÆ', val:p=>p.stats?.totalGames||0,                                                fmt:v=>v+' igara',     color:'var(--brand)' },
    finals:   { label:'Finala',       icon:'üéØ', val:p=>p.stats?.finals||p.finals||0,                                          fmt:v=>v+' fin.',      color:'#7c3aed' },
    cunning:  { label:'Lukavac',      icon:'ü¶ä', val:p=>p.stats?.cunningWins||p.cunningWins||0,                                fmt:v=>v+'√ó',          color:'var(--brand)' },
    avg:      { label:'Prosjek ‚Ç¨',    icon:'üìà', val:p=>{ const g=p.stats?.totalGames||0,e=p.stats?.totalEarnings||0; return g>0?Math.round(e/g):0; }, fmt:v=>v+'‚Ç¨', color:'#10b981' },
    tokens:   { label:'Tokeni',       icon:'ü™ô', val:p=>p.stats?.tokenBalance||0,                                              fmt:v=>v+' tok.',      color:'#6366f1' }
};

window.onload = function() {
    if (myNick) document.getElementById('topbar-player').textContent = myNick;
    database.ref('playerProfiles').once('value').then(snap => {
        const data = snap.val() || {};
        allPlayers = Object.entries(data).map(([id,p]) => ({ id, ...p }));
        updateGlobalStats();
        renderAll();
    });
};

function updateGlobalStats() {
    const total      = allPlayers.length;
    const totalEarn  = allPlayers.reduce((s,p)=>s+(p.stats?.totalEarnings||0),0);
    const totalGames = allPlayers.reduce((s,p)=>s+(p.stats?.totalGames||0),0);
    const leader     = [...allPlayers].sort((a,b)=>(b.stats?.totalEarnings||0)-(a.stats?.totalEarnings||0))[0];
    document.getElementById('stat-players').textContent = total;
    document.getElementById('stat-earn').textContent    = totalEarn + '‚Ç¨';
    document.getElementById('stat-games').textContent   = totalGames;
    document.getElementById('stat-leader').textContent  = leader ? (leader.nickname||leader.firstName||'‚Äî') : '‚Äî';
}

function setMode(mode, el) {
    currentMode = mode;
    document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('search-input').value = '';
    renderAll();
}

function renderAll() {
    const m = MODES[currentMode];
    document.getElementById('podium-title').textContent = 'üèÜ Top 3 ‚Äî ' + m.label;
    document.getElementById('list-title').textContent   = 'üìã Rang Lista ‚Äî ' + m.icon + ' ' + m.label;
    renderPodium();
    renderMyPos();
    renderList();
}

function renderPodium() {
    const m      = MODES[currentMode];
    const sorted = [...allPlayers].sort((a,b)=>m.val(b)-m.val(a));
    const top3   = sorted.slice(0,3);
    // visual order: 2nd | 1st | 3rd
    const order  = [top3[1], top3[0], top3[2]];
    const cls    = ['p2','p1','p3'];
    const medals = ['ü•à','ü•á','ü•â'];
    let html = '';
    order.forEach((p,i) => {
        if (!p) return;
        const isMe  = p.id === playerProfileId;
        const photo = p.profilePhoto ? '<img src="'+p.profilePhoto+'" style="width:100%;height:100%;object-fit:cover;">' : 'üë§';
        html += '<div class="podium-col '+cls[i]+'">'
            +'<div class="podium-avatar">'+photo+'</div>'
            +'<div class="podium-name">'+(p.nickname||p.firstName||'?')+(isMe?'<span class="me-badge">TI</span>':'')+'</div>'
            +'<div class="podium-val" style="color:'+m.color+';">'+m.fmt(m.val(p))+'</div>'
            +'<div class="podium-block">'+medals[i]+'</div>'
            +'</div>';
    });
    document.getElementById('podium').innerHTML = html || '<div class="empty-msg">Nema podataka</div>';
}

function renderMyPos() {
    if (!playerProfileId) return;
    const m      = MODES[currentMode];
    const sorted = [...allPlayers].sort((a,b)=>m.val(b)-m.val(a));
    const myIdx  = sorted.findIndex(p=>p.id===playerProfileId);
    const wrap   = document.getElementById('my-pos-wrap');
    if (myIdx === -1) { wrap.style.display='none'; return; }
    const me = sorted[myIdx];
    wrap.style.display = '';
    document.getElementById('mpb-rank').textContent = '#'+(myIdx+1);
    document.getElementById('mpb-name').textContent = myNick || 'Ti';
    document.getElementById('mpb-val').textContent  = m.fmt(m.val(me));
}

function renderList() {
    const m      = MODES[currentMode];
    const search = document.getElementById('search-input').value.trim().toLowerCase();
    const sorted = [...allPlayers].sort((a,b)=>m.val(b)-m.val(a));
    const filtered = sorted.filter(p=>
        !search ||
        (p.nickname||'').toLowerCase().includes(search)||
        (p.firstName||'').toLowerCase().includes(search)
    );
    document.getElementById('list-count').textContent = filtered.length;
    if (!filtered.length) {
        document.getElementById('players-list').innerHTML = '<div class="empty-msg">Nema igraƒça za ovaj upit</div>';
        return;
    }
    let html = '';
    filtered.forEach(p => {
        const realRank = sorted.indexOf(p)+1;
        const isMe     = p.id === playerProfileId;
        const medal    = realRank===1?'ü•á':realRank===2?'ü•à':realRank===3?'ü•â':null;
        const rankDisp = medal || ('#'+realRank);
        const rankCls  = realRank===1?'rank-1':realRank===2?'rank-2':realRank===3?'rank-3':'';
        const photo    = p.profilePhoto ? '<img src="'+p.profilePhoto+'" style="width:100%;height:100%;object-fit:cover;">' : 'üë§';
        html += '<div class="player-card '+rankCls+' '+(isMe?'is-me':'')+' fade-up">'
            +'<div class="pc-rank">'+rankDisp+'</div>'
            +'<div class="pc-avatar">'+photo+'</div>'
            +'<div class="pc-info">'
            +'<div class="pc-name">'+(p.nickname||p.firstName||'‚Äî')+(isMe?'<span class="me-badge">TI</span>':'')+'</div>'
            +'<div class="pc-sub">'
            +'<span>üéÆ '+(p.stats?.totalGames||0)+'</span>'
            +'<span>ü•á '+(p.wins||0)+'</span>'
            +'<span>üí∞ '+(p.stats?.totalEarnings||0)+'‚Ç¨</span>'
            +'<span>‚≠ê '+(p.stats?.averageRating||0).toFixed(1)+'</span>'
            +'</div>'
            +'</div>'
            +'<div class="pc-val" style="color:'+m.color+';">'
            +'<div class="pv">'+m.fmt(m.val(p))+'</div>'
            +'<div class="pvl">'+m.label+'</div>'
            +'</div>'
            +'</div>';
    });
    document.getElementById('players-list').innerHTML = html;
}
</script>
</body>
</html>