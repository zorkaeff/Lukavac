<!DOCTYPE html>
<!-- Admin Control Panel v3.0 - Lukavac UI -->
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Lukavac</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Metal+Mania&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand:       #b75800;
            --brand-dark:  #632705;
            --brand-mid:   #d97706;
            --brand-light: #ffd995;
            --brand-pale:  #fffff1;
            --sidebar-bg:  #1a0a00;
            --sidebar-w:   220px;
            --card-shadow: 0 4px 15px rgba(0,0,0,.12);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: linear-gradient(135deg, #e8c99a 0%, #b87333 50%, #e8c99a 100%);
            min-height: 100vh;
            color: #1f2937;
        }
        .hallock { font-family: 'Metal Mania', cursive; }

        /* â”€â”€ SIDEBAR â”€â”€ */
        .sidebar {
            position: fixed; top: 0; left: 0; bottom: 0;
            width: var(--sidebar-w);
            background: var(--sidebar-bg);
            z-index: 100;
            display: flex; flex-direction: column;
            box-shadow: 4px 0 20px rgba(0,0,0,.4);
        }
        .sidebar-header {
            padding: 16px 14px 14px;
            border-bottom: 1px solid rgba(255,255,255,.08);
            display: flex; align-items: center; gap: 10px;
        }
        .sidebar-header img { width: 36px; height: 36px; }
        .sidebar-title { font-family: 'Metal Mania', cursive; font-size: 1.25rem; color: var(--brand-light); line-height: 1; }
        .sidebar-sub   { font-size: .58rem; color: rgba(255,255,255,.4); font-weight: 600; }

        .sidebar-nav { flex: 1; overflow-y: auto; padding: 8px 0; }
        .nav-group-label {
            font-size: .58rem; font-weight: 700; text-transform: uppercase;
            letter-spacing: .1em; color: rgba(255,255,255,.3);
            padding: 10px 14px 4px;
        }
        .nav-item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 14px; cursor: pointer;
            font-size: .82rem; font-weight: 600;
            color: rgba(255,255,255,.65);
            border-left: 3px solid transparent;
            transition: all .18s;
            white-space: nowrap;
        }
        .nav-item:hover { background: rgba(255,255,255,.07); color: white; }
        .nav-item.active {
            background: rgba(183,88,0,.25);
            border-left-color: var(--brand-light);
            color: var(--brand-light);
        }
        .nav-item .nav-icon { font-size: 1rem; width: 20px; text-align: center; flex-shrink: 0; }

        .sidebar-footer {
            padding: 12px 14px;
            border-top: 1px solid rgba(255,255,255,.08);
        }
        .btn-live {
            display: block; width: 100%;
            background: linear-gradient(135deg, #ef4444, #991b1b);
            color: white; border: none; border-radius: 10px;
            padding: 10px; text-align: center; cursor: pointer;
            font-family: 'Metal Mania', cursive; font-size: .9rem;
            box-shadow: 0 3px 10px rgba(239,68,68,.4);
            transition: transform .15s, box-shadow .15s;
            text-decoration: none;
        }
        .btn-live:hover { transform: scale(1.03); box-shadow: 0 5px 16px rgba(239,68,68,.55); }

        /* â”€â”€ MAIN â”€â”€ */
        .main {
            margin-left: var(--sidebar-w);
            padding: 14px;
            min-height: 100vh;
            font-family: 'Inter', system-ui, sans-serif;
        }

        /* Ensure all form and body text in main is Inter */
        .main td, .main p, .main small, .main span:not(.hallock),
        .main label, .main input, .main select, .main textarea, .main button:not(.btn-live),
        .main div { font-family: 'Inter', system-ui, sans-serif; }

        /* â”€â”€ CARDS â”€â”€ */
        .card {
            background: white; border-radius: 16px;
            box-shadow: var(--card-shadow);
            padding: 18px; margin-bottom: 12px;
        }
        .card-title {
            font-family: 'Inter', sans-serif;
            font-weight: 800;
            font-size: 1rem; color: var(--brand);
            padding-bottom: 8px; margin-bottom: 14px;
            border-bottom: 3px solid var(--brand);
            display: flex; align-items: center; gap: 8px;
        }

        /* â”€â”€ SECTIONS â”€â”€ */
        .section { display: none; }
        .section.active { display: block; }

        .page-title {
            font-family: 'Metal Mania', cursive;
            font-size: 1.5rem; color: white;
            margin-bottom: 14px;
            text-shadow: 0 2px 8px rgba(0,0,0,.3);
        }

        /* â”€â”€ STAT CARDS â”€â”€ */
        .stats-grid {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 10px; margin-bottom: 12px;
        }
        .stat-card {
            background: white; border-radius: 14px;
            border: 1px solid var(--brand-light);
            padding: 14px 10px; text-align: center;
            box-shadow: var(--card-shadow);
            position: relative; overflow: hidden;
        }
        .stat-card::after {
            content: ''; position: absolute;
            bottom: 0; left: 0; right: 0; height: 3px;
            background: linear-gradient(90deg, var(--brand-light), var(--brand), var(--brand-dark));
        }
        .stat-icon { font-size: 1.4rem; margin-bottom: 4px; }
        .stat-val  { font-family: 'Metal Mania', cursive; font-size: 1.8rem; color: var(--brand); line-height: 1; }
        .stat-lbl  { font-family: 'Inter', sans-serif; font-weight: 700; font-size: .78rem; color: var(--brand-dark); }

        /* â”€â”€ FORM ELEMENTS â”€â”€ */
        .form-label { font-family: 'Inter', sans-serif; font-size: .85rem; font-weight: 800; color: var(--brand-dark); display: block; margin-bottom: 4px; }
        .form-input {
            width: 100%; padding: 9px 12px;
            border: 1.5px solid var(--brand-light);
            border-radius: 10px; font-family: 'Inter', sans-serif;
            font-size: .88rem; transition: border-color .2s;
            background: var(--brand-pale);
        }
        .form-input:focus { border-color: var(--brand); outline: none; background: white; }
        textarea.form-input { resize: vertical; min-height: 80px; }
        .form-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .form-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .form-group { margin-bottom: 10px; }

        /* â”€â”€ BUTTONS â”€â”€ */
        .btn {
            padding: 9px 18px; border: none; border-radius: 10px;
            cursor: pointer; font-family: 'Metal Mania', cursive;
            font-size: .85rem; transition: transform .15s, box-shadow .15s;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .btn:hover { transform: translateY(-1px); }
        .btn-brand   { background: linear-gradient(135deg, var(--brand), var(--brand-dark)); color: white; box-shadow: 0 3px 10px rgba(183,88,0,.35); }
        .btn-brand:hover { box-shadow: 0 5px 16px rgba(183,88,0,.5); }
        .btn-green   { background: linear-gradient(135deg, #10b981, #059669); color: white; box-shadow: 0 3px 10px rgba(16,185,129,.3); }
        .btn-green:hover { box-shadow: 0 5px 16px rgba(16,185,129,.5); }
        .btn-red     { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; box-shadow: 0 3px 10px rgba(239,68,68,.3); }
        .btn-red:hover { box-shadow: 0 5px 16px rgba(239,68,68,.5); }
        .btn-blue    { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; box-shadow: 0 3px 10px rgba(59,130,246,.3); }
        .btn-blue:hover { box-shadow: 0 5px 16px rgba(59,130,246,.5); }
        .btn-sm { padding: 5px 10px; font-size: .72rem; }
        .btn-full { width: 100%; justify-content: center; }

        /* â”€â”€ TABLE â”€â”€ */
        .tbl-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: .82rem; }
        th { background: var(--brand-pale); padding: 10px 12px; text-align: left; font-family: 'Inter', sans-serif; font-weight: 800; color: var(--brand-dark); font-size: .82rem; border-bottom: 2px solid var(--brand); white-space: nowrap; }
        td { padding: 9px 12px; border-bottom: 1px solid var(--brand-light); vertical-align: middle; }
        tr:hover td { background: var(--brand-pale); }
        tr:last-child td { border-bottom: none; }

        /* â”€â”€ BADGE â”€â”€ */
        .badge { padding: 3px 9px; border-radius: 20px; font-size: .68rem; font-weight: 700; display: inline-block; white-space: nowrap; }
        .badge-green  { background: #d1fae5; color: #065f46; }
        .badge-yellow { background: #fef3c7; color: #92400e; }
        .badge-red    { background: #fee2e2; color: #991b1b; }
        .badge-blue   { background: #dbeafe; color: #1e3a8a; }
        .badge-gray   { background: #f3f4f6; color: #6b7280; }

        /* â”€â”€ NOTIFICATION ITEM â”€â”€ */
        .notif-card {
            background: var(--brand-pale); border: 1.5px solid var(--brand-light);
            border-radius: 12px; padding: 12px 14px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: flex-start;
        }
        .notif-card.sent { background: #f0fdf4; border-color: #a7f3d0; }

        /* â”€â”€ QUIZ CARD (scheduled) â”€â”€ */
        .quiz-card {
            background: linear-gradient(135deg, var(--brand-pale), var(--brand-light));
            border: 1.5px solid var(--brand);
            border-radius: 14px; padding: 14px 16px; margin-bottom: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,.08);
        }
        .quiz-card-title {
            font-family: 'Metal Mania', cursive; font-size: 1.1rem;
            color: var(--brand); margin-bottom: 6px;
            padding-bottom: 6px; border-bottom: 2px solid var(--brand);
        }

        /* â”€â”€ PLAYER CARD (detail modal) â”€â”€ */
        .modal-bg {
            position: fixed; inset: 0; background: rgba(0,0,0,.55);
            display: none; align-items: center; justify-content: center;
            z-index: 200; padding: 16px;
        }
        .modal-bg.open { display: flex; }
        .modal-card {
            background: white; border-radius: 18px;
            box-shadow: 0 20px 60px rgba(0,0,0,.35);
            padding: 24px; width: 100%; max-width: 560px;
            max-height: 90vh; overflow-y: auto;
            animation: modalIn .22s ease;
        }
        @keyframes modalIn { from{transform:scale(.9) translateY(14px);opacity:0;} to{transform:scale(1) translateY(0);opacity:1;} }

        /* â”€â”€ RANKING PODIUM â”€â”€ */
        .podium {
            display: flex; align-items: flex-end; justify-content: center;
            gap: 10px; margin-bottom: 20px;
        }
        .podium-step {
            text-align: center; width: 90px;
        }
        .podium-avatar {
            width: 52px; height: 52px; border-radius: 50%;
            border: 3px solid #ffd995; margin: 0 auto 6px;
            background: var(--brand-pale); object-fit: cover;
            font-size: 1.4rem; display: flex; align-items: center; justify-content: center;
        }
        .podium-name { font-family: 'Metal Mania', cursive; font-size: .78rem; color: var(--brand); }
        .podium-val  { font-size: .65rem; color: #6b7280; }
        .podium-block {
            border-radius: 8px 8px 0 0;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Metal Mania', cursive; font-size: 1.6rem; color: white;
        }
        .podium-1 .podium-block { height: 80px; background: linear-gradient(135deg, #f59e0b, #d97706); }
        .podium-2 .podium-block { height: 60px; background: linear-gradient(135deg, #94a3b8, #64748b); }
        .podium-3 .podium-block { height: 44px; background: linear-gradient(135deg, #b45309, #92400e); }

        /* â”€â”€ SEARCH â”€â”€ */
        .search-box {
            display: flex; gap: 8px; align-items: center; margin-bottom: 12px;
        }
        .search-box .form-input { margin: 0; }

        /* â”€â”€ TOKEN BALANCE PILL â”€â”€ */
        .balance-pill {
            display: inline-flex; align-items: center; gap: 4px;
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border: 1px solid #10b981; border-radius: 20px;
            padding: 3px 10px; font-family: 'Metal Mania', cursive;
            font-size: .8rem; color: #065f46;
        }

        /* â”€â”€ RANK TABS â”€â”€ */
        .rank-tab {
            padding: 8px 16px; border-radius: 20px; border: 2px solid var(--brand-light);
            background: white; color: var(--brand-dark); font-size: .82rem;
            font-weight: 700; cursor: pointer; transition: all .18s;
            font-family: 'Inter', sans-serif;
        }
        .rank-tab:hover { border-color: var(--brand); color: var(--brand); }
        .rank-tab.active { background: var(--brand); color: white; border-color: var(--brand); }

        /* â”€â”€ SCROLLBAR â”€â”€ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--brand-light); border-radius: 3px; }

        @keyframes fadeUp { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
        .fu { animation: fadeUp .35s ease forwards; }
    </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="sidebar">
    <div class="sidebar-header">
        <img src="cunning_logo_lukavac.png" alt="">
        <div>
            <div class="sidebar-title">ADMIN</div>
            <div class="sidebar-sub">Lukavac Control Panel</div>
        </div>
    </div>

    <nav class="sidebar-nav">
        <div class="nav-group-label">UPRAVLJANJE</div>
        <div class="nav-item active" onclick="nav('overview', this)">
            <span class="nav-icon">ğŸ“Š</span> Pregled
        </div>
        <div class="nav-item" onclick="nav('players', this)">
            <span class="nav-icon">ğŸ‘¥</span> IgraÄi
        </div>
        <div class="nav-item" onclick="nav('rankings', this)">
            <span class="nav-icon">ğŸ†</span> Rang Lista
        </div>
        <div class="nav-item" onclick="nav('balances', this)">
            <span class="nav-icon">ğŸ’³</span> Stanje / Tokeni
        </div>

        <div class="nav-group-label">KVIZOVI</div>
        <div class="nav-item" onclick="nav('add-quiz', this)">
            <span class="nav-icon">â•</span> Novi Kviz
        </div>
        <div class="nav-item" onclick="nav('scheduled', this)">
            <span class="nav-icon">ğŸ“…</span> Zakazani Kvizovi
        </div>
        <div class="nav-item" onclick="nav('results', this)">
            <span class="nav-icon">ğŸ“ˆ</span> Rezultati
        </div>
        <div class="nav-item" onclick="nav('questions', this)">
            <span class="nav-icon">â“</span> Baza Pitanja
        </div>

        <div class="nav-group-label">KOMUNIKACIJA</div>
        <div class="nav-item" onclick="nav('notifications', this)">
            <span class="nav-icon">ğŸ””</span> Notifikacije
        </div>
        <div class="nav-item" onclick="nav('news', this)">
            <span class="nav-icon">ğŸ“°</span> Novosti
        </div>

        <div class="nav-group-label">POSTAVKE</div>
        <div class="nav-item" onclick="nav('settings', this)">
            <span class="nav-icon">âš™ï¸</span> Postavke
        </div>
    </nav>

    <div class="sidebar-footer">
        <a href="admin.html" class="btn-live">ğŸ”´ UÅ½IVO KONTROLA</a>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="main">

<!-- â•â• OVERVIEW â•â• -->
<div id="section-overview" class="section active">
    <div class="page-title hallock">ğŸ“Š Pregled Platforme</div>

    <div class="stats-grid fu">
        <div class="stat-card">
            <div class="stat-icon">ğŸ‘¥</div>
            <div class="stat-val" id="ov-players">0</div>
            <div class="stat-lbl">IgraÄa</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">â“</div>
            <div class="stat-val" id="ov-questions">0</div>
            <div class="stat-lbl">Pitanja</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ“…</div>
            <div class="stat-val" id="ov-quizzes">0</div>
            <div class="stat-lbl">Kvizova</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ’°</div>
            <div class="stat-val" id="ov-earnings">0â‚¬</div>
            <div class="stat-lbl">Uk. Zarada</div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">ğŸª™</div>
            <div class="stat-val" id="ov-tokens">0</div>
            <div class="stat-lbl">Token Prihod</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ¯</div>
            <div class="stat-val" id="ov-games">0</div>
            <div class="stat-lbl">Odigranih Igara</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ””</div>
            <div class="stat-val" id="ov-notifs">0</div>
            <div class="stat-lbl">Notifikacija</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ“°</div>
            <div class="stat-val" id="ov-news">0</div>
            <div class="stat-lbl">Novosti</div>
        </div>
    </div>

    <div class="card fu">
        <div class="card-title">âš¡ Brze Akcije</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
            <button onclick="nav('add-quiz', null)" class="btn btn-brand btn-full" style="padding:16px;">
                <div style="text-align:center;width:100%;">
                    <div style="font-size:1.8rem;margin-bottom:4px;">â•</div>
                    <div>Novi Kviz</div>
                </div>
            </button>
            <button onclick="nav('questions', null)" class="btn btn-green btn-full" style="padding:16px;">
                <div style="text-align:center;width:100%;">
                    <div style="font-size:1.8rem;margin-bottom:4px;">â“</div>
                    <div>Dodaj Pitanje</div>
                </div>
            </button>
            <button onclick="nav('notifications', null)" class="btn btn-blue btn-full" style="padding:16px;">
                <div style="text-align:center;width:100%;">
                    <div style="font-size:1.8rem;margin-bottom:4px;">ğŸ””</div>
                    <div>PoÅ¡alji Notifikaciju</div>
                </div>
            </button>
        </div>
    </div>

    <!-- Recent Players -->
    <div class="card fu">
        <div class="card-title">ğŸ‘¤ Nedavno Registrirani IgraÄi</div>
        <div class="tbl-wrap">
            <table>
                <thead><tr><th>IgraÄ</th><th>Email</th><th>Zarada</th><th>Registriran</th><th></th></tr></thead>
                <tbody id="ov-recent-players"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- â•â• PLAYERS â•â• -->
<div id="section-players" class="section">
    <div class="page-title hallock">ğŸ‘¥ IgraÄi</div>

    <div class="card">
        <div class="search-box">
            <input type="text" class="form-input" id="players-search" placeholder="ğŸ” TraÅ¾i po nadimku, imenu, emailu..." oninput="filterPlayers()">
            <button onclick="exportPlayersCSV()" class="btn btn-green">ğŸ“¥ CSV</button>
        </div>
        <div id="players-count" style="font-size:.8rem;color:#9ca3af;margin-bottom:10px;"></div>
        <div class="tbl-wrap">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>IgraÄ</th>
                        <th>Email</th>
                        <th>Lokacija</th>
                        <th>Pobjede</th>
                        <th>Zarada</th>
                        <th>Ocjena</th>
                        <th>Igre</th>
                        <th>Saldo</th>
                        <th>Registriran</th>
                        <th>Akcije</th>
                    </tr>
                </thead>
                <tbody id="players-tbody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- â•â• RANKINGS â•â• -->
<div id="section-rankings" class="section">
    <div class="page-title hallock">ğŸ† Rang Lista</div>

    <!-- Tab selector - all ranking modes -->
    <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px;">
        <button class="rank-tab active" id="rank-tab-earnings" onclick="showRanking('earnings',this)">ğŸ’° Zarada</button>
        <button class="rank-tab" id="rank-tab-wins" onclick="showRanking('wins',this)">ğŸ¥‡ Pobjede</button>
        <button class="rank-tab" id="rank-tab-rating" onclick="showRanking('rating',this)">â­ Ocjena</button>
        <button class="rank-tab" id="rank-tab-games" onclick="showRanking('games',this)">ğŸ® Odigrane Igre</button>
        <button class="rank-tab" id="rank-tab-finals" onclick="showRanking('finals',this)">ğŸ¯ Finala</button>
        <button class="rank-tab" id="rank-tab-cunning" onclick="showRanking('cunning',this)">ğŸ¦Š Lukavca</button>
        <button class="rank-tab" id="rank-tab-avg" onclick="showRanking('avg',this)">ğŸ“ˆ Prosjek â‚¬</button>
        <button class="rank-tab" id="rank-tab-tokens" onclick="showRanking('tokens',this)">ğŸª™ Tokeni</button>
    </div>

    <!-- Podium -->
    <div class="card" id="podium-container">
        <div class="card-title" id="podium-title">ğŸ¥‡ Pobodnici â€” Podij</div>
        <div class="podium" id="podium"></div>
    </div>

    <!-- Most active players card -->
    <div class="card">
        <div class="card-title">ğŸ”¥ Najaktivniji IgraÄi (najviÅ¡e kvizova)</div>
        <div class="tbl-wrap">
            <table>
                <thead><tr><th>#</th><th>IgraÄ</th><th>Kvizovi</th><th>Finala</th><th>Pobjede</th><th>Zarada</th><th>Ocjena</th></tr></thead>
                <tbody id="most-active-tbody"></tbody>
            </table>
        </div>
    </div>

    <!-- Full ranking table -->
    <div class="card">
        <div class="card-title" id="ranking-table-title">ğŸ“‹ Puna Lista â€” Zarada</div>
        <div class="tbl-wrap">
            <table>
                <thead>
                    <tr>
                        <th style="width:50px;">Rang</th>
                        <th>IgraÄ</th>
                        <th id="rank-col-main">Vrijednost</th>
                        <th>Zarada</th>
                        <th>Pobjede</th>
                        <th>Igre</th>
                        <th>Ocjena</th>
                        <th>Finala</th>
                        <th>Lokacija</th>
                    </tr>
                </thead>
                <tbody id="ranking-tbody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- â•â• BALANCES / TOKENS â•â• -->
<div id="section-balances" class="section">
    <div class="page-title hallock">ğŸ’³ Stanje IgraÄa / Tokeni</div>

    <div class="stats-grid" style="grid-template-columns:repeat(3,1fr);">
        <div class="stat-card">
            <div class="stat-icon">ğŸª™</div>
            <div class="stat-val" id="bal-total-tokens">0</div>
            <div class="stat-lbl">Ukupno Tokena</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ’¶</div>
            <div class="stat-val" id="bal-total-paid">0â‚¬</div>
            <div class="stat-lbl">UplaÄ‡eno</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ“Š</div>
            <div class="stat-val" id="bal-avg-tokens">0</div>
            <div class="stat-lbl">Prosjek/IgraÄ</div>
        </div>
    </div>

    <!-- Manual token adjustment -->
    <div class="card">
        <div class="card-title">ğŸ”§ RuÄna Korekcija Tokena</div>
        <div class="form-grid-3">
            <div class="form-group">
                <label class="form-label">IgraÄ ID / Nadimak</label>
                <input type="text" class="form-input" id="token-player-id" placeholder="ID ili nadimak igraÄa" list="player-datalist">
                <datalist id="player-datalist"></datalist>
            </div>
            <div class="form-group">
                <label class="form-label">Iznos Tokena</label>
                <input type="number" class="form-input" id="token-amount" placeholder="npr. 500 ili -200">
            </div>
            <div class="form-group">
                <label class="form-label">Razlog</label>
                <input type="text" class="form-input" id="token-reason" placeholder="Bonus, korekcija...">
            </div>
        </div>
        <div style="display:flex;gap:8px;">
            <button onclick="adjustTokens('add')" class="btn btn-green">+ Dodaj Tokene</button>
            <button onclick="adjustTokens('remove')" class="btn btn-red">- Ukloni Tokene</button>
        </div>
    </div>

    <!-- Token transactions log -->
    <div class="card">
        <div class="card-title">ğŸ“‹ Stanje Svih IgraÄa</div>
        <div class="search-box">
            <input type="text" class="form-input" id="bal-search" placeholder="ğŸ” TraÅ¾i igraÄa..." oninput="filterBalances()">
        </div>
        <div class="tbl-wrap">
            <table>
                <thead><tr><th>IgraÄ</th><th>Token Saldo</th><th>Ukupno UplaÄ‡eno</th><th>Zadnja Transakcija</th><th>Status Triala</th><th>Akcije</th></tr></thead>
                <tbody id="balances-tbody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- â•â• ADD QUIZ â•â• -->
<div id="section-add-quiz" class="section">
    <div class="page-title hallock">â• Novi Kviz</div>

    <div class="card">
        <div class="card-title">ğŸ“‹ Osnovne Informacije</div>
        <div class="form-grid-2">
            <div class="form-group">
                <label class="form-label">Naziv Kviza (sufiks)</label>
                <input type="text" class="form-input" id="qz-name" value="DANA" placeholder="DANA, SATA, TJEDNA...">
                <small style="color:#9ca3af;font-size:.72rem;">Prikazuje se kao: CUNNING [SUFIKS]</small>
            </div>
            <div class="form-group">
                <label class="form-label">Lozinka za ulaz</label>
                <input type="text" class="form-input" id="qz-password" value="1234">
            </div>
            <div class="form-group">
                <label class="form-label">Tip Kviza</label>
                <select class="form-input" id="qz-type">
                    <option value="sata">ğŸ• Lukavac Sata</option>
                    <option value="dana">ğŸŒ™ Lukavac Dana</option>
                    <option value="noci">ğŸŒƒ Lukavac NoÄ‡i</option>
                    <option value="premium">ğŸ’ Lukavac Premium</option>
                    <option value="tjedna">ğŸ“… Lukavac Tjedna</option>
                    <option value="poseban">ğŸŒŸ Poseban Kviz</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Datum i Vrijeme PoÄetka</label>
                <input type="datetime-local" class="form-input" id="qz-start">
            </div>
            <div class="form-group">
                <label class="form-label">Nagradni Fond (â‚¬)</label>
                <input type="number" class="form-input" id="qz-prize" value="100" min="0">
            </div>
            <div class="form-group">
                <label class="form-label">Cijena Ulaza (tokeni)</label>
                <input type="number" class="form-input" id="qz-token-cost" value="500" min="0">
            </div>
            <div class="form-group">
                <label class="form-label">Min. IgraÄa</label>
                <input type="number" class="form-input" id="qz-min-players" value="2" min="2">
            </div>
            <div class="form-group">
                <label class="form-label">Max. IgraÄa</label>
                <input type="number" class="form-input" id="qz-max-players" value="8" min="2">
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-title">â±ï¸ Timeri i Struktura Krugova</div>
        <div class="form-grid-2" style="margin-bottom:14px;">
            <div class="form-group">
                <label class="form-label">Broj Krugova</label>
                <input type="number" class="form-input" id="qz-num-rounds" value="6" min="1" max="20" oninput="generateRoundSettingsAdmin()">
            </div>
            <div class="form-group">
                <label class="form-label">Timer Kraja Kruga (sek)</label>
                <input type="number" class="form-input" id="qz-round-end-timer" value="10" min="1">
                <small style="color:#9ca3af;font-size:.72rem;">Trajanje "IdeÅ¡ u sljedeÄ‡i krug" ekrana</small>
            </div>
            <div class="form-group">
                <label class="form-label">Novi Krug Timer (sek)</label>
                <input type="number" class="form-input" id="qz-novi-krug-timer" value="5" min="1">
                <small style="color:#9ca3af;font-size:.72rem;">ÄŒekanje prije prvog pitanja novog kruga</small>
            </div>
        </div>

        <!-- Per-round settings - generated dynamically -->
        <div id="qz-round-settings"></div>
    </div>

    <div class="card">
        <div class="card-title">ğŸ–¥ï¸ UI Postavke</div>
        <div class="form-grid-2">
            <div class="form-group">
                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                    <input type="checkbox" id="qz-show-header" checked style="width:18px;height:18px;accent-color:var(--brand);">
                    <div>
                        <div class="form-label" style="margin:0;">PrikaÅ¾i Header Bar</div>
                        <small style="color:#9ca3af;font-size:.7rem;">Trenutni + cutoff igraÄ â€” prikazuje se u leaderboard fazi</small>
                    </div>
                </label>
            </div>
            <div class="form-group">
                <label class="form-label">Pozicija Ljestvice</label>
                <select class="form-input" id="qz-leaderboard-pos">
                    <option value="bottom">Dolje (ispod pitanja)</option>
                    <option value="top">Gore (iznad pitanja)</option>
                </select>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-title">â“ Automatski Odabir Pitanja</div>
        <p style="font-size:.82rem;color:#6b7280;margin-bottom:14px;">
            Pitanja se automatski biraju iz baze prema postavkama po krugu. MoÅ¾eÅ¡ definirati teÅ¾inu, kategorije i ograniÄenje ponavljanja.
        </p>

        <!-- Global question settings -->
        <div style="background:var(--brand-pale);border:1.5px solid var(--brand-light);border-radius:12px;padding:14px;margin-bottom:14px;">
            <div style="font-weight:700;font-size:.9rem;color:var(--brand-dark);margin-bottom:10px;">ğŸŒ Globalne Postavke Pitanja</div>
            <div class="form-grid-3">
                <div class="form-group">
                    <label class="form-label">Max. ponavljajuÄ‡ih pitanja</label>
                    <div style="display:flex;gap:6px;">
                        <input type="number" class="form-input" id="qz-max-repeat" value="20" min="0" style="flex:2;">
                        <select class="form-input" id="qz-max-repeat-type" style="flex:1;">
                            <option value="percent">%</option>
                            <option value="number">br.</option>
                        </select>
                    </div>
                    <small style="color:#9ca3af;font-size:.7rem;">Koliko veÄ‡ koriÅ¡tenih pitanja smije biti u kvizu</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Kategorije (poglavlja)</label>
                    <div id="qz-categories" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px;">
                        <!-- Generated from question bank -->
                    </div>
                    <small style="color:#9ca3af;font-size:.7rem;">Ostavi prazno = sve kategorije</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Pregled baze</label>
                    <div id="qz-bank-summary" style="font-size:.78rem;color:#6b7280;line-height:1.8;"></div>
                </div>
            </div>
        </div>

        <!-- Per-round question difficulty -->
        <div style="font-weight:700;font-size:.9rem;color:var(--brand-dark);margin-bottom:8px;">ğŸ“Š TeÅ¾ina Pitanja po Krugovima</div>
        <p style="font-size:.76rem;color:#9ca3af;margin-bottom:10px;">Za svaki krug odredi postotak/broj pitanja po teÅ¾ini. Suma ne mora biti 100% â€” sistem automatski prilagodi.</p>
        <div id="qz-question-difficulty"></div>

        <button onclick="previewQuestionSelection()" class="btn btn-blue" style="margin-top:6px;">
            ğŸ‘ï¸ Pregled Odabranih Pitanja
        </button>

        <!-- Preview panel -->
        <div id="qz-question-preview" style="display:none;margin-top:12px;">
            <div style="font-weight:700;font-size:.88rem;margin-bottom:8px;">ğŸ“‹ Pregled odabira:</div>
            <div id="qz-preview-content"></div>
        </div>
    </div>

    <div class="card">
        <div class="card-title">âš™ï¸ Napredne Postavke</div>
        <div class="form-group">
            <label class="form-label">Opis Kviza (opcionalno)</label>
            <textarea class="form-input" id="qz-desc" placeholder="Posebne napomene za igraÄe..."></textarea>
        </div>
        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;margin-bottom:14px;">
            <input type="checkbox" id="qz-save-to-settings" checked style="width:18px;height:18px;accent-color:var(--brand);">
            <div>
                <div class="form-label" style="margin:0;">Spremi kao aktivne postavke (settings)</div>
                <small style="color:#9ca3af;font-size:.7rem;">AÅ¾urira Firebase <code>settings</code> node koji koristi admin.html uÅ¾ivo kontrola</small>
            </div>
        </label>
        <button onclick="addQuiz()" class="btn btn-brand btn-full" style="padding:14px;">
            ğŸš€ ZakaÅ¾i Kviz i Spremi Postavke
        </button>
    </div>
</div>

<!-- â•â• SCHEDULED QUIZZES â•â• -->
<div id="section-scheduled" class="section">
    <div class="page-title hallock">ğŸ“… Zakazani Kvizovi</div>
    <div id="scheduled-list"></div>
</div>

<!-- â•â• RESULTS â•â• -->
<div id="section-results" class="section">
    <div class="page-title hallock">ğŸ“ˆ Rezultati Kvizova</div>

    <div class="card">
        <div class="card-title">ğŸ” Filtriraj</div>
        <div class="form-grid-2">
            <div class="form-group">
                <label class="form-label">Kviz</label>
                <select class="form-input" id="res-filter-quiz" onchange="loadResults()">
                    <option value="">Svi Kvizovi</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">IgraÄ</label>
                <input type="text" class="form-input" id="res-filter-player" placeholder="TraÅ¾i igraÄa..." oninput="filterResults()">
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-title">ğŸ“‹ Rezultati</div>
        <div class="tbl-wrap">
            <table>
                <thead><tr><th>Rang</th><th>IgraÄ</th><th>Kviz</th><th>Datum</th><th>Zarada</th><th>Ocjena</th><th>ToÄnih</th></tr></thead>
                <tbody id="results-tbody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- â•â• QUESTIONS â•â• -->
<div id="section-questions" class="section">
    <div class="page-title hallock">â“ Baza Pitanja</div>

    <div class="card">
        <div class="card-title">â• Novo Pitanje</div>
        <form onsubmit="addQuestion(event)">
            <div class="form-group">
                <label class="form-label">Tekst Pitanja</label>
                <textarea class="form-input" id="q-text" required placeholder="Unesite pitanje..."></textarea>
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label class="form-label">Odgovor A</label>
                    <input type="text" class="form-input" id="q-a" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Odgovor B</label>
                    <input type="text" class="form-input" id="q-b" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Odgovor C</label>
                    <input type="text" class="form-input" id="q-c" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Odgovor D</label>
                    <input type="text" class="form-input" id="q-d" required>
                </div>
            </div>
            <div class="form-grid-3">
                <div class="form-group">
                    <label class="form-label">ToÄan Odgovor</label>
                    <select class="form-input" id="q-correct">
                        <option value="0">A â€” toÄan</option>
                        <option value="1">B â€” toÄan</option>
                        <option value="2">C â€” toÄan</option>
                        <option value="3">D â€” toÄan</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Kategorija</label>
                    <select class="form-input" id="q-cat">
                        <option>Sport</option><option>Geografija</option>
                        <option>Povijest</option><option>Filmovi</option>
                        <option>Muzika</option><option>Znanost</option>
                        <option>Umjetnost</option><option>Politika</option>
                        <option>Zabava</option><option>OpÄ‡enito</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">TeÅ¾ina</label>
                    <select class="form-input" id="q-diff">
                        <option value="easy">Lako</option>
                        <option value="medium">Srednje</option>
                        <option value="hard">TeÅ¡ko</option>
                    </select>
                </div>
            </div>
            <button type="submit" class="btn btn-green btn-full">ğŸ’¾ Spremi Pitanje</button>
        </form>
    </div>

    <div class="card">
        <div class="card-title">ğŸ“‹ Baza Pitanja</div>
        <div class="search-box">
            <input type="text" class="form-input" id="q-search" placeholder="ğŸ” TraÅ¾i pitanje..." oninput="filterQuestions()">
            <select class="form-input" style="width:160px;" id="q-cat-filter" onchange="filterQuestions()">
                <option value="">Sve kategorije</option>
                <option>Sport</option><option>Geografija</option>
                <option>Povijest</option><option>Filmovi</option>
                <option>Muzika</option><option>Znanost</option>
            </select>
            <select class="form-input" style="width:130px;" id="q-diff-filter" onchange="filterQuestions()">
                <option value="">Sve teÅ¾ine</option>
                <option value="easy">Lako</option>
                <option value="medium">Srednje</option>
                <option value="hard">TeÅ¡ko</option>
            </select>
        </div>
        <div id="questions-count" style="font-size:.78rem;color:#9ca3af;margin-bottom:8px;"></div>
        <div id="questions-list"></div>
    </div>
</div>

<!-- â•â• NOTIFICATIONS â•â• -->
<div id="section-notifications" class="section">
    <div class="page-title hallock">ğŸ”” Notifikacije</div>

    <!-- Send notification -->
    <div class="card">
        <div class="card-title">ğŸ“¨ PoÅ¡alji Notifikaciju</div>
        <div class="form-group">
            <label class="form-label">Prima</label>
            <select class="form-input" id="notif-target" onchange="togglePlayerSelect()">
                <option value="all">ğŸ“¢ Svi IgraÄi</option>
                <option value="player">ğŸ‘¤ SpecifiÄni IgraÄ</option>
            </select>
        </div>
        <div class="form-group" id="notif-player-group" style="display:none;">
            <label class="form-label">Odaberi IgraÄa</label>
            <select class="form-input" id="notif-player-id">
                <option value="">â€” odaberi â€”</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Poruka</label>
            <textarea class="form-input" id="notif-message" placeholder="Unesite poruku notifikacije..." rows="3"></textarea>
        </div>
        <div class="form-group">
            <label class="form-label">Tip</label>
            <select class="form-input" id="notif-type">
                <option value="info">â„¹ï¸ Informacija</option>
                <option value="warning">âš ï¸ Upozorenje</option>
                <option value="success">âœ… Uspjeh / Nagrada</option>
                <option value="quiz">ğŸ® Kviz Obavijest</option>
            </select>
        </div>
        <button onclick="sendNotification()" class="btn btn-brand btn-full">ğŸš€ PoÅ¡alji Notifikaciju</button>
    </div>

    <!-- Sent log -->
    <div class="card">
        <div class="card-title">ğŸ“‹ Poslane Notifikacije</div>
        <div id="notif-log"></div>
    </div>
</div>

<!-- â•â• NEWS â•â• -->
<div id="section-news" class="section">
    <div class="page-title hallock">ğŸ“° Novosti</div>

    <div class="card">
        <div class="card-title">â• Nova Objava</div>
        <form onsubmit="addNews(event)">
            <div class="form-group">
                <label class="form-label">Naslov</label>
                <input type="text" class="form-input" id="news-title" required>
            </div>
            <div class="form-group">
                <label class="form-label">SadrÅ¾aj</label>
                <textarea class="form-input" id="news-content" rows="5" required></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Kategorija</label>
                <select class="form-input" id="news-cat">
                    <option value="obavijest">ğŸ“¢ Obavijest</option>
                    <option value="novost">ğŸ“° Novost</option>
                    <option value="nagrada">ğŸ† Nagrada</option>
                    <option value="aÅ¾uriranje">ğŸ”§ AÅ¾uriranje</option>
                </select>
            </div>
            <button type="submit" class="btn btn-brand btn-full">ğŸ“° Objavi</button>
        </form>
    </div>

    <div class="card">
        <div class="card-title">ğŸ“‹ Objavljene Novosti</div>
        <div id="news-list"></div>
    </div>
</div>

<!-- â•â• SETTINGS â•â• -->
<div id="section-settings" class="section">
    <div class="page-title hallock">âš™ï¸ Postavke</div>

    <div class="card">
        <div class="card-title">ğŸ” Å ifra Pristupa Kvizu</div>
        <div class="form-group">
            <label class="form-label">Trenutna Å ifra</label>
            <input type="text" class="form-input" id="settings-password" placeholder="UÄitavam...">
        </div>
        <button onclick="savePassword()" class="btn btn-brand">ğŸ’¾ Spremi Å ifru</button>
    </div>

    <div class="card">
        <div class="card-title">â±ï¸ Trajanje Odgovora (sekunde)</div>
        <div class="form-group">
            <label class="form-label">Sekunde za odgovor</label>
            <input type="number" class="form-input" id="settings-timer" value="30" min="5" max="120" style="max-width:200px;">
        </div>
        <button onclick="saveTimer()" class="btn btn-brand">ğŸ’¾ Spremi Timer</button>
    </div>

    <div class="card">
        <div class="card-title">ğŸ§ª Trial Period</div>
        <div class="form-group">
            <label class="form-label">Trajanje triala (dani)</label>
            <input type="number" class="form-input" id="settings-trial-days" value="30" min="0" style="max-width:200px;">
        </div>
        <button onclick="saveTrial()" class="btn btn-brand">ğŸ’¾ Spremi</button>
    </div>
</div>

</div><!-- /main -->

<!-- â•â• PLAYER DETAIL MODAL â•â• -->
<div id="player-modal" class="modal-bg">
    <div class="modal-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:10px;border-bottom:3px solid var(--brand);">
            <div class="hallock" style="font-size:1.2rem;color:var(--brand);" id="modal-player-name">IgraÄ</div>
            <button onclick="closeModal()" style="background:none;border:none;font-size:1.3rem;cursor:pointer;color:#9ca3af;">âœ•</button>
        </div>
        <div id="modal-player-content"></div>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let allPlayers   = [];
let allQuestions = [];
let allQuizzes   = [];
let allResults   = [];
let currentRankMode = 'earnings';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onload = function() {
    loadOverview();
    loadAllPlayers();
    loadQuestions();
    loadScheduledQuizzes();
    loadResults();
    loadNews();
    loadNotifLog();
    loadSettings();
    generateRoundSettingsAdmin();
    // Build question UI after questions load (slight delay)
    setTimeout(buildQuestionUI, 1200);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function nav(section, el) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('section-' + section).classList.add('active');
    if (el) el.classList.add('active');
    else {
        document.querySelectorAll('.nav-item').forEach(n => {
            if (n.getAttribute('onclick') && n.getAttribute('onclick').includes("'" + section + "'")) n.classList.add('active');
        });
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OVERVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadOverview() {
    database.ref('playerProfiles').once('value').then(snap => {
        const players = snap.val() || {};
        const arr = Object.values(players);
        document.getElementById('ov-players').textContent = arr.length;
        const totalEarnings = arr.reduce((s, p) => s + (p.stats?.totalEarnings || 0), 0);
        document.getElementById('ov-earnings').textContent = totalEarnings + 'â‚¬';
        const totalGames = arr.reduce((s, p) => s + (p.stats?.totalGames || 0), 0);
        document.getElementById('ov-games').textContent = totalGames;

        // Recent players table
        const recent = Object.entries(players)
            .sort((a,b) => (b[1].createdAt||0) - (a[1].createdAt||0))
            .slice(0, 5);
        let html = '';
        recent.forEach(([id, p]) => {
            const dt = p.createdAt ? new Date(p.createdAt).toLocaleDateString('hr-HR') : 'â€”';
            html += `<tr>
                <td style="display:flex;align-items:center;gap:8px;">
                    ${p.profilePhoto ? `<img src="${p.profilePhoto}" style="width:28px;height:28px;border-radius:50%;">` : '<span style="font-size:1.2rem;">ğŸ‘¤</span>'}
                    <strong>${p.nickname || p.firstName || 'â€”'}</strong>
                </td>
                <td>${p.email || 'â€”'}</td>
                <td style="color:#10b981;font-weight:700;">${p.stats?.totalEarnings || 0}â‚¬</td>
                <td>${dt}</td>
                <td><button onclick="showPlayer('${id}')" class="btn btn-blue btn-sm">ğŸ‘ï¸</button></td>
            </tr>`;
        });
        document.getElementById('ov-recent-players').innerHTML = html;
    });

    database.ref('questionBank').once('value').then(snap => {
        document.getElementById('ov-questions').textContent = snap.exists() ? Object.keys(snap.val()).length : 0;
    });

    database.ref('scheduledQuizzes').once('value').then(snap => {
        document.getElementById('ov-quizzes').textContent = snap.exists() ? Object.keys(snap.val()).length : 0;
    });

    database.ref('news').once('value').then(snap => {
        document.getElementById('ov-news').textContent = snap.exists() ? Object.keys(snap.val()).length : 0;
    });

    // Count total notifications sent
    database.ref('adminNotifLog').once('value').then(snap => {
        document.getElementById('ov-notifs').textContent = snap.exists() ? Object.keys(snap.val()).length : 0;
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAYERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadAllPlayers() {
    database.ref('playerProfiles').on('value', snap => {
        const players = snap.val() || {};
        allPlayers = Object.entries(players).map(([id, d]) => ({id, ...d}));
        allPlayers.sort((a,b) => (b.createdAt||0) - (a.createdAt||0));
        renderPlayers(allPlayers);

        // Populate selects
        const sel = document.getElementById('notif-player-id');
        const dl  = document.getElementById('player-datalist');
        sel.innerHTML = '<option value="">â€” odaberi â€”</option>';
        dl.innerHTML  = '';
        allPlayers.forEach(p => {
            const name = p.nickname || p.firstName || p.id;
            sel.innerHTML += `<option value="${p.id}">${name}</option>`;
            dl.innerHTML  += `<option value="${p.id}">${name} (${p.email||''})</option>`;
        });

        // Rankings
        showRanking(currentRankMode);
        // Balances
        renderBalances(allPlayers);
    });
}

function renderPlayers(arr) {
    document.getElementById('players-count').textContent = arr.length + ' igraÄa';
    let html = '';
    arr.forEach((p, i) => {
        const dt = p.createdAt ? new Date(p.createdAt).toLocaleDateString('hr-HR') : 'â€”';
        const trialExpiry = p.createdAt ? p.createdAt + (30 * 86400000) : null;
        const inTrial = trialExpiry && Date.now() < trialExpiry;
        html += `<tr>
            <td style="color:#9ca3af;">${i+1}</td>
            <td style="display:flex;align-items:center;gap:8px;min-width:140px;">
                ${p.profilePhoto ? `<img src="${p.profilePhoto}" style="width:30px;height:30px;border-radius:50%;border:1.5px solid var(--brand-light);">` : '<span style="font-size:1.2rem;">ğŸ‘¤</span>'}
                <div>
                    <div style="font-weight:700;">${p.nickname || 'â€”'}</div>
                    <div style="font-size:.68rem;color:#9ca3af;">${p.firstName||''} ${p.lastName||''}</div>
                </div>
            </td>
            <td>${p.email || 'â€”'}</td>
            <td>${p.location || 'â€”'}</td>
            <td><strong>${p.wins || 0}</strong></td>
            <td style="color:#10b981;font-weight:700;">${p.stats?.totalEarnings || 0}â‚¬</td>
            <td>${(p.stats?.averageRating || 0).toFixed(1)}/10</td>
            <td>${p.stats?.totalGames || 0}</td>
            <td><span class="balance-pill">ğŸª™ ${p.stats?.tokenBalance || 0}</span></td>
            <td style="font-size:.78rem;">${dt}</td>
            <td>
                <button onclick="showPlayer('${p.id}')" class="btn btn-blue btn-sm" style="margin-right:3px;">ğŸ‘ï¸</button>
                <button onclick="deletePlayer('${p.id}')" class="btn btn-red btn-sm">ğŸ—‘ï¸</button>
            </td>
        </tr>`;
    });
    document.getElementById('players-tbody').innerHTML = html || '<tr><td colspan="11" style="text-align:center;color:#9ca3af;padding:20px;">Nema igraÄa</td></tr>';
}

function filterPlayers() {
    const q = document.getElementById('players-search').value.toLowerCase();
    const filtered = allPlayers.filter(p =>
        (p.nickname||'').toLowerCase().includes(q) ||
        (p.firstName||'').toLowerCase().includes(q) ||
        (p.lastName||'').toLowerCase().includes(q) ||
        (p.email||'').toLowerCase().includes(q)
    );
    renderPlayers(filtered);
}

function showPlayer(id) {
    const p = allPlayers.find(x => x.id === id);
    if (!p) return;
    const name = p.nickname || p.firstName || 'â€”';
    document.getElementById('modal-player-name').textContent = name;
    document.getElementById('modal-player-content').innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
            <div><span style="font-size:.7rem;color:#9ca3af;font-weight:700;">EMAIL</span><br><strong>${p.email||'â€”'}</strong></div>
            <div><span style="font-size:.7rem;color:#9ca3af;font-weight:700;">LOKACIJA</span><br><strong>${p.location||'â€”'}</strong></div>
            <div><span style="font-size:.7rem;color:#9ca3af;font-weight:700;">POBJEDE</span><br><strong style="color:var(--brand);font-family:'Metal Mania',cursive;font-size:1.2rem;">${p.wins||0}</strong></div>
            <div><span style="font-size:.7rem;color:#9ca3af;font-weight:700;">UKUPNA ZARADA</span><br><strong style="color:#10b981;font-family:'Metal Mania',cursive;font-size:1.2rem;">${p.stats?.totalEarnings||0}â‚¬</strong></div>
            <div><span style="font-size:.7rem;color:#9ca3af;font-weight:700;">OCJENA</span><br><strong style="color:#f59e0b;">${(p.stats?.averageRating||0).toFixed(2)}/10</strong></div>
            <div><span style="font-size:.7rem;color:#9ca3af;font-weight:700;">UKUPNO IGARA</span><br><strong>${p.stats?.totalGames||0}</strong></div>
            <div><span style="font-size:.7rem;color:#9ca3af;font-weight:700;">TOKEN SALDO</span><br><span class="balance-pill">ğŸª™ ${p.stats?.tokenBalance||0}</span></div>
            <div><span style="font-size:.7rem;color:#9ca3af;font-weight:700;">REGISTRIRAN</span><br><strong>${p.createdAt ? new Date(p.createdAt).toLocaleString('hr-HR') : 'â€”'}</strong></div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button onclick="sendNotifToPlayer('${p.id}', '${name}')" class="btn btn-blue btn-sm">ğŸ”” PoÅ¡alji Notifikaciju</button>
            <button onclick="adjustPlayerTokensModal('${p.id}', '${name}')" class="btn btn-green btn-sm">ğŸª™ Korigiraj Tokene</button>
            <button onclick="deletePlayer('${p.id}')" class="btn btn-red btn-sm">ğŸ—‘ï¸ ObriÅ¡i IgraÄa</button>
        </div>
    `;
    document.getElementById('player-modal').classList.add('open');
}

function closeModal() { document.getElementById('player-modal').classList.remove('open'); }
document.getElementById('player-modal').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); });

function deletePlayer(id) {
    if (!confirm('Obrisati igraÄa? Ova radnja je nepovratna!')) return;
    database.ref(`playerProfiles/${id}`).remove().then(() => alert('âœ… IgraÄ obrisan.'));
    closeModal();
}

function exportPlayersCSV() {
    let csv = 'Nadimak,Ime,Email,Lokacija,Pobjede,Zarada,Ocjena,Igre,Tokeni,Registriran\n';
    allPlayers.forEach(p => {
        csv += `"${p.nickname||''}","${p.firstName||''} ${p.lastName||''}","${p.email||''}","${p.location||''}",${p.wins||0},${p.stats?.totalEarnings||0},${(p.stats?.averageRating||0).toFixed(1)},${p.stats?.totalGames||0},${p.stats?.tokenBalance||0},"${p.createdAt ? new Date(p.createdAt).toLocaleDateString() : ''}"\n`;
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'lukavac-players-' + Date.now() + '.csv';
    a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RANKINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showRanking(mode, tabEl) {
    currentRankMode = mode;
    document.querySelectorAll('.rank-tab').forEach(t => t.classList.remove('active'));
    if (tabEl) tabEl.classList.add('active');

    const MODES = {
        earnings: { label: 'ğŸ’° Zarada',        val: p => p.stats?.totalEarnings||0,    fmt: v => v+'â‚¬',        color: '#10b981' },
        wins:     { label: 'ğŸ¥‡ Pobjede',        val: p => p.wins||0,                    fmt: v => v+' pobj.',   color: '#f59e0b' },
        rating:   { label: 'â­ Ocjena',          val: p => p.stats?.averageRating||0,    fmt: v => v.toFixed(2)+'/10', color: '#f59e0b' },
        games:    { label: 'ğŸ® Odigrane Igre',   val: p => p.stats?.totalGames||0,       fmt: v => v+' igara',   color: 'var(--brand)' },
        finals:   { label: 'ğŸ¯ Finala',          val: p => p.stats?.finals||p.finals||0, fmt: v => v+' fin.',    color: '#7c3aed' },
        cunning:  { label: 'ğŸ¦Š Osvojeno Lukavca', val: p => p.stats?.cunningWins||p.cunningWins||0, fmt: v => v+'Ã—', color: 'var(--brand)' },
        avg:      { label: 'ğŸ“ˆ Prosjek â‚¬ / Igra', val: p => {
                        const g = p.stats?.totalGames||0, e = p.stats?.totalEarnings||0;
                        return g > 0 ? Math.round(e/g) : 0;
                    }, fmt: v => v+'â‚¬', color: '#10b981' },
        tokens:   { label: 'ğŸª™ Token Saldo',     val: p => p.stats?.tokenBalance||0,    fmt: v => v+' tok.',    color: '#6366f1' }
    };

    const m = MODES[mode] || MODES.earnings;
    document.getElementById('ranking-table-title').textContent = 'ğŸ“‹ ' + m.label;
    document.getElementById('podium-title').textContent = 'ğŸ† Podij â€” ' + m.label;
    document.getElementById('rank-col-main').textContent = m.label;

    const sorted = [...allPlayers].sort((a,b) => m.val(b) - m.val(a));

    // Podium
    const top3 = sorted.slice(0,3);
    const podiumOrder = [top3[1], top3[0], top3[2]];
    const podiumClass = ['podium-2','podium-1','podium-3'];
    const medals = ['ğŸ¥ˆ','ğŸ¥‡','ğŸ¥‰'];
    let podiumHtml = '';
    podiumOrder.forEach((p, i) => {
        if (!p) return;
        podiumHtml += `
        <div class="podium-step ${podiumClass[i]}">
            <div class="podium-avatar">${p.profilePhoto ? `<img src="${p.profilePhoto}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">` : 'ğŸ‘¤'}</div>
            <div class="podium-name">${p.nickname || p.firstName || '?'}</div>
            <div class="podium-val">${m.fmt(m.val(p))}</div>
            <div class="podium-block">${medals[i]}</div>
        </div>`;
    });
    document.getElementById('podium').innerHTML = podiumHtml || '<p style="color:#9ca3af;text-align:center;padding:20px;">Nema podataka</p>';

    // Most active players
    const byGames = [...allPlayers].sort((a,b) => (b.stats?.totalGames||0) - (a.stats?.totalGames||0)).slice(0,10);
    let activeHtml = '';
    byGames.forEach((p,i) => {
        const medal = i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':''
        activeHtml += `<tr>
            <td><strong style="font-family:'Metal Mania',cursive;color:var(--brand);">${medal||'#'+(i+1)}</strong></td>
            <td style="display:flex;align-items:center;gap:7px;">
                ${p.profilePhoto?`<img src="${p.profilePhoto}" style="width:24px;height:24px;border-radius:50%;">`:'<span>ğŸ‘¤</span>'}
                <span style="font-weight:600;">${p.nickname||'â€”'}</span>
            </td>
            <td><strong style="color:var(--brand);">${p.stats?.totalGames||0}</strong></td>
            <td>${p.stats?.finals||p.finals||0}</td>
            <td style="color:#f59e0b;">${p.wins||0}</td>
            <td style="color:#10b981;">${p.stats?.totalEarnings||0}â‚¬</td>
            <td>â­ ${(p.stats?.averageRating||0).toFixed(1)}</td>
        </tr>`;
    });
    document.getElementById('most-active-tbody').innerHTML = activeHtml || '<tr><td colspan="7" style="color:#9ca3af;text-align:center;">Nema podataka</td></tr>';

    // Full table
    let tableHtml = '';
    sorted.forEach((p, i) => {
        const medal = i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':'';
        tableHtml += `<tr>
            <td><strong style="font-family:'Metal Mania',cursive;color:var(--brand);">${medal||'#'+(i+1)}</strong></td>
            <td style="display:flex;align-items:center;gap:7px;min-width:130px;">
                ${p.profilePhoto?`<img src="${p.profilePhoto}" style="width:24px;height:24px;border-radius:50%;">`:'<span>ğŸ‘¤</span>'}
                <span style="font-weight:600;">${p.nickname||p.firstName||'â€”'}</span>
            </td>
            <td><strong style="color:${m.color};">${m.fmt(m.val(p))}</strong></td>
            <td style="color:#10b981;">${p.stats?.totalEarnings||0}â‚¬</td>
            <td style="color:#f59e0b;">${p.wins||0}</td>
            <td>${p.stats?.totalGames||0}</td>
            <td>â­ ${(p.stats?.averageRating||0).toFixed(1)}</td>
            <td>${p.stats?.finals||p.finals||0}</td>
            <td style="color:#9ca3af;font-size:.8rem;">${p.location||'â€”'}</td>
        </tr>`;
    });
    document.getElementById('ranking-tbody').innerHTML = tableHtml || '<tr><td colspan="9" style="color:#9ca3af;text-align:center;padding:20px;">Nema igraÄa</td></tr>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BALANCES / TOKENS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBalances(arr) {
    const totalTokens = arr.reduce((s, p) => s + (p.stats?.tokenBalance||0), 0);
    const avgTokens   = arr.length > 0 ? Math.round(totalTokens / arr.length) : 0;
    document.getElementById('bal-total-tokens').textContent = totalTokens;
    document.getElementById('bal-avg-tokens').textContent   = avgTokens;

    let html = '';
    const sorted = [...arr].sort((a,b) => (b.stats?.tokenBalance||0) - (a.stats?.tokenBalance||0));
    sorted.forEach(p => {
        const trialExpiry = p.createdAt ? p.createdAt + (30 * 86400000) : null;
        const inTrial = trialExpiry && Date.now() < trialExpiry;
        const trialDays = trialExpiry ? Math.max(0, Math.ceil((trialExpiry - Date.now()) / 86400000)) : 0;
        html += `<tr>
            <td style="display:flex;align-items:center;gap:8px;">
                ${p.profilePhoto ? `<img src="${p.profilePhoto}" style="width:26px;height:26px;border-radius:50%;">` : '<span>ğŸ‘¤</span>'}
                <div>
                    <div style="font-weight:700;">${p.nickname||'â€”'}</div>
                    <div style="font-size:.65rem;color:#9ca3af;">${p.email||''}</div>
                </div>
            </td>
            <td><span class="balance-pill">ğŸª™ ${p.stats?.tokenBalance||0}</span></td>
            <td style="color:#10b981;font-weight:700;">${p.stats?.totalPaid||0}â‚¬</td>
            <td style="font-size:.78rem;">${p.lastTransaction ? new Date(p.lastTransaction).toLocaleDateString('hr-HR') : 'â€”'}</td>
            <td>${inTrial ? `<span class="badge badge-green">Trial (${trialDays}d)</span>` : '<span class="badge badge-gray">Istekao</span>'}</td>
            <td>
                <button onclick="quickAddTokens('${p.id}', '${p.nickname||p.firstName||''}', ${p.stats?.tokenBalance||0})" class="btn btn-green btn-sm">ğŸª™ Dodaj</button>
            </td>
        </tr>`;
    });
    document.getElementById('balances-tbody').innerHTML = html;
}

function filterBalances() {
    const q = document.getElementById('bal-search').value.toLowerCase();
    const filtered = allPlayers.filter(p =>
        (p.nickname||'').toLowerCase().includes(q) ||
        (p.email||'').toLowerCase().includes(q)
    );
    // re-render just the table rows
    let html = '';
    filtered.forEach(p => {
        const inTrial = p.createdAt && Date.now() < p.createdAt + 30*86400000;
        const trialDays = p.createdAt ? Math.max(0, Math.ceil((p.createdAt + 30*86400000 - Date.now()) / 86400000)) : 0;
        html += `<tr>
            <td>${p.nickname||'â€”'} <small style="color:#9ca3af;">${p.email||''}</small></td>
            <td><span class="balance-pill">ğŸª™ ${p.stats?.tokenBalance||0}</span></td>
            <td>${p.stats?.totalPaid||0}â‚¬</td>
            <td>${p.lastTransaction ? new Date(p.lastTransaction).toLocaleDateString('hr-HR') : 'â€”'}</td>
            <td>${inTrial ? `<span class="badge badge-green">Trial (${trialDays}d)</span>` : '<span class="badge badge-gray">Istekao</span>'}</td>
            <td><button onclick="quickAddTokens('${p.id}','${p.nickname||''}',${p.stats?.tokenBalance||0})" class="btn btn-green btn-sm">ğŸª™ Dodaj</button></td>
        </tr>`;
    });
    document.getElementById('balances-tbody').innerHTML = html;
}

function adjustTokens(direction) {
    const rawId  = document.getElementById('token-player-id').value.trim();
    const amount = parseInt(document.getElementById('token-amount').value);
    const reason = document.getElementById('token-reason').value.trim();
    if (!rawId || isNaN(amount) || amount <= 0) { alert('Unesi igraÄa i iznos!'); return; }

    // Find player by id or nickname
    let player = allPlayers.find(p => p.id === rawId || (p.nickname||'').toLowerCase() === rawId.toLowerCase());
    if (!player) { alert('IgraÄ nije pronaÄ‘en!'); return; }

    const delta = direction === 'add' ? amount : -amount;
    const newBalance = Math.max(0, (player.stats?.tokenBalance || 0) + delta);

    database.ref(`playerProfiles/${player.id}/stats/tokenBalance`).set(newBalance).then(() => {
        // Log the transaction
        database.ref(`playerProfiles/${player.id}/lastTransaction`).set(Date.now());
        database.ref('tokenTransactions').push({
            playerId: player.id,
            playerName: player.nickname || player.firstName,
            amount: delta,
            reason: reason || 'Admin korekcija',
            newBalance,
            timestamp: Date.now(),
            admin: 'admin'
        });
        alert(`âœ… Token saldo za ${player.nickname || player.firstName} je sada: ${newBalance}`);
        document.getElementById('token-player-id').value = '';
        document.getElementById('token-amount').value = '';
        document.getElementById('token-reason').value = '';
    });
}

function quickAddTokens(playerId, name, current) {
    const amt = parseInt(prompt(`Dodaj tokene za ${name}.\nTrenutni saldo: ${current}\n\nUnesite iznos (pozitivan za dodavanje, negativan za oduzimanje):`));
    if (isNaN(amt)) return;
    const newBal = Math.max(0, current + amt);
    database.ref(`playerProfiles/${playerId}/stats/tokenBalance`).set(newBal).then(() => {
        database.ref(`playerProfiles/${playerId}/lastTransaction`).set(Date.now());
        alert(`âœ… Novi saldo: ${newBal} tokena`);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTO-QUALIFICATION SYSTEM
//  Called when a quiz ends â€” players who reached finals get qualified for next level
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const QUAL_CHAIN = {
    sata:    'dana',
    dana:    'tjedna',
    tjedna:  'mjeseca',
    mjeseca: 'sezone'
};
const QUAL_NAMES = {
    dana:    'ğŸŒ™ Lukavac Dana',
    tjedna:  'ğŸ“… Lukavac Tjedna',
    mjeseca: 'ğŸ“† Lukavac Mjeseca',
    sezone:  'ğŸ† Lukavac Sezone'
};

// Call this after a quiz ends with the quiz data and list of finalist player IDs
// quizType = 'sata' | 'dana' | 'tjedna' | 'mjeseca'
// finalistIds = array of playerProfileId strings
function awardQualifications(quizId, quizType, finalistIds) {
    const nextLevel = QUAL_CHAIN[quizType];
    if (!nextLevel || !finalistIds?.length) return;
    const nextName = QUAL_NAMES[nextLevel] || nextLevel;

    finalistIds.forEach(playerId => {
        if (!playerId) return;
        // Set qualification flag
        database.ref(`playerProfiles/${playerId}/qualifications/${nextLevel}`).set(true);
        // Send notification to player's dashboard
        database.ref(`notifications/${playerId}`).push({
            message: `ğŸ† ÄŒestitamo! Plasirao si se u ${nextName}! Provjeri karticu Kvalifikacije na dashboardu.`,
            type:      'success',
            timestamp: Date.now(),
            read:      false,
            from:      'system',
            quizId
        });
    });

    // Log in quiz record
    database.ref(`scheduledQuizzes/${quizId}/finalists`).set(finalistIds);
    database.ref(`scheduledQuizzes/${quizId}/qualificationsAwarded`).set({ level: nextLevel, count: finalistIds.length, timestamp: Date.now() });
    alert(`âœ… Dodijeljene kvalifikacije za ${nextName} za ${finalistIds.length} igraÄa!`);
}

// Manual trigger from admin UI â€” picks finalist IDs from results
function triggerQualificationAward(quizId) {
    database.ref(`scheduledQuizzes/${quizId}`).once('value').then(snap => {
        const quiz = snap.val();
        if (!quiz) { alert('Kviz nije pronaÄ‘en!'); return; }
        const type = quiz.type || '';
        if (!QUAL_CHAIN[type]) { alert(`Kviz tipa "${type}" nema sljedeÄ‡u razinu kvalifikacije.`); return; }

        // Get finalists from registered players (top N who made it to finals)
        database.ref(`playerResults`).orderByChild('quizId').once('value').then(rs => {
            const results = rs.val() || {};
            const finalists = [];
            Object.entries(results).forEach(([playerId, playerResults]) => {
                Object.values(playerResults).forEach(r => {
                    if (r.quizId === quizId && r.reachedFinal) finalists.push(playerId);
                });
            });
            if (!finalists.length) {
                // Fallback: use registered players as finalists
                const reg = quiz.registeredPlayers || [];
                if (confirm(`Nema oznaÄenih finalista. Koristiti svih ${reg.length} prijavljenih igraÄa?`)) {
                    awardQualifications(quizId, type, reg);
                }
                return;
            }
            awardQualifications(quizId, type, finalists);
        });
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QUESTION BANK SELECTION FOR QUIZ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ALL_CATEGORIES = ['Sport','Geografija','Povijest','Filmovi','Muzika','Znanost','Umjetnost','Politika','Zabava','OpÄ‡enito'];

function buildQuestionUI() {
    // Build category checkboxes
    const catContainer = document.getElementById('qz-categories');
    if (!catContainer) return;
    const usedCats = [...new Set(allQuestions.map(q => q.category).filter(Boolean))];
    const cats = usedCats.length ? usedCats : ALL_CATEGORIES;
    catContainer.innerHTML = cats.map(c => `
        <label style="display:flex;align-items:center;gap:5px;background:white;border:1.5px solid var(--brand-light);border-radius:20px;padding:4px 10px;cursor:pointer;font-size:.78rem;font-weight:600;">
            <input type="checkbox" value="${c}" class="qz-cat-check" checked style="accent-color:var(--brand);">
            ${c}
        </label>`).join('');

    // Bank summary
    const total = allQuestions.length;
    const byDiff = {easy:0,medium:0,hard:0};
    const byCat  = {};
    allQuestions.forEach(q => {
        if (q.difficulty) byDiff[q.difficulty] = (byDiff[q.difficulty]||0) + 1;
        if (q.category)   byCat[q.category]    = (byCat[q.category]||0) + 1;
    });
    document.getElementById('qz-bank-summary').innerHTML =
        `<b>${total}</b> pitanja ukupno<br>` +
        `ğŸŸ¢ Lako: <b>${byDiff.easy}</b> &nbsp; ğŸŸ¡ Srednje: <b>${byDiff.medium}</b> &nbsp; ğŸ”´ TeÅ¡ko: <b>${byDiff.hard}</b>`;

    // Build per-round difficulty
    buildRoundDifficultyUI();
}

function buildRoundDifficultyUI() {
    const n = parseInt(document.getElementById('qz-num-rounds')?.value) || 6;
    const container = document.getElementById('qz-question-difficulty');
    if (!container) return;
    let html = '';
    for (let i = 0; i < n; i++) {
        html += `
        <div style="background:var(--brand-pale);border:1px solid var(--brand-light);border-radius:10px;padding:12px;margin-bottom:8px;">
            <div style="font-weight:700;font-size:.82rem;color:var(--brand);margin-bottom:8px;">Krug ${i+1}</div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
                <div>
                    <label class="form-label">ğŸŸ¢ Lako</label>
                    <div style="display:flex;gap:4px;">
                        <input type="number" class="form-input" id="qdiff${i}_easy" value="${i<2?70:i<4?40:20}" min="0" style="flex:2;">
                        <select class="form-input" id="qdiff${i}_easy_type" style="flex:1;">
                            <option value="percent">%</option>
                            <option value="number">br.</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="form-label">ğŸŸ¡ Srednje</label>
                    <div style="display:flex;gap:4px;">
                        <input type="number" class="form-input" id="qdiff${i}_medium" value="${i<2?20:i<4?40:30}" min="0" style="flex:2;">
                        <select class="form-input" id="qdiff${i}_medium_type" style="flex:1;">
                            <option value="percent">%</option>
                            <option value="number">br.</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="form-label">ğŸ”´ TeÅ¡ko</label>
                    <div style="display:flex;gap:4px;">
                        <input type="number" class="form-input" id="qdiff${i}_hard" value="${i<2?10:i<4?20:50}" min="0" style="flex:2;">
                        <select class="form-input" id="qdiff${i}_hard_type" style="flex:1;">
                            <option value="percent">%</option>
                            <option value="number">br.</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>`;
    }
    container.innerHTML = html;
}

function getSelectedCategories() {
    return [...document.querySelectorAll('.qz-cat-check:checked')].map(c => c.value);
}

function selectQuestionsForRound(roundIdx, count) {
    const cats     = getSelectedCategories();
    const maxRepeat = parseInt(document.getElementById('qz-max-repeat')?.value) || 20;
    const repeatType = document.getElementById('qz-max-repeat-type')?.value || 'percent';

    // Filtered pool
    let pool = allQuestions.filter(q =>
        (!cats.length || cats.includes(q.category))
    );

    // Split by difficulty
    const easyVal   = parseInt(document.getElementById(`qdiff${roundIdx}_easy`)?.value)   || 0;
    const medVal    = parseInt(document.getElementById(`qdiff${roundIdx}_medium`)?.value)  || 0;
    const hardVal   = parseInt(document.getElementById(`qdiff${roundIdx}_hard`)?.value)    || 0;
    const easyType  = document.getElementById(`qdiff${roundIdx}_easy_type`)?.value  || 'percent';
    const medType   = document.getElementById(`qdiff${roundIdx}_medium_type`)?.value || 'percent';
    const hardType  = document.getElementById(`qdiff${roundIdx}_hard_type`)?.value  || 'percent';

    const countForDiff = (val, type, total) => type === 'percent' ? Math.round(total * val / 100) : val;
    const easyCount  = countForDiff(easyVal, easyType, count);
    const medCount   = countForDiff(medVal, medType, count);
    const hardCount  = countForDiff(hardVal, hardType, count);

    // Max repeats
    const maxRepeatCount = repeatType === 'percent' ? Math.round(count * maxRepeat / 100) : maxRepeat;

    function pickFrom(arr, n) {
        const shuffled = [...arr].sort(() => Math.random() - .5);
        const fresh   = shuffled.filter(q => !q.timesUsed || q.timesUsed === 0);
        const used    = shuffled.filter(q => q.timesUsed > 0);
        const result  = [];
        let usedPicked = 0;
        for (const q of fresh) { if (result.length >= n) break; result.push(q); }
        for (const q of used)  { if (result.length >= n) break; if (usedPicked >= maxRepeatCount) break; result.push(q); usedPicked++; }
        return result;
    }

    const easyPool  = pool.filter(q => q.difficulty === 'easy');
    const medPool   = pool.filter(q => q.difficulty === 'medium');
    const hardPool  = pool.filter(q => q.difficulty === 'hard');
    const remaining = pool; // fallback

    let selected = [
        ...pickFrom(easyPool, easyCount),
        ...pickFrom(medPool, medCount),
        ...pickFrom(hardPool, hardCount)
    ];

    // Fill remaining if not enough
    if (selected.length < count) {
        const usedIds = new Set(selected.map(q => q.id));
        const extra = pickFrom(remaining.filter(q => !usedIds.has(q.id)), count - selected.length);
        selected = [...selected, ...extra];
    }

    return selected.slice(0, count);
}

function previewQuestionSelection() {
    const n = parseInt(document.getElementById('qz-num-rounds')?.value) || 6;
    let html = '';
    let totalSelected = 0;

    for (let i = 0; i < n; i++) {
        const count = parseInt(document.getElementById(`r${i}_questions`)?.value) || 5;
        const qs = selectQuestionsForRound(i, count);
        totalSelected += qs.length;
        const byDiff = {easy:0,medium:0,hard:0};
        qs.forEach(q => { if(q.difficulty) byDiff[q.difficulty]++; });

        html += `
        <div style="background:var(--brand-pale);border:1px solid var(--brand-light);border-radius:10px;padding:10px 12px;margin-bottom:8px;">
            <div style="font-weight:700;font-size:.85rem;color:var(--brand);margin-bottom:4px;">
                Krug ${i+1} â€” ${qs.length}/${count} pitanja
                <span style="font-weight:400;font-size:.75rem;color:#6b7280;margin-left:8px;">
                    ğŸŸ¢ ${byDiff.easy} &nbsp; ğŸŸ¡ ${byDiff.medium} &nbsp; ğŸ”´ ${byDiff.hard}
                </span>
            </div>
            ${qs.length < count ? `<div style="color:#ef4444;font-size:.75rem;font-weight:700;">âš ï¸ Nedovoljno pitanja u bazi! Nedostaje ${count - qs.length}</div>` : ''}
            <div style="font-size:.72rem;color:#6b7280;">
                ${qs.map(q => `<span style="display:inline-block;background:white;border:1px solid #e5e7eb;border-radius:6px;padding:2px 7px;margin:2px;">${(q.text||'').slice(0,40)}${q.text?.length>40?'â€¦':''}</span>`).join('')}
            </div>
        </div>`;
    }

    html = `<div style="font-size:.8rem;font-weight:700;color:#6b7280;margin-bottom:8px;">Ukupno odabrano: ${totalSelected} pitanja</div>` + html;
    document.getElementById('qz-preview-content').innerHTML = html;
    document.getElementById('qz-question-preview').style.display = 'block';
}

function getQuestionSelectionConfig() {
    const n = parseInt(document.getElementById('qz-num-rounds')?.value) || 6;
    const cats = getSelectedCategories();
    const rounds = [];
    for (let i = 0; i < n; i++) {
        rounds.push({
            easy:   { val: parseInt(document.getElementById(`qdiff${i}_easy`)?.value)||0,   type: document.getElementById(`qdiff${i}_easy_type`)?.value||'percent' },
            medium: { val: parseInt(document.getElementById(`qdiff${i}_medium`)?.value)||0, type: document.getElementById(`qdiff${i}_medium_type`)?.value||'percent' },
            hard:   { val: parseInt(document.getElementById(`qdiff${i}_hard`)?.value)||0,   type: document.getElementById(`qdiff${i}_hard_type`)?.value||'percent' }
        });
    }
    return {
        categories:    cats,
        maxRepeat:     parseInt(document.getElementById('qz-max-repeat')?.value)||20,
        maxRepeatType: document.getElementById('qz-max-repeat-type')?.value||'percent',
        rounds
    };
}
const DEFAULT_ROUND = {
    questions: 5, remainingType: 'percent', remainingValue: 50,
    time1: 10, time2: 10, timeAnswer: 30, timePause: 5,
    skipCunning: false, earlyContinue: false, autoKickPlayers: true, autoNextRound: true,
    values: [200, 100, -50, -100, -200]
};

function generateRoundSettingsAdmin() {
    const n = parseInt(document.getElementById('qz-num-rounds').value) || 6;
    let html = '';
    for (let i = 0; i < n; i++) {
        const r = DEFAULT_ROUND;
        html += `
        <div style="background:var(--brand-pale);border:1.5px solid var(--brand-light);border-radius:12px;padding:14px;margin-bottom:10px;">
            <div style="font-family:'Metal Mania',cursive;font-size:.95rem;color:var(--brand);margin-bottom:10px;padding-bottom:6px;border-bottom:2px solid var(--brand);">
                Krug ${i+1}
            </div>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:10px;">
                <div class="form-group">
                    <label class="form-label">Pitanja</label>
                    <input type="number" class="form-input" id="r${i}_questions" value="${r.questions}" min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Preostalo igraÄa</label>
                    <div style="display:flex;gap:4px;">
                        <input type="number" class="form-input" id="r${i}_remaining" value="${r.remainingValue}" style="flex:2;">
                        <select class="form-input" id="r${i}_remainingType" style="flex:1;">
                            <option value="percent">%</option>
                            <option value="number">br.</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Timer odg. (s)</label>
                    <input type="number" class="form-input" id="r${i}_timeAnswer" value="${r.timeAnswer}" min="5">
                </div>
                <div class="form-group">
                    <label class="form-label">Timer pauza (s)</label>
                    <input type="number" class="form-input" id="r${i}_timePause" value="${r.timePause}" min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Timer 1 (s)</label>
                    <input type="number" class="form-input" id="r${i}_time1" value="${r.time1}" min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Timer 2 (s)</label>
                    <input type="number" class="form-input" id="r${i}_time2" value="${r.time2}" min="1">
                </div>
            </div>
            <div style="margin-bottom:10px;">
                <div class="form-label" style="margin-bottom:6px;">Bodovi (Sigurno+, Sigurno-, RiziÄno+, RiziÄno-, Lukavac-)</div>
                <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px;">
                    ${['+!','+.','-.','-?','-!'].map((lbl,j) => `<div>
                        <small style="color:#9ca3af;font-size:.65rem;">${lbl}</small>
                        <input type="number" class="form-input" id="r${i}_val${j}" value="${r.values[j]}">
                    </div>`).join('')}
                </div>
            </div>
            <div style="display:flex;gap:20px;flex-wrap:wrap;">
                <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:.82rem;">
                    <input type="checkbox" id="r${i}_autoSkip" style="accent-color:var(--brand);">
                    <span>PreskoÄi Lukavac fazu</span>
                </label>
                <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:.82rem;">
                    <input type="checkbox" id="r${i}_autoContinue" checked style="accent-color:var(--brand);">
                    <span>Auto-nastavi</span>
                </label>
                <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:.82rem;">
                    <input type="checkbox" id="r${i}_autoKick" checked style="accent-color:var(--brand);">
                    <span>Auto-izbaci igraÄe</span>
                </label>
                <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:.82rem;">
                    <input type="checkbox" id="r${i}_autoNextRound" checked style="accent-color:var(--brand);">
                    <span>Auto-sljedeÄ‡i krug</span>
                </label>
            </div>
        </div>`;
    }
    document.getElementById('qz-round-settings').innerHTML = html;
    buildRoundDifficultyUI();
}

function addQuiz() {
    const numRounds = parseInt(document.getElementById('qz-num-rounds').value) || 6;
    const rounds = [];
    let totalQuestions = 0;

    for (let i = 0; i < numRounds; i++) {
        const q = parseInt(document.getElementById(`r${i}_questions`)?.value) || 5;
        totalQuestions += q;
        rounds.push({
            questions:      q,
            remainingType:  document.getElementById(`r${i}_remainingType`)?.value || 'percent',
            remainingValue: parseInt(document.getElementById(`r${i}_remaining`)?.value) || 50,
            remainingPlayers: parseInt(document.getElementById(`r${i}_remaining`)?.value) || 50,
            playersRemaining: parseInt(document.getElementById(`r${i}_remaining`)?.value) || 50,
            time1:          parseInt(document.getElementById(`r${i}_time1`)?.value) || 10,
            time2:          parseInt(document.getElementById(`r${i}_time2`)?.value) || 10,
            timeAnswer:     parseInt(document.getElementById(`r${i}_timeAnswer`)?.value) || 30,
            timePause:      parseInt(document.getElementById(`r${i}_timePause`)?.value) || 5,
            skipCunning:    document.getElementById(`r${i}_autoSkip`)?.checked || false,
            earlyContinue:  document.getElementById(`r${i}_autoContinue`)?.checked || true,
            autoKickPlayers: document.getElementById(`r${i}_autoKick`)?.checked || true,
            autoNextRound:  document.getElementById(`r${i}_autoNextRound`)?.checked || true,
            pauseRound:     'auto',
            value1:         parseInt(document.getElementById(`r${i}_val0`)?.value) || 200,
            values: [0,1,2,3,4].map(j => parseInt(document.getElementById(`r${i}_val${j}`)?.value) || [200,100,-50,-100,-200][j])
        });
    }

    const nameSuffix = document.getElementById('qz-name').value || 'DANA';
    const startTime  = new Date(document.getElementById('qz-start').value).getTime();

    if (!document.getElementById('qz-start').value) { alert('Unesite datum i vrijeme!'); return; }

    const quizData = {
        name:          `CUNNING ${nameSuffix}`,
        nameSuffix,
        type:          document.getElementById('qz-type').value,
        startTime,
        prizePool:     parseInt(document.getElementById('qz-prize').value) || 0,
        tokenCost:     parseInt(document.getElementById('qz-token-cost').value) || 500,
        minPlayers:    parseInt(document.getElementById('qz-min-players').value) || 2,
        maxPlayers:    parseInt(document.getElementById('qz-max-players').value) || 8,
        questionCount: totalQuestions,
        numRounds,
        description:   document.getElementById('qz-desc').value,
        questionSelection: getQuestionSelectionConfig(),
        status:        'scheduled',
        playerCount:   0,
        createdAt:     Date.now(),
        // Embed full settings
        settings: {
            quizNameSuffix:   nameSuffix,
            password:         document.getElementById('qz-password').value || '1234',
            minPlayers:       parseInt(document.getElementById('qz-min-players').value) || 2,
            maxPlayers:       parseInt(document.getElementById('qz-max-players').value) || 8,
            numRounds,
            roundEndTimer:    parseInt(document.getElementById('qz-round-end-timer').value) || 10,
            noviKrugTimer:    parseInt(document.getElementById('qz-novi-krug-timer').value) || 5,
            showHeaderBar:    document.getElementById('qz-show-header').checked,
            leaderboardPosition: document.getElementById('qz-leaderboard-pos').value,
            rounds
        }
    };

    const saves = [database.ref('scheduledQuizzes').push(quizData)];

    // Optionally also write to global settings (for admin.html live control)
    if (document.getElementById('qz-save-to-settings').checked) {
        saves.push(database.ref('settings').set(quizData.settings));
    }

    Promise.all(saves).then(() => {
        alert('âœ… Kviz zakazan' + (document.getElementById('qz-save-to-settings').checked ? ' i postavke aÅ¾urirane!' : '!'));
        loadScheduledQuizzes();
        nav('scheduled', null);
    }).catch(e => alert('âŒ GreÅ¡ka: ' + e.message));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCHEDULED QUIZZES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadScheduledQuizzes() {
    database.ref('scheduledQuizzes').on('value', snap => {
        allQuizzes = [];
        const quizzes = snap.val() || {};
        const el = document.getElementById('scheduled-list');
        const resSelect = document.getElementById('res-filter-quiz');
        resSelect.innerHTML = '<option value="">Svi Kvizovi</option>';

        if (!Object.keys(quizzes).length) {
            el.innerHTML = '<div class="card" style="text-align:center;color:#9ca3af;">Nema zakazanih kvizova</div>';
            return;
        }

        const arr = Object.entries(quizzes).sort((a,b) => b[1].startTime - a[1].startTime);
        let html = '';
        arr.forEach(([id, q]) => {
            allQuizzes.push({id, ...q});
            const dt = new Date(q.startTime).toLocaleString('hr-HR');
            const now = Date.now();
            const statusBadge = q.status === 'live'
                ? '<span class="badge badge-red">ğŸ”´ UÅ½IVO</span>'
                : q.startTime > now
                ? '<span class="badge badge-yellow">ğŸ“… Zakazano</span>'
                : '<span class="badge badge-gray">âœ“ ZavrÅ¡eno</span>';

            resSelect.innerHTML += `<option value="${id}">${q.name}</option>`;

            html += `
            <div class="quiz-card">
                <div class="quiz-card-title">${q.name} ${statusBadge}</div>
                <div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:10px;">
                    <span style="font-size:.82rem;color:var(--brand-dark);">ğŸ• ${dt}</span>
                    <span style="font-size:.82rem;color:#10b981;font-weight:700;">ğŸ’° ${q.prizePool||0}â‚¬</span>
                    <span style="font-size:.82rem;color:var(--brand-dark);">â“ ${q.questionCount||0} pitanja</span>
                    <span style="font-size:.82rem;color:var(--brand-dark);">ğŸ‘¥ ${q.playerCount||0}/${q.maxPlayers||'âˆ'} igraÄa</span>
                    <span style="font-size:.82rem;color:var(--brand);">ğŸª™ ${q.tokenCost||0} tokena</span>
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    <a href="admin.html?quiz=${id}" class="btn btn-red btn-sm">ğŸ”´ Pokreni UÅ¾ivo</a>
                    <button onclick="editQuizTokens('${id}', ${q.tokenCost||500})" class="btn btn-brand btn-sm">ğŸª™ Tokeni</button>
                    ${QUAL_CHAIN[q.type] ? `<button onclick="triggerQualificationAward('${id}')" class="btn btn-green btn-sm">ğŸ† Dodijeli Kvalifikacije</button>` : ''}
                    <button onclick="deleteQuiz('${id}')" class="btn btn-red btn-sm" style="background:transparent;border:1.5px solid #ef4444;color:#ef4444;box-shadow:none;">ğŸ—‘ï¸ ObriÅ¡i</button>
                </div>
            </div>`;
        });
        el.innerHTML = html;
    });
}

function editQuizTokens(qid, current) {
    const val = parseInt(prompt(`Cijena ulaza u tokenima za ovaj kviz:\nTrenutno: ${current} tokena`, current));
    if (isNaN(val) || val < 0) return;
    database.ref(`scheduledQuizzes/${qid}/tokenCost`).set(val).then(() => alert('âœ… AÅ¾urirano!'));
}

function deleteQuiz(id) {
    if (!confirm('Obrisati kviz?')) return;
    database.ref(`scheduledQuizzes/${id}`).remove();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadResults() {
    database.ref('playerResults').once('value').then(snap => {
        allResults = [];
        const data = snap.val() || {};
        Object.entries(data).forEach(([playerId, results]) => {
            Object.entries(results).forEach(([rId, r]) => {
                allResults.push({playerId, rId, ...r});
            });
        });
        allResults.sort((a,b) => (b.timestamp||0) - (a.timestamp||0));
        renderResults(allResults);
    });
}

function filterResults() {
    const q     = document.getElementById('res-filter-player').value.toLowerCase();
    const qzId  = document.getElementById('res-filter-quiz').value;
    const filtered = allResults.filter(r =>
        (!qzId || r.quizId === qzId) &&
        (!q || (r.playerName||'').toLowerCase().includes(q))
    );
    renderResults(filtered);
}

function renderResults(arr) {
    let html = '';
    arr.slice(0, 100).forEach(r => {
        const dt   = r.timestamp ? new Date(r.timestamp).toLocaleDateString('hr-HR') : 'â€”';
        const medal = r.rank===1?'ğŸ¥‡':r.rank===2?'ğŸ¥ˆ':r.rank===3?'ğŸ¥‰':'';
        html += `<tr>
            <td><strong style="color:var(--brand);font-family:'Metal Mania',cursive;">${medal} #${r.rank||'â€”'}</strong></td>
            <td>${r.playerName || r.playerId || 'â€”'}</td>
            <td>${r.quizName || 'â€”'}</td>
            <td>${dt}</td>
            <td style="color:#10b981;font-weight:700;">${r.earnings||0}â‚¬</td>
            <td>â­ ${(r.rating||0).toFixed(1)}/10</td>
            <td>${r.correctAnswers||'â€”'} / ${r.totalQuestions||'â€”'}</td>
        </tr>`;
    });
    document.getElementById('results-tbody').innerHTML = html || '<tr><td colspan="7" style="text-align:center;color:#9ca3af;padding:20px;">Nema rezultata</td></tr>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QUESTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addQuestion(e) {
    e.preventDefault();
    const qId = database.ref('questionBank').push().key;
    database.ref(`questionBank/${qId}`).set({
        text:       document.getElementById('q-text').value,
        answers:    [
            document.getElementById('q-a').value,
            document.getElementById('q-b').value,
            document.getElementById('q-c').value,
            document.getElementById('q-d').value
        ],
        correct:    parseInt(document.getElementById('q-correct').value),
        category:   document.getElementById('q-cat').value,
        difficulty: document.getElementById('q-diff').value,
        timesUsed:  0,
        createdAt:  Date.now(),
        createdBy:  'admin'
    }).then(() => {
        alert('âœ… Pitanje dodano!');
        e.target.reset();
    });
}

function loadQuestions() {
    database.ref('questionBank').on('value', snap => {
        const q = snap.val() || {};
        allQuestions = Object.entries(q).map(([id, d]) => ({id, ...d}));
        filterQuestions();
    });
}

function filterQuestions() {
    const search  = (document.getElementById('q-search')?.value || '').toLowerCase();
    const cat     = document.getElementById('q-cat-filter')?.value || '';
    const diff    = document.getElementById('q-diff-filter')?.value || '';
    const filtered = allQuestions.filter(q =>
        (q.text||'').toLowerCase().includes(search) &&
        (!cat || q.category === cat) &&
        (!diff || q.difficulty === diff)
    );
    document.getElementById('questions-count').textContent = filtered.length + ' pitanja';
    let html = '';
    filtered.forEach(q => {
        const diffBadge = q.difficulty === 'easy' ? 'badge-green' : q.difficulty === 'medium' ? 'badge-yellow' : 'badge-red';
        html += `
        <div style="background:var(--brand-pale);border:1px solid var(--brand-light);border-radius:12px;padding:11px 14px;margin-bottom:7px;display:flex;justify-content:space-between;align-items:flex-start;gap:10px;">
            <div style="flex:1;min-width:0;">
                <div style="font-weight:700;font-size:.88rem;margin-bottom:4px;">${q.text}</div>
                <div style="font-size:.72rem;color:#6b7280;">
                    ${q.answers?.map((a,i) => `<span style="${i===q.correct?'color:#10b981;font-weight:700;':''}">${['A','B','C','D'][i]}: ${a}</span>`).join(' &nbsp;|&nbsp; ')||''}
                </div>
                <div style="margin-top:4px;display:flex;gap:6px;flex-wrap:wrap;">
                    <span class="badge ${diffBadge}">${q.difficulty}</span>
                    <span class="badge badge-blue">${q.category||'â€”'}</span>
                    <span style="font-size:.65rem;color:#9ca3af;">KoriÅ¡teno: ${q.timesUsed||0}x</span>
                </div>
            </div>
            <button onclick="deleteQuestion('${q.id}')" class="btn btn-red btn-sm">ğŸ—‘ï¸</button>
        </div>`;
    });
    document.getElementById('questions-list').innerHTML = html || '<p style="color:#9ca3af;text-align:center;padding:16px;">Nema pitanja</p>';
}

function deleteQuestion(id) {
    if (!confirm('Obrisati pitanje?')) return;
    database.ref(`questionBank/${id}`).remove();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NOTIFICATIONS  â† KLJUÄŒNI ISPRAVAK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function togglePlayerSelect() {
    const t = document.getElementById('notif-target').value;
    document.getElementById('notif-player-group').style.display = t === 'player' ? 'block' : 'none';
}

function sendNotification() {
    const target  = document.getElementById('notif-target').value;
    const message = document.getElementById('notif-message').value.trim();
    const type    = document.getElementById('notif-type').value;

    if (!message) { alert('Unesite poruku!'); return; }

    const notifData = {
        message,
        type,
        timestamp:  Date.now(),
        read:       false,
        from:       'admin'
    };

    if (target === 'all') {
        // Å alje svim igraÄima na notifications/{playerId}
        const promises = allPlayers.map(p =>
            database.ref(`notifications/${p.id}`).push(notifData)
        );
        Promise.all(promises).then(() => {
            // Log
            database.ref('adminNotifLog').push({
                ...notifData, target: 'all', recipientCount: allPlayers.length
            });
            alert(`âœ… Notifikacija poslana svim igraÄima (${allPlayers.length})!`);
            document.getElementById('notif-message').value = '';
            loadNotifLog();
        });
    } else {
        const playerId = document.getElementById('notif-player-id').value;
        if (!playerId) { alert('Odaberite igraÄa!'); return; }
        database.ref(`notifications/${playerId}`).push(notifData).then(() => {
            database.ref('adminNotifLog').push({
                ...notifData, target: 'player', playerId
            });
            alert('âœ… Notifikacija poslana!');
            document.getElementById('notif-message').value = '';
            loadNotifLog();
        });
    }
}

function sendNotifToPlayer(playerId, name) {
    closeModal();
    nav('notifications', null);
    document.getElementById('notif-target').value = 'player';
    togglePlayerSelect();
    document.getElementById('notif-player-id').value = playerId;
    document.getElementById('notif-message').focus();
}

function loadNotifLog() {
    database.ref('adminNotifLog').orderByChild('timestamp').limitToLast(30).once('value').then(snap => {
        const log = snap.val() || {};
        const arr = Object.entries(log).sort((a,b) => b[1].timestamp - a[1].timestamp);
        let html = '';
        arr.forEach(([id, n]) => {
            const dt = new Date(n.timestamp).toLocaleString('hr-HR');
            const typeIcon = {info:'â„¹ï¸', warning:'âš ï¸', success:'âœ…', quiz:'ğŸ®'}[n.type] || 'ğŸ””';
            const targetLabel = n.target === 'all'
                ? `<span class="badge badge-blue">ğŸ“¢ Svi (${n.recipientCount||0})</span>`
                : `<span class="badge badge-yellow">ğŸ‘¤ IgraÄ</span>`;
            html += `
            <div class="notif-card sent">
                <div style="flex:1;">
                    <div style="font-weight:700;font-size:.88rem;">${typeIcon} ${n.message}</div>
                    <div style="font-size:.68rem;color:#9ca3af;margin-top:3px;">${dt} Â· ${targetLabel}</div>
                </div>
                <button onclick="deleteNotifLog('${id}')" class="btn btn-red btn-sm">ğŸ—‘ï¸</button>
            </div>`;
        });
        document.getElementById('notif-log').innerHTML = html || '<p style="color:#9ca3af;text-align:center;padding:14px;">Nema poslanih notifikacija</p>';
    });
}

function deleteNotifLog(id) {
    database.ref(`adminNotifLog/${id}`).remove().then(() => loadNotifLog());
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NEWS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addNews(e) {
    e.preventDefault();
    database.ref('news').push({
        title:     document.getElementById('news-title').value,
        content:   document.getElementById('news-content').value,
        category:  document.getElementById('news-cat').value,
        timestamp: Date.now()
    }).then(() => {
        alert('âœ… Novost objavljena!');
        e.target.reset();
        loadNews();
    });
}

function loadNews() {
    database.ref('news').orderByChild('timestamp').limitToLast(20).on('value', snap => {
        const news = snap.val() || {};
        const arr = Object.entries(news).sort((a,b) => b[1].timestamp - a[1].timestamp);
        let html = '';
        arr.forEach(([id, n]) => {
            const dt = new Date(n.timestamp).toLocaleString('hr-HR');
            html += `
            <div style="background:var(--brand-pale);border:1px solid var(--brand-light);border-radius:12px;padding:12px 14px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:flex-start;gap:10px;">
                <div style="flex:1;">
                    <div style="font-family:'Metal Mania',cursive;font-size:.95rem;color:var(--brand);margin-bottom:3px;">${n.title}</div>
                    <div style="font-size:.72rem;color:#9ca3af;margin-bottom:5px;">${dt} Â· ${n.category||''}</div>
                    <div style="font-size:.82rem;">${(n.content||'').slice(0,200)}${n.content?.length > 200 ? '...' : ''}</div>
                </div>
                <button onclick="deleteNews('${id}')" class="btn btn-red btn-sm">ğŸ—‘ï¸</button>
            </div>`;
        });
        const el = document.getElementById('news-list');
        if (el) el.innerHTML = html || '<p style="color:#9ca3af;text-align:center;padding:14px;">Nema novosti</p>';
    });
}

function deleteNews(id) {
    if (!confirm('Obrisati novost?')) return;
    database.ref(`news/${id}`).remove();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadSettings() {
    database.ref('settings').once('value').then(snap => {
        const s = snap.val() || {};
        if (document.getElementById('settings-password')) document.getElementById('settings-password').value = s.password || '';
        if (document.getElementById('settings-timer'))    document.getElementById('settings-timer').value    = s.answerTimer || 30;
        if (document.getElementById('settings-trial-days')) document.getElementById('settings-trial-days').value = s.trialDays || 30;
    });
}

function savePassword() {
    const pw = document.getElementById('settings-password').value.trim();
    if (!pw) { alert('Unesite Å¡ifru!'); return; }
    database.ref('settings/password').set(pw).then(() => alert('âœ… Å ifra aÅ¾urirana!'));
}

function saveTimer() {
    const t = parseInt(document.getElementById('settings-timer').value);
    if (isNaN(t)) return;
    database.ref('settings/answerTimer').set(t).then(() => alert('âœ… Timer aÅ¾uriran!'));
}

function saveTrial() {
    const d = parseInt(document.getElementById('settings-trial-days').value);
    if (isNaN(d)) return;
    database.ref('settings/trialDays').set(d).then(() => alert('âœ… Trial period aÅ¾uriran!'));
}
</script>
</body>
</html>
