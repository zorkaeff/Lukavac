<!DOCTYPE html>
<!-- INTEGRATED QUIZ BUILDER v2 - 2026-01-27 -->
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <title>Quiz Builder</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: Arial; background: #f5f5f5; }
        .header { background: #1f2937; color: white; padding: 20px; }
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        input, select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 10px; }
        .round-box { border: 3px solid #3b82f6; border-radius: 12px; padding: 20px; margin-bottom: 20px; background: #eff6ff; }
        .q-item { border: 2px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 8px; cursor: pointer; background: white; }
        .q-item:hover { border-color: #3b82f6; background: #f0f9ff; }
        .q-item.selected { border-color: #10b981; background: #d1fae5; }
        .step { display: none; }
        .step.active { display: block; }
        .diff-1 { background: #d1fae5; color: #065f46; padding: 2px 8px; border-radius: 4px; }
        .diff-2 { background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 4px; }
        .diff-3 { background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 4px; }
        .diff-4 { background: #fed7aa; color: #9a3412; padding: 2px 8px; border-radius: 4px; }
        .diff-5 { background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold">üéÆ Quiz Builder</h1>
            <button onclick="window.location.href='super-admin.html'" class="btn btn-warning">‚Üê Super Admin</button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-6">
        <!-- Step 1: Basic Info -->
        <div class="step active" id="step-1">
            <div class="card">
                <h2 class="text-2xl font-bold mb-4">Korak 1: Osnovne Info</h2>
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="quizName" placeholder="Naziv kviza">
                    <input type="datetime-local" id="quizTime">
                    <input type="number" id="quizPrize" placeholder="Nagrada (‚Ç¨)" value="1000">
                    <input type="number" id="quizMaxPlayers" placeholder="Max igraƒça" value="100">
                    <input type="text" id="quizPassword" placeholder="≈†ifra" value="lukavac123">
                    <input type="number" id="numRounds" placeholder="Broj krugova" value="3" min="1" max="10">
                </div>
                <button onclick="goStep(2)" class="btn btn-primary mt-4">Sljedeƒáe ‚Üí</button>
            </div>
        </div>

        <!-- Step 2: Load from DB -->
        <div class="step" id="step-2">
            <div class="card">
                <h2 class="text-2xl font-bold mb-4">Korak 2: Uƒçitaj iz Baze</h2>
                <p>Pitanja u bazi: <span id="dbCount" class="font-bold">0</span></p>
                <button onclick="loadFromDB()" class="btn btn-success my-4">üì• Uƒçitaj Sve</button>
                <div id="loadStatus"></div>
                <div class="flex gap-2 mt-4">
                    <button onclick="goStep(1)" class="btn btn-warning">‚Üê Nazad</button>
                    <button onclick="goStep(3)" class="btn btn-primary">Sljedeƒáe ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Step 3: Assign by Rounds -->
        <div class="step" id="step-3">
            <div class="card">
                <h2 class="text-2xl font-bold mb-4">Korak 3: Dodijeli po Krugovima</h2>
                <div id="roundBoxes"></div>
                <div class="flex gap-2 mt-4">
                    <button onclick="goStep(2)" class="btn btn-warning">‚Üê Nazad</button>
                    <button onclick="goStep(4)" class="btn btn-primary">Sljedeƒáe ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Step 4: Settings -->
        <div class="step" id="step-4">
            <div class="card">
                <h2 class="text-2xl font-bold mb-4">Korak 4: Postavke</h2>
                <div id="settingsBoxes"></div>
                <h3 class="font-bold text-lg mb-2 mt-6">Globalne Postavke:</h3>
                <div class="grid grid-cols-3 gap-4">
                    <input type="number" id="exclamC" placeholder="! Toƒçno" value="150">
                    <input type="number" id="exclamW" placeholder="! Krivo" value="-50">
                    <input type="number" id="periodC" placeholder=". Toƒçno" value="50">
                    <input type="number" id="periodW" placeholder=". Krivo" value="-10">
                    <input type="number" id="lukavacC" placeholder="? Toƒçno" value="50">
                    <input type="number" id="lukavacW" placeholder="? Krivo" value="-25">
                </div>
                <label class="flex items-center my-2"><input type="checkbox" id="earlyC" checked> Auto-continue</label>
                <label class="flex items-center my-2"><input type="checkbox" id="skipL" checked> Skip lukavac</label>
                <div id="review" class="mt-6"></div>
                <div class="flex gap-2 mt-4">
                    <button onclick="goStep(3)" class="btn btn-warning">‚Üê Nazad</button>
                    <button onclick="create()" class="btn btn-success text-xl p-4">üöÄ KREIRAJ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let step = 1;
        let allQ = [];
        let roundQ = {};
        let roundS = {};
        let curR = 1;

        window.onload = () => {
            database.ref('questionBank').once('value').then(s => {
                document.getElementById('dbCount').textContent = s.exists() ? Object.keys(s.val()).length : 0;
            });
        };

        function goStep(n) {
            document.getElementById(`step-${step}`).classList.remove('active');
            step = n;
            document.getElementById(`step-${step}`).classList.add('active');
            if (n === 3) renderRounds();
            if (n === 4) renderSettings();
        }

        function loadFromDB() {
            database.ref('questionBank').once('value').then(s => {
                if (!s.exists()) { alert('Nema pitanja!'); return; }
                allQ = Object.entries(s.val()).map(([id, d]) => ({id, ...d}));
                document.getElementById('loadStatus').innerHTML = `<p class="text-green-600 font-bold">‚úÖ ${allQ.length} pitanja</p>`;
                initRounds();
            });
        }

        function initRounds() {
            const n = parseInt(document.getElementById('numRounds').value);
            for (let i = 1; i <= n; i++) {
                if (!roundQ[i]) roundQ[i] = [];
                if (!roundS[i]) roundS[i] = {t1:20, t2:5, t3:5, p:3, players:100, prize:0};
            }
        }

        function renderRounds() {
            initRounds();
            const n = parseInt(document.getElementById('numRounds').value);
            let h = '';
            for (let r = 1; r <= n; r++) {
                h += `<div class="round-box">
                    <h3 class="text-2xl font-bold mb-2">Krug ${r} <span id="c${r}">(${roundQ[r].length})</span></h3>
                    <button onclick="curR=${r}; renderRounds();" class="btn btn-${curR===r?'success':'primary'} mb-2">${curR===r?'‚úì Trenutni':'Dodaj ovdje'}</button>
                    ${curR===r ? `<div class="mb-2"><select id="fCat" onchange="renderAvail()"><option value="">Sve kat.</option><option>Sport</option><option>Geografija</option><option>Povijest</option></select>
                    <select id="fDiff" onchange="renderAvail()"><option value="">Sve te≈æ.</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></div>` : ''}
                    <div id="r${r}Q"></div>
                </div>`;
            }
            h += `<div class="p-4 bg-yellow-50 rounded"><h4 class="font-bold">Dostupna za Krug ${curR}:</h4><div id="avail"></div></div>`;
            document.getElementById('roundBoxes').innerHTML = h;
            for (let r = 1; r <= n; r++) showRoundQ(r);
            renderAvail();
        }

        function showRoundQ(r) {
            const qs = roundQ[r].map(id => allQ.find(q => q.id === id)).filter(q => q);
            let h = '';
            if (qs.length === 0) h = '<p class="text-gray-500">Nema</p>';
            else qs.forEach((q, i) => {
                h += `<div class="q-item selected"><strong>${i+1}. ${q.text}</strong><br><small>${q.category} | <span class="diff-${q.difficulty}">‚≠ê${q.difficulty}</span></small>
                <button onclick="remQ(${r},'${q.id}')" class="btn btn-warning btn-sm float-right">üóëÔ∏è</button></div>`;
            });
            document.getElementById(`r${r}Q`).innerHTML = h;
        }

        function renderAvail() {
            const assigned = Object.values(roundQ).flat();
            let avail = allQ.filter(q => !assigned.includes(q.id));
            const fc = document.getElementById('fCat')?.value || '';
            const fd = document.getElementById('fDiff')?.value || '';
            if (fc) avail = avail.filter(q => q.category === fc);
            if (fd) avail = avail.filter(q => q.difficulty == fd);
            let h = '';
            if (avail.length === 0) h = '<p class="text-gray-500">Nema dostupnih</p>';
            else avail.forEach(q => {
                h += `<div class="q-item" onclick="addQ(${curR},'${q.id}')"><strong>${q.text}</strong><br><small>${q.category} | <span class="diff-${q.difficulty}">‚≠ê${q.difficulty}</span></small></div>`;
            });
            document.getElementById('avail').innerHTML = h;
        }

        function addQ(r, id) {
            if (roundQ[r].includes(id)) return;
            roundQ[r].push(id);
            document.getElementById(`c${r}`).textContent = `(${roundQ[r].length})`;
            showRoundQ(r);
            renderAvail();
        }

        function remQ(r, id) {
            const i = roundQ[r].indexOf(id);
            if (i > -1) roundQ[r].splice(i, 1);
            document.getElementById(`c${r}`).textContent = `(${roundQ[r].length})`;
            showRoundQ(r);
            renderAvail();
        }

        function renderSettings() {
            const n = parseInt(document.getElementById('numRounds').value);
            let h = '';
            for (let r = 1; r <= n; r++) {
                const s = roundS[r];
                h += `<div class="round-box"><h3 class="font-bold text-lg">Krug ${r} (${roundQ[r].length} pit.)</h3>
                <div class="grid grid-cols-4 gap-2">
                <input type="number" id="r${r}t1" placeholder="Faza 1 (s)" value="${s.t1}">
                <input type="number" id="r${r}t2" placeholder="Faza 2 (s)" value="${s.t2}">
                <input type="number" id="r${r}t3" placeholder="Faza 3 (s)" value="${s.t3}">
                <input type="number" id="r${r}p" placeholder="Pauza (s)" value="${s.p}">
                </div>
                <div class="grid grid-cols-2 gap-2 mt-2">
                <input type="number" id="r${r}pl" placeholder="Igraƒça ostaje" value="${s.players}">
                <input type="number" id="r${r}pr" placeholder="Nagrada (‚Ç¨)" value="${s.prize}">
                </div></div>`;
            }
            document.getElementById('settingsBoxes').innerHTML = h;
            showReview();
        }

        function showReview() {
            const n = parseInt(document.getElementById('numRounds').value);
            let h = `<div class="bg-blue-50 p-4 rounded"><h3 class="font-bold">Pregled:</h3>
            <p>Naziv: ${document.getElementById('quizName').value}</p>
            <p>Vrijeme: ${new Date(document.getElementById('quizTime').value).toLocaleString()}</p></div>`;
            for (let r = 1; r <= n; r++) {
                h += `<div class="border p-2 my-2"><strong>Krug ${r}</strong>: ${roundQ[r].length} pit.</div>`;
            }
            document.getElementById('review').innerHTML = h;
        }

        function create() {
            if (!confirm('Kreirati?')) return;
            const n = parseInt(document.getElementById('numRounds').value);
            const rounds = [];
            const allQs = [];
            for (let r = 1; r <= n; r++) {
                const qs = roundQ[r].map(id => allQ.find(q => q.id === id));
                rounds.push({
                    roundNumber: r,
                    questionsCount: qs.length,
                    time1: parseInt(document.getElementById(`r${r}t1`).value),
                    time2: parseInt(document.getElementById(`r${r}t2`).value),
                    time3: parseInt(document.getElementById(`r${r}t3`).value),
                    pauseTime: parseInt(document.getElementById(`r${r}p`).value),
                    playersRemaining: parseInt(document.getElementById(`r${r}pl`).value),
                    prizePool: parseInt(document.getElementById(`r${r}pr`).value)
                });
                allQs.push(...qs);
            }
            const data = {
                name: document.getElementById('quizName').value,
                startTime: new Date(document.getElementById('quizTime').value).getTime(),
                prizePool: parseInt(document.getElementById('quizPrize').value),
                maxPlayers: parseInt(document.getElementById('quizMaxPlayers').value),
                password: document.getElementById('quizPassword').value,
                questions: allQs,
                questionCount: allQs.length,
                settings: {
                    quizName: document.getElementById('quizName').value,
                    maxPlayers: parseInt(document.getElementById('quizMaxPlayers').value),
                    password: document.getElementById('quizPassword').value,
                    rounds: rounds,
                    exclamationCorrect: parseInt(document.getElementById('exclamC').value),
                    exclamationWrong: parseInt(document.getElementById('exclamW').value),
                    periodCorrect: parseInt(document.getElementById('periodC').value),
                    periodWrong: parseInt(document.getElementById('periodW').value),
                    lukavacCorrect: parseInt(document.getElementById('lukavacC').value),
                    lukavacWrong: parseInt(document.getElementById('lukavacW').value),
                    earlyContinue: document.getElementById('earlyC').checked,
                    skipLukavac: document.getElementById('skipL').checked
                },
                status: 'scheduled',
                playerCount: 0,
                registeredPlayers: [],
                createdAt: Date.now()
            };
            const id = database.ref('scheduledQuizzes').push().key;
            database.ref(`scheduledQuizzes/${id}`).set(data).then(() => {
                allQs.forEach(q => {
                    const h = q.usageHistory || [];
                    h.push({quizId: id, quizName: data.name, date: Date.now()});
                    database.ref(`questionBank/${q.id}/usageHistory`).set(h);
                });
                alert(`‚úÖ KVIZ KREIRAN!\n${allQs.length} pitanja, ${n} krugova`);
                window.location.href = 'super-admin.html';
            });
        }
    </script>
</body>
</html>
