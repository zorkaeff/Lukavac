<!DOCTYPE html>
<!-- Player Dashboard v2.0 - redesigned to match player.html UI -->
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Lukavac Kviz</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tillana:wght@400;500;600;700;800&family=Metal+Mania&display=swap" rel="stylesheet">

    <style>
        :root {
            --brand: #b75800;
            --brand-dark: #632705;
            --brand-light: #ffd995;
            --brand-pale: #fffff1;
            --brand-bg: linear-gradient(135deg, #f5e6d3 0%, #d97706 50%, #f5e6d3 100%);
            --card-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        * { box-sizing: border-box; }

        body {
            background: var(--brand-bg);
            font-family: 'Tillana', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .hallock-font { font-family: 'Metal Mania', cursive; }

        /* ‚îÄ‚îÄ CARD ‚Äî same style as player.html ‚îÄ‚îÄ */
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
        }

        /* ‚îÄ‚îÄ HEADER BAR ‚îÄ‚îÄ */
        .top-headbar {
            background: white;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            padding: 8px 12px;
            margin-bottom: 8px;
        }

        /* ‚îÄ‚îÄ MENU BUTTONS ‚Äî mimic answer-btn style ‚îÄ‚îÄ */
        .menu-btn {
            background: linear-gradient(135deg, var(--brand-pale) 0%, var(--brand-light) 100%);
            border: 2px solid var(--brand);
            border-radius: 15px;
            padding: 14px 10px;
            cursor: pointer;
            transition: all 0.25s ease;
            text-align: center;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }

        .menu-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--brand-light) 0%, var(--brand) 100%);
            opacity: 0;
            transition: opacity 0.25s;
            border-radius: 13px;
        }

        .menu-btn:hover::before { opacity: 1; }
        .menu-btn:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(183,88,0,0.35); }
        .menu-btn:hover .btn-icon,
        .menu-btn:hover .btn-label,
        .menu-btn:hover .btn-sub { color: white !important; }
        .menu-btn:hover img { filter: brightness(10) saturate(0); }

        .menu-btn > * { position: relative; z-index: 1; }

        .btn-icon {
            width: 52px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: filter 0.25s;
        }

        .btn-label {
            font-family: 'Metal Mania', cursive;
            font-size: 0.85rem;
            color: var(--brand);
            font-weight: 400;
            line-height: 1.1;
        }

        .btn-sub {
            font-size: 0.62rem;
            color: var(--brand-dark);
            opacity: 0.8;
            line-height: 1.2;
        }

        /* ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ */
        .stat-card {
            background: white;
            border: 2px solid var(--brand);
            border-radius: 15px;
            padding: 12px 8px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--brand-light), var(--brand));
        }

        .stat-value {
            font-family: 'Metal Mania', cursive;
            font-size: 1.6rem;
            color: var(--brand);
            line-height: 1;
        }

        .stat-label {
            font-size: 0.65rem;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 4px;
        }

        /* ‚îÄ‚îÄ QUIZ CARD ‚îÄ‚îÄ */
        .quiz-card {
            background: linear-gradient(135deg, var(--brand-pale) 0%, #ffe6cc 100%);
            border: 2px solid var(--brand);
            border-radius: 12px;
            padding: 12px 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quiz-card:hover { transform: scale(1.01); box-shadow: 0 5px 20px rgba(183,88,0,0.3); }

        .quiz-live {
            background: linear-gradient(135deg, #064e3b 0%, #10b981 100%);
            color: white;
            border-color: #059669;
        }
        .quiz-live * { color: white !important; }

        /* ‚îÄ‚îÄ LIVE PULSE ‚îÄ‚îÄ */
        @keyframes livePulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(1.4); }
        }
        .live-dot {
            width: 8px; height: 8px;
            background: #ef4444;
            border-radius: 50%;
            display: inline-block;
            animation: livePulse 1.5s infinite;
        }

        /* ‚îÄ‚îÄ ACTIVE GAME BANNER ‚îÄ‚îÄ */
        @keyframes bannerPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16,185,129,0.6); }
            50% { box-shadow: 0 0 20px 8px rgba(16,185,129,0); }
        }
        .active-game-banner {
            background: linear-gradient(135deg, #064e3b 0%, #10b981 100%);
            border-radius: 15px;
            padding: 16px;
            color: white;
            animation: bannerPulse 2.5s infinite;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .active-game-banner:hover { transform: scale(1.02); }

        /* ‚îÄ‚îÄ NOTIFICATION ‚îÄ‚îÄ */
        .notif-item {
            padding: 10px 12px;
            border-radius: 10px;
            background: var(--brand-pale);
            border-left: 3px solid var(--brand);
            font-size: 0.82rem;
            color: var(--brand-dark);
        }
        .notif-item.unread { background: #fef3c7; border-left-color: #f59e0b; }

        /* ‚îÄ‚îÄ RESULT ROW ‚îÄ‚îÄ */
        .result-row {
            background: var(--brand-pale);
            border: 1px solid var(--brand-light);
            border-radius: 10px;
            padding: 10px 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.15s;
        }
        .result-row:hover { background: var(--brand-light); }

        /* ‚îÄ‚îÄ SECTION TITLE ‚îÄ‚îÄ */
        .section-title {
            font-family: 'Metal Mania', cursive;
            font-size: 1.1rem;
            color: var(--brand);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--brand-light);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ‚îÄ‚îÄ BADGE ‚îÄ‚îÄ */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
        }
        .badge-live { background: #10b981; color: white; }
        .badge-scheduled { background: #3b82f6; color: white; }
        .badge-finished { background: #6b7280; color: white; }

        /* ‚îÄ‚îÄ PROFILE PHOTO RING ‚îÄ‚îÄ */
        .profile-ring {
            width: 48px; height: 48px;
            border-radius: 50%;
            border: 2.5px solid var(--brand);
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .profile-ring:hover { transform: scale(1.1); }

        /* ‚îÄ‚îÄ JOIN MODAL ‚îÄ‚îÄ */
        #joinModal {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.55);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 16px;
        }
        #joinModal.open { display: flex; }
        .modal-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 28px;
            width: 100%;
            max-width: 380px;
            animation: modalIn 0.25s ease;
        }
        @keyframes modalIn {
            from { transform: scale(0.9) translateY(20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }

        .modal-input {
            border: 2px solid var(--brand-light);
            border-radius: 10px;
            padding: 12px 16px;
            width: 100%;
            font-family: 'Tillana', cursive;
            font-size: 1.1rem;
            text-align: center;
            letter-spacing: 0.1em;
            transition: border-color 0.2s;
        }
        .modal-input:focus { border-color: var(--brand); outline: none; }

        .btn-primary {
            background: linear-gradient(135deg, var(--brand) 0%, var(--brand-dark) 100%);
            color: white;
            font-family: 'Metal Mania', cursive;
            font-size: 1rem;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .btn-primary:hover { transform: scale(1.03); box-shadow: 0 6px 20px rgba(183,88,0,0.4); }

        .btn-cancel {
            background: transparent;
            border: 2px solid var(--brand-light);
            color: #9ca3af;
            font-family: 'Tillana', cursive;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            margin-top: 8px;
            transition: border-color 0.2s;
        }
        .btn-cancel:hover { border-color: var(--brand); color: var(--brand); }

        /* ‚îÄ‚îÄ SCROLL FADE IN ‚îÄ‚îÄ */
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-up { animation: fadeUp 0.4s ease forwards; }
        .fade-up-1 { animation-delay: 0.05s; opacity: 0; }
        .fade-up-2 { animation-delay: 0.10s; opacity: 0; }
        .fade-up-3 { animation-delay: 0.15s; opacity: 0; }
        .fade-up-4 { animation-delay: 0.20s; opacity: 0; }
        .fade-up-5 { animation-delay: 0.25s; opacity: 0; }

        /* ‚îÄ‚îÄ LOGOUT BTN ‚îÄ‚îÄ */
        .logout-btn {
            background: transparent;
            border: 1.5px solid var(--brand-light);
            color: var(--brand);
            font-family: 'Tillana', cursive;
            font-size: 0.75rem;
            padding: 4px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .logout-btn:hover { background: var(--brand); color: white; border-color: var(--brand); }
    </style>
</head>

<body class="p-2 pb-8">

    <!-- ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê -->
    <div class="top-headbar fade-up fade-up-1">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <!-- Logo + Brand -->
            <div style="display:flex; align-items:center; gap:10px;">
                <img src="cunning_logo_lukavac.png" alt="Logo" style="width:38px; height:38px;">
                <div>
                    <div class="hallock-font" style="font-size:1.3rem; color:var(--brand); line-height:1;">CUNNING</div>
                    <div style="font-size:0.6rem; color:var(--brand-dark); font-weight:600;">Igra znanja i lukavosti</div>
                </div>
            </div>

            <!-- Player Info -->
            <div style="display:flex; align-items:center; gap:10px;">
                <div style="text-align:right;">
                    <div style="font-size:0.7rem; color:#6b7280;">Dobrodo≈°ao,</div>
                    <div style="font-family:'Metal Mania',cursive; font-size:0.95rem; color:var(--brand);" id="headerPlayerName">‚Äî</div>
                </div>
                <img id="headerPlayerPhoto"
                     src="https://ui-avatars.com/api/?background=ffd995&color=b75800&name=P&bold=true&size=48"
                     class="profile-ring"
                     alt="Profil"
                     onclick="goToProfile()">
                <button class="logout-btn" onclick="logout()">Odjava</button>
            </div>
        </div>
    </div>

    <div class="max-w-2xl mx-auto">

        <!-- ‚ïê‚ïê‚ïê ACTIVE GAME BANNER (hidden by default) ‚ïê‚ïê‚ïê -->
        <div id="activeGameBanner" class="active-game-banner hidden mb-3 fade-up fade-up-1" onclick="joinActiveGame()">
            <div style="display:flex; align-items:center; justify-content:space-between;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <img src="cunning_logo_lukavac.png" alt="" style="width:40px; height:40px; filter:brightness(10) saturate(0);">
                    <div>
                        <div class="hallock-font" style="font-size:1.1rem;">üî¥ KVIZ U≈ΩIVO!</div>
                        <div style="font-size:0.8rem; opacity:0.9;" id="activeBannerText">Igra je u tijeku ‚Äî klikni za ulaz</div>
                    </div>
                </div>
                <div style="background:rgba(255,255,255,0.25); border-radius:10px; padding:8px 16px; font-family:'Metal Mania',cursive; font-size:0.9rem;">
                    ULAZ ‚Üí
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê STATS ROW ‚ïê‚ïê‚ïê -->
        <div class="grid grid-cols-4 gap-2 mb-3 fade-up fade-up-2" id="statsRow">
            <div class="stat-card">
                <div class="stat-value" id="statWins">0</div>
                <div class="stat-label">Pobjede</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" style="color:#10b981;" id="statEarnings">0‚Ç¨</div>
                <div class="stat-label">Zarada</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" style="color:#f59e0b;" id="statRating">‚Äî</div>
                <div class="stat-label">Ocjena</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" style="color:#3b82f6;" id="statRank">#‚Äî</div>
                <div class="stat-label">Rang</div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê MENU GRID ‚ïê‚ïê‚ïê -->
        <div class="card p-3 mb-3 fade-up fade-up-3">
            <div class="section-title">
                <img src="cunning_logo_lukavac.png" alt="" style="width:18px; height:18px;">
                IZBORNIK
            </div>
            <div class="grid grid-cols-4 gap-2" id="menuGrid">

                <!-- KVIZOVI -->
                <div class="menu-btn" onclick="goTo('quizzes.html')">
                    <div class="btn-icon">
                        <img src="Lukavac_nudi_eure.png" alt="Kvizovi">
                    </div>
                    <div class="btn-label">KVIZOVI</div>
                    <div class="btn-sub">Pridru≈æi se</div>
                </div>

                <!-- REZULTATI -->
                <div class="menu-btn" onclick="goTo('results.html')">
                    <div class="btn-icon">
                        <img src="Lukavac_statistika.png" alt="Rezultati">
                    </div>
                    <div class="btn-label">REZULTATI</div>
                    <div class="btn-sub">Pro≈°li kvizovi</div>
                </div>

                <!-- RANG LISTA -->
                <div class="menu-btn" onclick="goTo('rankings.html')">
                    <div class="btn-icon">
                        <img src="Lukavac_pobjednik.png" alt="Rang lista">
                    </div>
                    <div class="btn-label">RANG LISTA</div>
                    <div class="btn-sub">Svi igraƒçi</div>
                </div>

                <!-- MOJ PROFIL -->
                <div class="menu-btn" onclick="goToProfile()">
                    <div class="btn-icon">
                        <img src="Lukavac_godine.png" alt="Profil">
                    </div>
                    <div class="btn-label">MOJ PROFIL</div>
                    <div class="btn-sub">Uredi podatke</div>
                </div>

                <!-- PRAVILA -->
                <div class="menu-btn" onclick="goTo('rules.html')">
                    <div class="btn-icon">
                        <img src="Lukavac_informacije.png" alt="Pravila">
                    </div>
                    <div class="btn-label">PRAVILA</div>
                    <div class="btn-sub">Kako se igra</div>
                </div>

                <!-- DOUBLE TROUBLE -->
                <div class="menu-btn" onclick="goTo('news.html')">
                    <div class="btn-icon">
                        <img src="Lukavac_double_trouble.png" alt="Novosti">
                    </div>
                    <div class="btn-label">NOVOSTI</div>
                    <div class="btn-sub">Najnovije</div>
                </div>

                <!-- DONACIJE -->
                <div class="menu-btn" onclick="goTo('donations.html')">
                    <div class="btn-icon">
                        <img src="Lukavac_plese.png" alt="Donacije">
                    </div>
                    <div class="btn-label">DONACIJE</div>
                    <div class="btn-sub">Podr≈æi projekt</div>
                </div>

                <!-- KONTAKT -->
                <div class="menu-btn" onclick="goTo('contact.html')">
                    <div class="btn-icon">
                        <img src="Lukavac_slavi_toƒçan_odgovor.png" alt="Kontakt">
                    </div>
                    <div class="btn-label">KONTAKT</div>
                    <div class="btn-sub">Pi≈°ite nam</div>
                </div>

            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê LIVE & UPCOMING QUIZZES ‚ïê‚ïê‚ïê -->
        <div class="card p-4 mb-3 fade-up fade-up-3">
            <div class="section-title">
                <span class="live-dot"></span>
                U≈ΩIVO &amp; NADOLAZEƒÜI
            </div>
            <div id="liveQuizzes">
                <p style="color:#9ca3af; font-size:0.85rem; text-align:center; padding:16px 0;">Uƒçitavam kvizove...</p>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê MY QUIZZES ‚ïê‚ïê‚ïê -->
        <div class="card p-4 mb-3 fade-up fade-up-4" id="myQuizzesSection">
            <div class="section-title">
                <img src="cunning_logo_lukavac.png" alt="" style="width:16px; height:16px;">
                MOJI PRIJAVLJENI KVIZOVI
            </div>
            <div id="myQuizzes">
                <p style="color:#9ca3af; font-size:0.85rem; text-align:center; padding:12px 0;">Nisi prijavljen ni na jedan kviz</p>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê NOTIFICATIONS ‚ïê‚ïê‚ïê -->
        <div class="card p-4 mb-3 fade-up fade-up-4">
            <div class="section-title">
                üîî NOTIFIKACIJE
            </div>
            <div id="notifications" class="space-y-2">
                <p style="color:#9ca3af; font-size:0.85rem; text-align:center; padding:12px 0;">Nema notifikacija</p>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê RECENT RESULTS ‚ïê‚ïê‚ïê -->
        <div class="card p-4 mb-3 fade-up fade-up-5">
            <div class="section-title">
                <img src="Lukavac_statistika.png" alt="" style="width:20px; height:20px;">
                NEDAVNI REZULTATI
            </div>
            <div id="recentResults" class="space-y-2">
                <p style="color:#9ca3af; font-size:0.85rem; text-align:center; padding:12px 0;">Nema rezultata</p>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê FOOTER ‚ïê‚ïê‚ïê -->
        <div style="text-align:center; padding:8px 0; opacity:0.5;">
            <div class="hallock-font" style="font-size:0.8rem; color:var(--brand);">CUNNING</div>
            <div style="font-size:0.6rem; color:#6b7280;">¬Æ Za≈°tiƒáeno autorsko djelo ¬∑ v2.0</div>
        </div>

    </div><!-- /max-w-2xl -->


    <!-- ‚ïê‚ïê‚ïê JOIN MODAL ‚ïê‚ïê‚ïê -->
    <div id="joinModal">
        <div class="modal-card">
            <div style="text-align:center; margin-bottom:20px;">
                <img src="cunning_logo_lukavac.png" alt="Logo" style="width:48px; height:48px; margin:0 auto 8px;">
                <div class="hallock-font" style="font-size:1.3rem; color:var(--brand);" id="modalQuizName">Kviz</div>
                <div style="font-size:0.8rem; color:#6b7280;">Unesi ≈°ifru za prijavu</div>
            </div>

            <input type="text" id="modalPasswordInput" class="modal-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                   style="margin-bottom:12px; letter-spacing:0.25em;"
                   onkeypress="if(event.key==='Enter') confirmJoinQuiz()">

            <button class="btn-primary" onclick="confirmJoinQuiz()">PRIJAVI SE NA KVIZ</button>
            <button class="btn-cancel" onclick="closeModal()">Odustani</button>

            <div id="modalError" class="hidden" style="margin-top:10px; background:#fef2f2; border:1px solid #fca5a5; border-radius:8px; padding:8px 12px; text-align:center; font-size:0.82rem; color:#ef4444;"></div>
        </div>
    </div>


    <script>
        // ‚îÄ‚îÄ‚îÄ GLOBALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let playerProfile = null;
        let playerProfileId = null;
        let pendingJoinQuizId = null;

        // ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.onload = function() {
            playerProfileId = sessionStorage.getItem('playerProfileId');
            if (!playerProfileId) {
                window.location.href = 'login.html';
                return;
            }

            const raw = sessionStorage.getItem('playerProfile');
            if (raw) {
                playerProfile = JSON.parse(raw);
                renderHeaderPlayer();
                renderStats();
            }

            loadLiveGame();
            loadQuizzes();
            loadMyQuizzes();
            loadNotifications();
            loadRecentResults();
        };

        // ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderHeaderPlayer() {
            const name = playerProfile.nickname || playerProfile.firstName || 'Igraƒç';
            document.getElementById('headerPlayerName').textContent = name;

            if (playerProfile.profilePhoto) {
                document.getElementById('headerPlayerPhoto').src = playerProfile.profilePhoto;
            } else {
                const initial = name.charAt(0).toUpperCase();
                document.getElementById('headerPlayerPhoto').src =
                    `https://ui-avatars.com/api/?background=ffd995&color=b75800&name=${initial}&bold=true&size=48`;
            }
        }

        // ‚îÄ‚îÄ‚îÄ STATS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderStats() {
            document.getElementById('statWins').textContent  = playerProfile.wins || 0;
            document.getElementById('statEarnings').textContent = (playerProfile.stats?.totalEarnings || 0) + '‚Ç¨';
            document.getElementById('statRating').textContent = playerProfile.stats?.averageRating
                ? parseFloat(playerProfile.stats.averageRating).toFixed(1)
                : '‚Äî';
            document.getElementById('statRank').textContent = '#' + (playerProfile.stats?.currentRank || '‚Äî');
        }

        // ‚îÄ‚îÄ‚îÄ DETECT LIVE GAME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function loadLiveGame() {
            database.ref('gameState').on('value', snap => {
                const gs = snap.val();
                const banner = document.getElementById('activeGameBanner');
                if (gs && gs.isActive && gs.phase !== 'waiting' && gs.phase !== 'gameEnd') {
                    banner.classList.remove('hidden');
                    document.getElementById('activeBannerText').textContent =
                        gs.phase === 'answering' ? 'Pitanje je aktivno ‚Äî ulazi odmah!'
                        : gs.phase === 'pause'   ? 'Pauza izmeƒëu pitanja ‚Äî pridru≈æi se!'
                        : 'Igra je u tijeku ‚Äî klikni za ulaz';
                } else {
                    banner.classList.add('hidden');
                }
            });
        }

        function joinActiveGame() { window.location.href = 'player.html'; }

        // ‚îÄ‚îÄ‚îÄ QUIZZES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function loadQuizzes() {
            database.ref('scheduledQuizzes').orderByChild('startTime').once('value').then(snap => {
                const quizzes = snap.val();
                let html = '';

                if (!quizzes) {
                    html = '<p style="color:#9ca3af; font-size:0.85rem; text-align:center; padding:16px 0;">Nema zakazanih kvizova</p>';
                } else {
                    const now = Date.now();
                    const arr = Object.entries(quizzes).map(([id, d]) => ({id, ...d}));
                    arr.sort((a, b) => a.startTime - b.startTime);

                    arr.forEach(quiz => {
                        const isLive = quiz.status === 'live';
                        const isFuture = quiz.startTime > now;
                        const dt = new Date(quiz.startTime).toLocaleString('hr-HR', {
                            day:'2-digit', month:'2-digit', year:'numeric',
                            hour:'2-digit', minute:'2-digit'
                        });

                        const badge = isLive
                            ? `<span class="badge badge-live"><span class="live-dot" style="width:6px;height:6px;"></span> U≈ΩIVO</span>`
                            : isFuture
                            ? `<span class="badge badge-scheduled">üìÖ ZAKAZANO</span>`
                            : `<span class="badge badge-finished">‚úì ZAVR≈†ENO</span>`;

                        const cardCls = isLive ? 'quiz-card quiz-live' : 'quiz-card';

                        html += `
                            <div class="${cardCls} mb-2" onclick="openJoinModal('${quiz.id}', '${(quiz.name||'Kviz').replace(/'/g,"\\'")}')">
                                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:6px;">
                                    <div>
                                        <div style="font-weight:700; font-size:0.95rem;">${quiz.name || 'Kviz'}</div>
                                        <div style="font-size:0.72rem; opacity:0.75;">üïê ${dt}</div>
                                    </div>
                                    ${badge}
                                </div>
                                <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:4px; font-size:0.72rem; font-weight:600;">
                                    <div>üí∞ ${quiz.prizePool || 0}‚Ç¨</div>
                                    <div>üë• ${quiz.playerCount || 0} igraƒça</div>
                                    <div>‚ùì ${quiz.questionCount || 10} pit.</div>
                                </div>
                                ${isLive ? '<div style="margin-top:8px; font-weight:700; font-size:0.85rem;">‚ö° Pridru≈æi se odmah!</div>' : ''}
                            </div>
                        `;
                    });
                }
                document.getElementById('liveQuizzes').innerHTML = html;
            }).catch(() => {
                document.getElementById('liveQuizzes').innerHTML =
                    '<p style="color:#9ca3af; font-size:0.85rem; text-align:center; padding:16px 0;">Nema zakazanih kvizova</p>';
            });
        }

        // ‚îÄ‚îÄ‚îÄ MY QUIZZES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function loadMyQuizzes() {
            database.ref(`playerProfiles/${playerProfileId}/registeredQuizzes`).on('value', snap => {
                const registered = snap.val();
                if (!registered) {
                    document.getElementById('myQuizzes').innerHTML =
                        '<p style="color:#9ca3af; font-size:0.85rem; text-align:center; padding:12px 0;">Nisi prijavljen ni na jedan kviz</p>';
                    return;
                }

                const ids = Object.keys(registered);
                let html = '';
                let loaded = 0;

                ids.forEach(qid => {
                    database.ref(`scheduledQuizzes/${qid}`).once('value').then(qs => {
                        const quiz = qs.val();
                        if (!quiz) { loaded++; return; }

                        const dt = new Date(quiz.startTime).toLocaleString('hr-HR');
                        const msLeft = quiz.startTime - Date.now();
                        const minsLeft = Math.floor(msLeft / 60000);

                        let status = '';
                        if (minsLeft < 1)       status = '<span style="color:#ef4444; font-weight:700; font-size:0.8rem;">üî¥ POƒåINJE ODMAH!</span>';
                        else if (minsLeft < 60)  status = `<span style="color:#f97316; font-weight:700; font-size:0.8rem;">‚è∞ Za ${minsLeft} min</span>`;
                        else                      status = '<span style="color:#10b981; font-size:0.8rem;">‚úÖ Prijavljen</span>';

                        const btnHtml = minsLeft < 1
                            ? `<button onclick="enterQuiz('${qid}')" style="background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;padding:6px 14px;border-radius:8px;font-weight:700;cursor:pointer;font-size:0.8rem;">üéÆ IGRAJ!</button>`
                            : `<button onclick="withdrawFromQuiz('${qid}')" style="background:transparent;border:1.5px solid #fca5a5;color:#ef4444;padding:5px 12px;border-radius:8px;cursor:pointer;font-size:0.78rem;">‚ùå Odustani</button>`;

                        html += `
                            <div style="background:linear-gradient(135deg,#f0fdf4,#dcfce7);border:2px solid #10b981;border-radius:12px;padding:10px 14px;margin-bottom:8px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                                    <div>
                                        <div style="font-weight:700; font-size:0.9rem; color:#064e3b;">${quiz.name}</div>
                                        <div style="font-size:0.7rem; color:#6b7280;">üïê ${dt}</div>
                                    </div>
                                    ${status}
                                </div>
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div style="font-size:0.72rem; color:#374151; font-weight:600;">üí∞ ${quiz.prizePool||0}‚Ç¨ ¬∑ ‚ùì ${quiz.questionCount||0} pit.</div>
                                    ${btnHtml}
                                </div>
                            </div>
                        `;

                        loaded++;
                        if (loaded === ids.length) {
                            document.getElementById('myQuizzes').innerHTML = html || '<p style="color:#9ca3af; font-size:0.85rem;">Nema</p>';
                        }
                    });
                });
            });
        }

        // ‚îÄ‚îÄ‚îÄ NOTIFICATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function loadNotifications() {
            database.ref(`notifications/${playerProfileId}`)
                .orderByChild('timestamp').limitToLast(10).on('value', snap => {
                const notifs = snap.val();
                if (!notifs) {
                    document.getElementById('notifications').innerHTML =
                        '<p style="color:#9ca3af; font-size:0.85rem; text-align:center; padding:12px 0;">Nema notifikacija</p>';
                    return;
                }
                let html = '';
                Object.entries(notifs).reverse().forEach(([id, n]) => {
                    const dt = new Date(n.timestamp).toLocaleString('hr-HR');
                    const cls = n.read ? 'notif-item' : 'notif-item unread';
                    html += `
                        <div class="${cls}" onclick="markRead('${id}')">
                            <div style="font-weight:600;">${n.message}</div>
                            <div style="font-size:0.68rem; color:#9ca3af; margin-top:2px;">${dt}</div>
                        </div>
                    `;
                });
                document.getElementById('notifications').innerHTML = html;
            });
        }

        function markRead(nid) {
            database.ref(`notifications/${playerProfileId}/${nid}/read`).set(true);
        }

        // ‚îÄ‚îÄ‚îÄ RECENT RESULTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function loadRecentResults() {
            database.ref(`playerResults/${playerProfileId}`).limitToLast(5).once('value').then(snap => {
                const res = snap.val();
                if (!res) {
                    document.getElementById('recentResults').innerHTML =
                        '<p style="color:#9ca3af; font-size:0.85rem; text-align:center; padding:12px 0;">Nema rezultata</p>';
                    return;
                }
                let html = '';
                Object.entries(res).reverse().forEach(([, r]) => {
                    const dt = new Date(r.timestamp).toLocaleDateString('hr-HR');
                    const rankColor = r.rank === 1 ? '#10b981' : r.rank <= 3 ? '#f59e0b' : '#6b7280';
                    const rankMedal = r.rank === 1 ? 'ü•á' : r.rank === 2 ? 'ü•à' : r.rank === 3 ? 'ü•â' : '';
                    html += `
                        <div class="result-row">
                            <div>
                                <div style="font-weight:700; font-size:0.88rem;">${r.quizName || 'Kviz'}</div>
                                <div style="font-size:0.68rem; color:#9ca3af;">${dt}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-family:'Metal Mania',cursive; font-size:1.1rem; color:${rankColor};">${rankMedal}#${r.rank}</div>
                                <div style="font-size:0.75rem; color:#10b981; font-weight:700;">+${r.earnings || 0}‚Ç¨</div>
                                <div style="font-size:0.65rem; color:#f59e0b;">‚≠ê ${r.rating || 0}/10</div>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('recentResults').innerHTML = html;
            }).catch(() => {
                document.getElementById('recentResults').innerHTML =
                    '<p style="color:#9ca3af; font-size:0.85rem; text-align:center;">Nema rezultata</p>';
            });
        }

        // ‚îÄ‚îÄ‚îÄ JOIN MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function openJoinModal(quizId, quizName) {
            pendingJoinQuizId = quizId;
            document.getElementById('modalQuizName').textContent = quizName;
            document.getElementById('modalPasswordInput').value = '';
            document.getElementById('modalError').classList.add('hidden');
            document.getElementById('joinModal').classList.add('open');
            setTimeout(() => document.getElementById('modalPasswordInput').focus(), 150);
        }

        function closeModal() {
            document.getElementById('joinModal').classList.remove('open');
            pendingJoinQuizId = null;
        }

        function showModalError(msg) {
            const el = document.getElementById('modalError');
            el.textContent = msg;
            el.classList.remove('hidden');
        }

        function confirmJoinQuiz() {
            const pw = document.getElementById('modalPasswordInput').value.trim();
            if (!pw) { showModalError('Unesi ≈°ifru!'); return; }
            if (!pendingJoinQuizId) { closeModal(); return; }

            const qid = pendingJoinQuizId;

            // Check password
            database.ref('settings/password').once('value').then(snap => {
                const correct = snap.val();
                if (pw !== correct) { showModalError('‚ùå Pogre≈°na ≈°ifra!'); return; }

                // Check if already registered
                database.ref(`scheduledQuizzes/${qid}/registeredPlayers`).once('value').then(snap2 => {
                    const reg = snap2.val() || [];
                    if (reg.includes(playerProfileId)) {
                        showModalError('Veƒá si prijavljen na ovaj kviz!');
                        return;
                    }

                    // Register
                    database.ref(`scheduledQuizzes/${qid}/registeredPlayers`).transaction(arr => {
                        if (!arr) arr = [];
                        if (!arr.includes(playerProfileId)) arr.push(playerProfileId);
                        return arr;
                    }).then(() => {
                        database.ref(`playerProfiles/${playerProfileId}/registeredQuizzes/${qid}`).set({
                            quizId: qid, registeredAt: Date.now(), status: 'registered'
                        });
                        closeModal();
                        loadQuizzes();
                    });
                });
            });
        }

        // Click outside modal to close
        document.getElementById('joinModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function goTo(page) { window.location.href = page; }
        function goToProfile() { window.location.href = 'profile.html'; }

        function enterQuiz(qid) {
            sessionStorage.setItem('currentQuizId', qid);
            window.location.href = 'player.html';
        }

        function withdrawFromQuiz(qid) {
            if (!confirm('Jesi li siguran da se odjavi≈°?')) return;
            database.ref(`scheduledQuizzes/${qid}/registeredPlayers`).transaction(arr => {
                if (!arr) return arr;
                const i = arr.indexOf(playerProfileId);
                if (i > -1) arr.splice(i, 1);
                return arr;
            }).then(() => {
                database.ref(`playerProfiles/${playerProfileId}/registeredQuizzes/${qid}`).remove();
                loadQuizzes();
            });
        }

        function logout() {
            sessionStorage.removeItem('playerProfileId');
            sessionStorage.removeItem('playerProfile');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
