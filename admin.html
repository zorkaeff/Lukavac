<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cunning - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #f5e6d3 0%, #d97706 50%, #f5e6d3 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .btn-primary {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            transition: all 0.3s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(249, 115, 22, 0.4);
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="card p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-4xl font-bold" style="color: #ea580c;">ü¶ä CUNNING - Admin Panel</h1>
                    <p class="text-gray-600 mt-2">Quiz Control Center</p>
                </div>
                <div class="flex gap-3">
                    <a href="index.html" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">‚Üê Back</a>
                    <button onclick="toggleSettings()" class="px-4 py-2 btn-primary text-white rounded-lg">
                        ‚öôÔ∏è Settings
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="card p-4">
                <p class="text-gray-600 text-sm">Status</p>
                <p class="text-2xl font-bold" style="color: #ea580c;" id="gameStatus">Waiting</p>
            </div>
            <div class="card p-4">
                <p class="text-gray-600 text-sm">Players</p>
                <p class="text-2xl font-bold" style="color: #ea580c;"><span id="playerCount">0</span>/<span id="maxPlayers">8</span></p>
            </div>
            <div class="card p-4">
                <p class="text-gray-600 text-sm">Round / Question</p>
                <p class="text-2xl font-bold" style="color: #ea580c;"><span id="currentRound">1</span>/<span id="currentQuestion">0</span></p>
            </div>
            <div class="card p-4">
                <p class="text-gray-600 text-sm">Timer</p>
                <p class="text-2xl font-bold" style="color: #ea580c;" id="timerDisplay">--</p>
            </div>
        </div>

        <!-- Game Controls -->
        <div class="card p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4" style="color: #ea580c;">Game Controls</h2>
            <div class="flex flex-wrap gap-3">
                <button onclick="startGame()" class="px-6 py-3 btn-primary text-white rounded-lg font-bold">
                    ‚ñ∂Ô∏è START QUIZ (AUTO MODE)
                </button>
                <button onclick="pauseGame()" class="px-6 py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-bold">
                    ‚è∏Ô∏è Pause
                </button>
                <button onclick="resumeGame()" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold">
                    ‚ñ∂Ô∏è Resume
                </button>
                <button onclick="nextQuestion()" class="px-6 py-3 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg font-bold">
                    ‚è≠Ô∏è Skip to Next Question
                </button>
                <button onclick="nextRound()" class="px-6 py-3 bg-pink-600 hover:bg-pink-700 text-white rounded-lg font-bold">
                    üîÑ Skip to Next Round
                </button>
                <button onclick="resetPlayers()" class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold">
                    üë• Reset Players
                </button>
                <button onclick="resetGame()" class="px-6 py-3 bg-red-800 hover:bg-red-900 text-white rounded-lg font-bold">
                    üóëÔ∏è Reset Quiz
                </button>
                <button onclick="exportData()" class="px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-bold">
                    üì• Export CSV
                </button>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-6">
            <!-- Leaderboard -->
            <div class="card p-6">
                <h2 class="text-2xl font-bold mb-4" style="color: #ea580c;">üèÜ Leaderboard</h2>
                <div id="leaderboard" class="space-y-2">
                    <!-- Dynamically populated -->
                </div>
            </div>

            <!-- Current Answers -->
            <div class="card p-6">
                <h2 class="text-2xl font-bold mb-4" style="color: #ea580c;">üìä Current Answers</h2>
                <div id="currentAnswers" class="space-y-2">
                    <!-- Dynamically populated -->
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 overflow-y-auto">
        <div class="card p-8 max-w-4xl w-full max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold" style="color: #ea580c;">‚öôÔ∏è Settings Kviza</h2>
                <button onclick="toggleSettings()" class="text-3xl hover:text-red-600">√ó</button>
            </div>

            <!-- Basic Settings -->
            <div class="mb-6">
                <h3 class="text-xl font-bold mb-3" style="color: #ea580c;">Osnovne Settings</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-2">Quiz Name (Suffix)</label>
                        <input type="text" id="quizNameSuffix" value="DANA" placeholder="DANA, SATA, TJEDNA..." class="w-full p-2 border-2 rounded-lg">
                        <p class="text-xs text-gray-500 mt-1">Displayed as: CUNNING [SUFFIX]</p>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">Entry Password</label>
                        <input type="text" id="quizPassword" value="1234" class="w-full p-2 border-2 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">Min. Players</label>
                        <input type="number" id="minPlayers" value="2" min="2" max="999" class="w-full p-2 border-2 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">Max. Players</label>
                        <input type="number" id="maxPlayersInput" value="8" min="2" max="999" class="w-full p-2 border-2 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">Number of Rounds</label>
                        <input type="number" id="numRounds" value="6" min="1" max="99" onchange="generateRoundSettings()" class="w-full p-2 border-2 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">Round End Timer (sec)</label>
                        <input type="number" id="roundEndTimer" value="10" min="1" max="999" class="w-full p-2 border-2 rounded-lg">
                        <p class="text-xs text-gray-600 mt-1">Trajanje "Ide≈° u sljedeƒái krug" ekrana</p>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">Novi Krug Timer (sec)</label>
                        <input type="number" id="noviKrugTimer" value="5" min="1" max="999" class="w-full p-2 border-2 rounded-lg">
                        <p class="text-xs text-gray-600 mt-1">ƒåekanje prije prvog pitanja novog kruga</p>
                    </div>
                </div>
            </div>

            <!-- UI Settings -->
            <div class="mb-6">
                <h3 class="text-xl font-bold mb-3" style="color: #ea580c;">UI Settings</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="showHeaderBar" checked class="w-5 h-5">
                            <span class="text-sm font-bold">Show Header Bar (trenutni + cutoff igraƒç)</span>
                        </label>
                        <p class="text-xs text-gray-600 mt-1 ml-7">Prikazuje se SAMO u leaderboard fazi (pause) ispod timera</p>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">Leaderboard Position</label>
                        <select id="leaderboardPosition" class="w-full p-2 border-2 rounded-lg">
                            <option value="bottom">Bottom (below questions)</option>
                            <option value="top">Top (above questions)</option>
                        </select>
                        <p class="text-xs text-gray-600 mt-1">Pozicija tablice tijekom svih faza odgovaranja</p>
                    </div>
                </div>
            </div>

            <!-- Round Settings -->
            <div class="mb-6">
                <h3 class="text-xl font-bold mb-3" style="color: #ea580c;">Settings po Krugovima</h3>
                <div id="roundSettings">
                    <!-- Dynamically generated -->
                </div>
            </div>

            <!-- Questions Management -->
            <div class="mb-6">
                <h3 class="text-xl font-bold mb-3" style="color: #ea580c;">üìù Upravljanje Pitanjima</h3>
                
                <!-- Questions List -->
                <div class="mb-4 p-4 rounded-lg max-h-96 overflow-y-auto" style="background: #f5e6d3;">
                    <h4 class="font-bold mb-2">Dodana pitanja (<span id="questionCount2">0</span>):</h4>
                    <div id="questionsList" class="space-y-2 text-sm">
                        <!-- Dynamically populated -->
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-2">Uƒçitaj CSV File</label>
                    <input type="file" id="csvFile" accept=".csv" onchange="loadCSV()" class="w-full p-2 border-2 rounded-lg">
                    <p class="text-xs text-gray-600 mt-1">Format: round,text,answer_a,answer_b,answer_c,answer_d,correct</p>
                </div>
                
                <!-- Manual Add Question -->
                <div id="addQuestionForm" class="hidden mt-4 p-4 rounded-lg" style="background: #f5e6d3;">
                    <h4 class="font-bold mb-3">Novo Pitanje:</h4>
                    <input type="text" id="newQuestionText" placeholder="Tekst pitanja..." class="w-full p-2 border-2 rounded-lg mb-2">
                    <input type="text" id="newAnswerA" placeholder="Odgovor A" class="w-full p-2 border-2 rounded-lg mb-2">
                    <input type="text" id="newAnswerB" placeholder="Odgovor B" class="w-full p-2 border-2 rounded-lg mb-2">
                    <input type="text" id="newAnswerC" placeholder="Odgovor C" class="w-full p-2 border-2 rounded-lg mb-2">
                    <input type="text" id="newAnswerD" placeholder="Odgovor D" class="w-full p-2 border-2 rounded-lg mb-2">
                    <div class="flex gap-2">
                        <select id="newQuestionRound" class="p-2 border-2 rounded-lg">
                            <option value="1">Krug 1</option>
                            <option value="2">Krug 2</option>
                            <option value="3">Krug 3</option>
                            <option value="4">Krug 4</option>
                            <option value="5">Krug 5</option>
                            <option value="6">Krug 6</option>
                        </select>
                        <select id="newQuestionCorrect" class="p-2 border-2 rounded-lg">
                            <option value="0">A - Toƒçan</option>
                            <option value="1">B - Toƒçan</option>
                            <option value="2">C - Toƒçan</option>
                            <option value="3">D - Toƒçan</option>
                        </select>
                        <button onclick="addQuestionManually()" class="px-4 py-2 bg-green-600 text-white rounded-lg">Dodaj</button>
                        <button onclick="toggleAddQuestion()" class="px-4 py-2 bg-gray-400 text-white rounded-lg">Odustani</button>
                    </div>
                </div>
                
                <button onclick="toggleAddQuestion()" id="btnShowAddQuestion" class="px-4 py-2 btn-primary text-white rounded-lg">
                    ‚ûï Add Question Ruƒçno
                </button>
            </div>

            <div class="flex gap-3">
                <button onclick="saveSettings()" class="flex-1 py-3 btn-primary text-white rounded-lg font-bold">
                    üíæ Spremi Settings
                </button>
                <button onclick="toggleSettings()" class="flex-1 py-3 bg-gray-300 hover:bg-gray-400 rounded-lg font-bold">
                    Odustani
                </button>
            </div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        let gameState = null;
        let players = {};
        let settings = {};
        let questions = [];
        let answers = {};
        let timerInterval = null;
        let serverTimeOffset = 0;
        let previousScores = {}; // Za praƒáenje promjena

        // Get server time offset for sync
        database.ref('.info/serverTimeOffset').on('value', snap => {
            serverTimeOffset = snap.val() || 0;
            console.log('‚è∞ Admin server time offset:', serverTimeOffset);
        });

        // Initialize default settings
        const defaultSettings = {
            quizNameSuffix: "DANA",
            password: "1234",
            minPlayers: 2,
            maxPlayers: 8,
            numRounds: 6,
            roundEndTimer: 10,
            noviKrugTimer: 5,
            rounds: [
                { questions: 10, values: [10, 5, 0, -5, -10], elimination: 2, time1: 20, time2: 5, timeAnswer: 5, timePause: 45, pauseRound: "manual" },
                { questions: 10, values: [20, 10, 0, -10, -20], elimination: 1, time1: 20, time2: 5, timeAnswer: 5, timePause: 45, pauseRound: "manual" },
                { questions: 10, values: [30, 15, 0, -15, -30], elimination: 1, time1: 20, time2: 5, timeAnswer: 5, timePause: 45, pauseRound: "manual" },
                { questions: 10, values: [40, 20, 0, -20, -40], elimination: 1, time1: 20, time2: 5, timeAnswer: 5, timePause: 45, pauseRound: "manual" },
                { questions: 10, values: [50, 25, 0, -25, -50], elimination: 1, time1: 20, time2: 5, timeAnswer: 5, timePause: 45, pauseRound: "manual" },
                { questions: 10, values: [100, 50, 0, -50, -100], elimination: 1, time1: 20, time2: 5, timeAnswer: 5, timePause: 45, pauseRound: "manual" }
            ]
        };

        // Firebase listeners
        database.ref('settings').on('value', snap => {
            settings = snap.val() || defaultSettings;
            console.log('üì• Settings loaded from Firebase:', settings);
            if (settings.rounds && settings.rounds[0]) {
                console.log('Round 1 settings:', {
                    skipCunning: settings.rounds[0].skipCunning,
                    earlyContinue: settings.rounds[0].earlyContinue
                });
            }
            updateSettingsUI();
        });

        database.ref('gameState').on('value', snap => {
            const oldPhase = gameState?.phase;
            gameState = snap.val();
            
            // Zapamti scorove prije showAnswer faze
            if (oldPhase !== 'showAnswer' && gameState?.phase === 'showAnswer') {
                previousScores = {};
                Object.entries(players).forEach(([id, data]) => {
                    previousScores[id] = data.score || 0;
                });
            }
            
            // Handle roundEnd phase - auto-kick and auto-next-round
            if (oldPhase !== 'roundEnd' && gameState?.phase === 'roundEnd') {
                console.log('üèÅ Round ended, processing...');
                
                const currentRound = settings.rounds?.[gameState.currentRound - 1];
                
                // Auto-kick players if enabled (with 2s delay so players can see roundEnd screen)
                if (currentRound?.autoKickPlayers) {
                    // Izraƒçunaj koliko igraƒça ostaje
                    let remainingCount;
                    if (currentRound.remainingType === 'percent') {
                        // Postotak od trenutnog broja igraƒça
                        database.ref('players').once('value').then(snap => {
                            const players = snap.val() || {};
                            const activePlayers = Object.values(players).filter(p => !p.eliminated).length;
                            remainingCount = Math.max(1, Math.floor(activePlayers * currentRound.remainingValue / 100));
                            console.log(`üö´ Will auto-kick players outside TOP ${remainingCount} (${currentRound.remainingValue}% of ${activePlayers}) in 2s...`);
                            
                            setTimeout(() => {
                                console.log('üö´ Now kicking players...');
                                autoKickPlayers(remainingCount);
                            }, 2000);
                        });
                    } else {
                        // Fiksni broj
                        remainingCount = currentRound.remainingValue ?? currentRound.remainingPlayers ?? currentRound.playersRemaining ?? 50;
                        console.log('üö´ Will auto-kick players outside TOP', remainingCount, 'in 2s...');
                        
                        setTimeout(() => {
                            console.log('üö´ Now kicking players...');
                            autoKickPlayers(remainingCount);
                        }, 2000);
                    }
                }
                
                // Auto next round if enabled (total 7s: 2s for kick message + 5s for next round)
                if (currentRound?.autoNextRound) {
                    console.log('‚è≠Ô∏è Auto next round enabled, waiting 7s...');
                    setTimeout(() => {
                        database.ref('gameState').once('value').then(snap => {
                            const state = snap.val();
                            if (state?.phase === 'roundEnd') {
                                console.log('‚ñ∂Ô∏è Auto starting next round');
                                nextRound();
                            }
                        });
                    }, 7000); // 7s total (2s kick + 5s view)
                }
            }
            
            updateUI();
        });

        database.ref('players').on('value', snap => {
            players = snap.val() || {};
            updateLeaderboard();
        });

        database.ref('questions').on('value', snap => {
            questions = snap.val() || [];
            updateQuestionsList();
        });

        database.ref('answers').on('value', snap => {
            answers = snap.val() || {};
            updateCurrentAnswers();
            checkAutoContinue();
        });
        
        function checkAutoContinue() {
            if (!gameState || !settings.rounds || !players) {
                console.log('‚ùå AUTO-CONTINUE: Missing data', {gameState: !!gameState, settings: !!settings.rounds, players: !!players});
                return;
            }
            
            const phase = gameState.phase;
            const currentRound = settings.rounds[gameState.currentRound - 1];
            
            console.log('üîç AUTO-CONTINUE CHECK:', {
                phase: phase,
                roundIndex: gameState.currentRound - 1,
                hasRound: !!currentRound,
                earlyContinue: currentRound?.earlyContinue,
                skipCunning: currentRound?.skipCunning
            });
            
            // Only check in answering or cunning phase
            if (phase !== 'answering' && phase !== 'cunning') {
                console.log('‚ùå AUTO-CONTINUE: Not in answering/cunning phase');
                return;
            }
            
            // Check if this round has earlyContinue enabled
            if (!currentRound || !currentRound.earlyContinue) {
                console.log('‚ùå AUTO-CONTINUE: earlyContinue not enabled for this round');
                return;
            }
            
            const totalPlayers = Object.keys(players).length;
            const totalAnswers = Object.keys(answers).length;
            
            console.log('üìä AUTO-CONTINUE: Players:', totalPlayers, 'Answers:', totalAnswers);
            
            if (phase === 'answering') {
                // In answering phase, check if ALL players answered
                if (totalAnswers < totalPlayers) {
                    console.log('‚è≥ AUTO-CONTINUE: Waiting for more answers');
                    return;
                }
                
                console.log('üöÄ AUTO-CONTINUE: All players answered in answering phase!');
                
                // Check if anyone clicked ?
                const hasCunning = Object.values(answers).some(a => a.type === 'cunning');
                
                console.log('üìä Answer breakdown:');
                Object.entries(answers).forEach(([pid, data]) => {
                    console.log(`  Player ${pid}: type=${data.type}, answer=${data.answer}, pending=${data.pending}`);
                });
                console.log('‚ùì Has cunning:', hasCunning, 'Skip enabled:', currentRound.skipCunning);
                
                if (currentRound.skipCunning && !hasCunning) {
                    // Skip cunning ONLY if enabled AND no one clicked ?
                    console.log('‚è≠Ô∏è Skipping cunning (enabled AND no one clicked ?)');
                    goToShowAnswer();
                } else {
                    // Go to cunning if:
                    // 1. skipCunning is disabled (always go), OR
                    // 2. Someone clicked ?
                    console.log('‚úÖ Going to cunning phase');
                    goToCunningPhase();
                }
            } else if (phase === 'cunning') {
                // In cunning phase, check if all players answered
                const activePlayers = Object.keys(players);
                const answeredPlayers = Object.keys(answers);
                
                // Count how many pending players still need to answer
                const pendingPlayers = answeredPlayers.filter(pid => {
                    const ans = answers[pid];
                    return ans && ans.pending === true;
                });
                
                console.log('‚è≥ Cunning check:', {
                    activePlayers: activePlayers.length,
                    answeredPlayers: answeredPlayers.length,
                    pendingPlayers: pendingPlayers.length
                });
                
                // If there are pending players still waiting, don't continue
                if (pendingPlayers.length > 0) return;
                
                // If ALL active players have answers (pending or not), continue
                if (answeredPlayers.length < activePlayers.length) return;
                
                console.log('üöÄ AUTO-CONTINUE: All cunning players answered!');
                console.log('‚Üí Going to showAnswer (NO auto-answer, players already chose)');
                // DON'T call autoAnswerPendingPlayers() - players already answered in cunning!
                showCorrectAnswer();
            }
        }
        
        function goToCunningPhase() {
            // Call existing showCunningPhase function
            showCunningPhase();
        }
        
        function goToShowAnswer() {
            // Auto-answer any pending players first
            autoAnswerPendingPlayers();
            // Call existing showCorrectAnswer function
            showCorrectAnswer();
        }

        function updateUI() {
            if (!gameState) return;
            
            document.getElementById('gameStatus').textContent = 
                gameState.phase === 'waiting' ? 'Waiting' :
                gameState.phase === 'answering' ? 'Odgovaranje' :
                gameState.phase === 'cunning' ? 'Cunning Faza' :
                gameState.phase === 'showAnswer' ? 'Prikaz Odgovora' : 'Pause';
            
            document.getElementById('currentRound').textContent = gameState.currentRound || 1;
            document.getElementById('currentQuestion').textContent = (gameState.currentQuestion || 0) + 1;
            document.getElementById('playerCount').textContent = Object.keys(players).length;
            document.getElementById('maxPlayers').textContent = settings.maxPlayers || 8;

            // Timer
            if (gameState.timerEnd) {
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(updateTimer, 100);
            }
        }

        function updateTimer() {
            if (!gameState || !gameState.timerEnd) {
                document.getElementById('timerDisplay').textContent = '--';
                return;
            }
            const serverNow = Date.now() + serverTimeOffset;
            const timeLeft = Math.max(0, Math.ceil((gameState.timerEnd - serverNow) / 1000));
            document.getElementById('timerDisplay').textContent = timeLeft + 's';
            if (timeLeft === 0) clearInterval(timerInterval);
        }

        function updateLeaderboard() {
            const sorted = Object.entries(players)
                .map(([id, data]) => ({ id, ...data }))
                .sort((a, b) => {
                    if (b.score !== a.score) return b.score - a.score;
                    if (b.cunningCount !== a.cunningCount) return b.cunningCount - a.cunningCount;
                    if (b.exclamationCount !== a.exclamationCount) return b.exclamationCount - a.exclamationCount;
                    return a.totalTime - b.totalTime;
                });

            const html = sorted.map((player, idx) => {
                const timeInSeconds = Math.floor((player.totalTime || 0) / 1000);
                const currentScore = player.score || 0;
                const previousScore = previousScores[player.id] || currentScore;
                const scoreDiff = currentScore - previousScore;
                
                // Prika≈æi odgovor igraƒça ili razliku u scoreovima
                const answer = answers[player.id];
                let extraDisplay = '';
                
                if (gameState?.phase === 'answering' || gameState?.phase === 'cunning' || gameState?.phase === 'pause') {
                    // Prika≈æi odgovor
                    if (answer) {
                        const answerLabel = answer.answer >= 0 ? String.fromCharCode(65 + answer.answer) : '?';
                        const typeSymbol = answer.type === 'exclamation' ? '!' : answer.type === 'period' ? '.' : '?';
                        extraDisplay = `<span class="text-sm font-bold ml-2">${answerLabel}${typeSymbol}</span>`;
                    }
                } else if (gameState?.phase === 'showAnswer') {
                    // Prika≈æi razliku u cijeni
                    if (scoreDiff !== 0) {
                        const color = scoreDiff > 0 ? '#10b981' : '#ef4444';
                        const sign = scoreDiff > 0 ? '+' : '';
                        extraDisplay = `<span style="color: ${color}; font-weight: bold; margin-left: 8px;">(${sign}${scoreDiff}‚Ç¨)</span>`;
                    }
                }
                
                return `
                <div class="flex justify-between items-center p-3 rounded-lg" style="background: #f5e6d3;">
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-xl" style="color: #ea580c;">${idx + 1}.</span>
                        <span class="font-bold">${player.name}</span>
                        ${extraDisplay}
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-bold" style="color: #ea580c;">${currentScore}‚Ç¨</span>
                        <span class="text-sm text-gray-600">${player.cunningCount || 0}?</span>
                        <span class="text-sm text-gray-600">${player.exclamationCount || 0}!</span>
                        <span class="text-xs text-gray-600">‚è±Ô∏è${timeInSeconds}s</span>
                        <button onclick="kickPlayer('${player.id}', '${player.name}')" 
                                class="text-red-600 hover:text-red-800 font-bold text-sm">
                            ‚ùå
                        </button>
                    </div>
                </div>
            `}).join('');
            document.getElementById('leaderboard').innerHTML = html || '<p class="text-gray-500">No players</p>';
        }

        function updateCurrentAnswers() {
            const currentPhase = gameState?.phase || 'waiting';
            
            const html = Object.entries(answers).map(([pid, data]) => {
                const player = players[pid];
                if (!player) return '';
                
                // U answering fazi - ako je pending (ƒçeka cunning fazu)
                if (currentPhase === 'answering' && data.pending && data.answer === -1) {
                    return `
                        <div class="flex justify-between items-center p-2 rounded" style="background: #a855f7;">
                            <span class="font-bold text-white">${player.name}</span>
                            <span class="font-bold text-white text-xl">?</span>
                        </div>
                    `;
                }
                
                // U cunning/showAnswer fazi - prika≈æi A? B? C? D? ako je odgovorio
                const answerLabel = data.answer >= 0 ? String.fromCharCode(65 + data.answer) : '?';
                const typeSymbol = data.type === 'exclamation' ? '!' : data.type === 'period' ? '.' : '?';
                
                let bgColor = data.type === 'exclamation' ? '#ef4444' : data.type === 'period' ? '#3b82f6' : '#a855f7';
                
                // U showAnswer fazi, oboji po toƒçnosti
                if (currentPhase === 'showAnswer' && questions[gameState.currentQuestion]) {
                    const correct = data.answer === questions[gameState.currentQuestion].correct;
                    bgColor = correct ? '#10b981' : '#ef4444';
                }
                
                // Ako je cunning i veƒá odgovorio, prika≈æi A? B? C? D?
                const displayText = data.type === 'cunning' && data.answer >= 0 ? 
                    `${answerLabel}${typeSymbol}` : 
                    data.pending ? '?' : `${answerLabel}${typeSymbol}`;
                
                return `
                    <div class="flex justify-between items-center p-2 rounded" style="background: ${bgColor};">
                        <span class="font-bold text-white">${player.name}</span>
                        <span class="font-bold text-white">${displayText}</span>
                    </div>
                `;
            }).join('');
            document.getElementById('currentAnswers').innerHTML = html || '<p class="text-gray-500">Nema odgovora</p>';
        }

        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                generateRoundSettings();
            }
        }

        function generateRoundSettings() {
            const numRounds = parseInt(document.getElementById('numRounds').value);
            const container = document.getElementById('roundSettings');
            let html = '';
            
            console.log('üîß Generating round settings, current settings:', settings);

            for (let i = 0; i < numRounds; i++) {
                const round = settings.rounds?.[i] || defaultSettings.rounds[i] || defaultSettings.rounds[0];
                console.log(`Round ${i+1} data:`, {
                    skipCunning: round.skipCunning,
                    earlyContinue: round.earlyContinue,
                    source: settings.rounds?.[i] ? 'settings' : 'default'
                });
                html += `
                    <div class="mb-4 p-4 rounded-lg" style="background: #f5e6d3;">
                        <h4 class="font-bold mb-3" style="color: #ea580c;">${i + 1}. KRUG</h4>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs">Broj pitanja</label>
                                <input type="number" id="round${i}_questions" value="${round.questions}" class="w-full p-1 border rounded">
                            </div>
                            <div>
                                <label class="text-xs">Igraƒça ostaje</label>
                                <div class="flex gap-1">
                                    <input type="number" id="round${i}_remaining" value="${round.remainingValue || round.remainingPlayers || round.playersRemaining || 50}" class="w-full p-1 border rounded" style="flex: 2;">
                                    <select id="round${i}_remainingType" class="p-1 border rounded" style="flex: 1;">
                                        <option value="number" ${(round.remainingType || 'number') === 'number' ? 'selected' : ''}>br.</option>
                                        <option value="percent" ${round.remainingType === 'percent' ? 'selected' : ''}>%</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs flex items-center gap-1">
                                    <input type="checkbox" id="round${i}_autoKick" ${round.autoKickPlayers ? 'checked' : ''}>
                                    Auto izbaci izvan TOPa
                                </label>
                            </div>
                            <div>
                                <label class="text-xs">Time ! i . (s)</label>
                                <input type="number" id="round${i}_time1" value="${round.time1}" class="w-full p-1 border rounded">
                            </div>
                            <div>
                                <label class="text-xs">Time ? (s)</label>
                                <input type="number" id="round${i}_time2" value="${round.time2}" class="w-full p-1 border rounded">
                            </div>
                            <div>
                                <label class="text-xs">Prikaz odg. (s)</label>
                                <input type="number" id="round${i}_timeAnswer" value="${round.timeAnswer}" class="w-full p-1 border rounded">
                            </div>
                            <div>
                                <label class="text-xs">Pause (s)</label>
                                <input type="number" id="round${i}_timePause" value="${round.timePause}" class="w-full p-1 border rounded">
                            </div>
                            <div>
                                <label class="text-xs flex items-center gap-1">
                                    <input type="checkbox" id="round${i}_autoSkip" ${round.skipCunning ? 'checked' : ''}>
                                    Skip ? ako nema
                                </label>
                            </div>
                            <div>
                                <label class="text-xs flex items-center gap-1">
                                    <input type="checkbox" id="round${i}_autoContinue" ${round.earlyContinue ? 'checked' : ''}>
                                    Auto kad svi odgovore
                                </label>
                            </div>
                            <div>
                                <label class="text-xs flex items-center gap-1">
                                    <input type="checkbox" id="round${i}_autoNextRound" ${round.autoNextRound ? 'checked' : ''}>
                                    Auto sljedeƒái krug
                                </label>
                            </div>
                        </div>
                        <div class="mt-2">
                            <label class="text-xs">Vrijednosti (!, ., netoƒçno ., netoƒçno ?, netoƒçno !)</label>
                            <div class="grid grid-cols-5 gap-2">
                                <input type="number" id="round${i}_val0" value="${round.values[0]}" placeholder="+!" class="w-full p-1 border rounded">
                                <input type="number" id="round${i}_val1" value="${round.values[1]}" placeholder="+." class="w-full p-1 border rounded">
                                <input type="number" id="round${i}_val2" value="${round.values[2]}" placeholder="-." class="w-full p-1 border rounded">
                                <input type="number" id="round${i}_val3" value="${round.values[3]}" placeholder="-?" class="w-full p-1 border rounded">
                                <input type="number" id="round${i}_val4" value="${round.values[4]}" placeholder="-!" class="w-full p-1 border rounded">
                            </div>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function updateSettingsUI() {
            document.getElementById('quizNameSuffix').value = settings.quizNameSuffix || "DANA";
            document.getElementById('quizPassword').value = settings.password || "1234";
            document.getElementById('minPlayers').value = settings.minPlayers || 2;
            document.getElementById('maxPlayersInput').value = settings.maxPlayers || 8;
            document.getElementById('numRounds').value = settings.numRounds || 6;
            document.getElementById('roundEndTimer').value = settings.roundEndTimer || 10;
            document.getElementById('noviKrugTimer').value = settings.noviKrugTimer || 5;
            document.getElementById('showHeaderBar').checked = settings.showHeaderBar !== undefined ? settings.showHeaderBar : true;
            document.getElementById('leaderboardPosition').value = settings.leaderboardPosition || 'bottom';
        }

        function saveSettings() {
            const numRounds = parseInt(document.getElementById('numRounds').value);
            const rounds = [];

            for (let i = 0; i < numRounds; i++) {
                const autoSkipChecked = document.getElementById(`round${i}_autoSkip`).checked;
                const autoContinueChecked = document.getElementById(`round${i}_autoContinue`).checked;
                const autoKickChecked = document.getElementById(`round${i}_autoKick`).checked;
                const autoNextRoundChecked = document.getElementById(`round${i}_autoNextRound`).checked;
                
                console.log(`Round ${i+1}: skipCunning=${autoSkipChecked}, earlyContinue=${autoContinueChecked}, autoKick=${autoKickChecked}, autoNextRound=${autoNextRoundChecked}`);
                
                const remainingType = document.getElementById(`round${i}_remainingType`).value;
                const remainingValue = parseInt(document.getElementById(`round${i}_remaining`).value);
                
                rounds.push({
                    questions: parseInt(document.getElementById(`round${i}_questions`).value),
                    remainingType: remainingType,  // 'number' ili 'percent'
                    remainingValue: remainingValue,  // broj ili postotak
                    // Legacy polja za kompatibilnost
                    remainingPlayers: remainingValue,
                    playersRemaining: remainingValue,
                    autoKickPlayers: autoKickChecked,
                    autoNextRound: autoNextRoundChecked,
                    time1: parseInt(document.getElementById(`round${i}_time1`).value),
                    time2: parseInt(document.getElementById(`round${i}_time2`).value),
                    timeAnswer: parseInt(document.getElementById(`round${i}_timeAnswer`).value),
                    timePause: parseInt(document.getElementById(`round${i}_timePause`).value),
                    pauseRound: "auto",  // Auto-continue after pause
                    skipCunning: autoSkipChecked,
                    earlyContinue: autoContinueChecked,
                    value1: parseInt(document.getElementById(`round${i}_val0`).value),  // For player.html header
                    values: [
                        parseInt(document.getElementById(`round${i}_val0`).value),
                        parseInt(document.getElementById(`round${i}_val1`).value),
                        parseInt(document.getElementById(`round${i}_val2`).value),
                        parseInt(document.getElementById(`round${i}_val3`).value),
                        parseInt(document.getElementById(`round${i}_val4`).value)
                    ]
                });
            }

            const newSettings = {
                quizNameSuffix: document.getElementById('quizNameSuffix').value,
                password: document.getElementById('quizPassword').value,
                minPlayers: parseInt(document.getElementById('minPlayers').value),
                maxPlayers: parseInt(document.getElementById('maxPlayersInput').value),
                numRounds: numRounds,
                roundEndTimer: parseInt(document.getElementById('roundEndTimer').value),
                noviKrugTimer: parseInt(document.getElementById('noviKrugTimer').value),
                rounds: rounds,
                showHeaderBar: document.getElementById('showHeaderBar').checked,
                leaderboardPosition: document.getElementById('leaderboardPosition').value
            };
            
            console.log('üíæ Saving settings:', JSON.stringify(newSettings, null, 2));

            // Update local settings variable IMMEDIATELY
            settings = newSettings;

            database.ref('settings').set(newSettings).then(() => {
                console.log('‚úÖ Settings saved to Firebase successfully!');
                alert('‚úÖ Settings spremljene!');
                toggleSettings();
            }).catch(error => {
                console.error('‚ùå Error saving settings:', error);
                alert('‚ùå Gre≈°ka pri spremanju: ' + error.message);
            });
        }

        function startGame() {
            if (Object.keys(players).length < (settings.minPlayers || 2)) {
                alert(`Potrebno je minimalno ${settings.minPlayers || 2} igraƒça!`);
                return;
            }
            database.ref('gameState').set({
                phase: 'waiting',
                currentRound: 1,
                currentQuestion: 0,
                isActive: true,
                autoMode: true,
                timerEnd: null
            });
            
            // AUTO: Pokreni prvo pitanje nakon 3s
            setTimeout(() => {
                database.ref('gameState').once('value').then(snap => {
                    const state = snap.val();
                    if (state.autoMode) startQuestion();
                });
            }, 3000);
        }

        function pauseGame() {
            database.ref('gameState').update({ 
                autoMode: false,
                phase: 'paused', 
                timerEnd: null 
            });
        }

        function resumeGame() {
            database.ref('gameState').update({ 
                autoMode: true,
                phase: 'waiting'
            });
            setTimeout(() => {
                if (gameState.autoMode) startQuestion();
            }, 2000);
        }

        function startQuestion() {
            const round = settings.rounds[gameState.currentRound - 1];
            
            // Koristi server timestamp za sinkronizaciju
            database.ref('.info/serverTimeOffset').once('value').then(offsetSnap => {
                const offset = offsetSnap.val() || 0;
                const serverTime = Date.now() + offset;
                
                database.ref('gameState').update({
                    phase: 'answering',
                    timerEnd: serverTime + (round.time1 * 1000),
                    autoMode: true
                });
                database.ref('answers').set({});
                
                // AUTO: Nakon 20s -> provjeri da li ima cunning odgovora
                setTimeout(() => {
                    database.ref('gameState').once('value').then(snap => {
                        const state = snap.val();
                        // STRICT CHECK: mora biti I autoMode I jo≈° uvijek u answering fazi
                        if (state && state.autoMode && state.phase === 'answering') {
                            console.log('‚è∞ Answering timer expired, checking for cunning...');
                            
                            // Get active players
                            database.ref('players').once('value').then(playersSnap => {
                                const allPlayers = playersSnap.val() || {};
                                const activePlayers = Object.keys(allPlayers).filter(pid => !allPlayers[pid].eliminated);
                                
                                database.ref('answers').once('value').then(answersSnap => {
                                    const answers = answersSnap.val() || {};
                                    const hasCunning = Object.values(answers).some(a => a.type === 'cunning');
                                    const hasUnanswered = activePlayers.some(pid => !answers[pid]);
                                    
                                    console.log('üìä Timer - Answer breakdown:');
                                    console.log('Active players:', activePlayers.length);
                                    console.log('Answered:', Object.keys(answers).length);
                                    Object.entries(answers).forEach(([pid, data]) => {
                                        console.log(`  Player ${pid}: type=${data.type}, answer=${data.answer}`);
                                    });
                                    console.log('‚ùì Timer - Has cunning:', hasCunning, 'Has unanswered:', hasUnanswered, 'Skip:', round.skipCunning);
                                    
                                    // Ako netko NIJE odgovorio ili netko je kliknuo ?, IDE SE U CUNNING FAZU
                                    if (hasUnanswered || hasCunning) {
                                        console.log('‚úÖ Timer - Going to cunning phase (someone didnt answer or clicked ?)');
                                        showCunningPhase();
                                    } else if (round.skipCunning && !hasCunning) {
                                        // Skip ONLY if enabled AND no one clicked ? AND everyone answered
                                        console.log('‚è≠Ô∏è Timer - Skipping cunning (everyone answered, no ?)');
                                        autoAnswerPendingPlayers();
                                        showCorrectAnswer();
                                    } else {
                                        // Default: go to cunning
                                        console.log('‚úÖ Timer - Going to cunning phase (default)');
                                        showCunningPhase();
                                    }
                                });
                            });
                        } else {
                            console.log('‚è≠Ô∏è Skipping answering timer - already moved to', state?.phase);
                        }
                    });
                }, round.time1 * 1000);
            });
        }

        function showCunningPhase() {
            const round = settings.rounds[(gameState.currentRound || 1) - 1];
            if (!round) return;
            
            console.log('üëÅÔ∏è Starting Cunning phase');
            
            // Auto-assign ? to players who didn't answer - SA RELATIVNIM VREMENOM
            database.ref('players').once('value').then(playersSnap => {
                const allPlayers = playersSnap.val() || {};
                database.ref('answers').once('value').then(answersSnap => {
                    const answers = answersSnap.val() || {};
                    
                    // Za svakog AKTIVNOG igraƒça koji nije odgovorio, dodaj "pending cunning"
                    Object.keys(allPlayers).forEach(pid => {
                        const player = allPlayers[pid];
                        
                        // Skip eliminated players - they don't participate anymore
                        if (player.eliminated) {
                            console.log('‚è≠Ô∏è Skipping eliminated player:', player.name);
                            return;
                        }
                        
                        if (!answers[pid]) {
                            console.log('‚ö†Ô∏è Player', player.name, 'didnt answer - auto cunning pending');
                            
                            database.ref(`answers/${pid}`).set({
                                answer: -1,
                                type: 'cunning',
                                pending: true,
                                timestamp: round.time1 * 1000 // Potro≈°io je svih time1 sekundi - calculateScores ƒáe ƒçitati ovo
                            });
                            
                            console.log('  ‚Üí timestamp set to', round.time1 * 1000, 'ms - calculateScores ƒáe dodati totalTime');
                        }
                    });
                });
            });
            
            // Koristi server timestamp
            database.ref('.info/serverTimeOffset').once('value').then(offsetSnap => {
                const offset = offsetSnap.val() || 0;
                const serverTime = Date.now() + offset;
                
                database.ref('gameState').update({
                    phase: 'cunning',
                    timerEnd: serverTime + (round.time2 * 1000)
                });
                
                // AUTO: Nakon 5s -> prikaz toƒçnog odgovora (samo ako smo jo≈° u cunning fazi)
                setTimeout(() => {
                    database.ref('gameState').once('value').then(snap => {
                        const state = snap.val();
                        // STRICT CHECK: mora biti I autoMode I toƒçno u cunning fazi
                        if (state && state.autoMode && state.phase === 'cunning') {
                            console.log('‚úÖ Auto showing correct answer from cunning timer');
                            
                            // Svi koji jo≈° nisu odgovorili dobivaju random netoƒçan odgovor
                            autoAnswerPendingPlayers();
                            
                            showCorrectAnswer();
                        } else {
                            console.log('‚è≠Ô∏è Skipping cunning timer - already moved to', state?.phase);
                        }
                    });
                }, round.time2 * 1000);
            });
        }

        function autoAnswerPendingPlayers() {
            console.log('ü§ñ autoAnswerPendingPlayers called, phase:', gameState.phase);
            
            database.ref('players').once('value').then(playersSnap => {
                const allPlayers = playersSnap.val() || {};
                
                database.ref('answers').once('value').then(snap => {
                    const answers = snap.val() || {};
                    const currentQ = questions[(gameState.currentQuestion || 0)];
                    if (!currentQ) return;
                    
                    console.log('üìã All answers:', answers);
                    
                    Object.entries(answers).forEach(([pid, data]) => {
                        // Skip eliminated players
                        if (allPlayers[pid]?.eliminated) {
                            console.log('‚è≠Ô∏è Skipping eliminated player:', pid);
                            return;
                        }
                        
                        console.log(`Player ${pid}:`, {
                            pending: data.pending,
                            answer: data.answer,
                            phase2Answer: data.phase2Answer
                        });
                        
                        // Auto-answer SAMO ako:
                        // 1. pending === true (nije zavr≈°io odgovaranje)
                        // 2. answer === -1 (nije odabrao konkretan odgovor)
                        // 3. NEMA phase2Answer (nije kliknuo A?/B?/C?/D? u cunning fazi)
                        if (data.pending && data.answer === -1 && data.phase2Answer === undefined) {
                            // Daj random NETOƒåAN odgovor sa cunning tipom (A?, B?, C?, D?)
                            let wrongAnswer = 0;
                            while (wrongAnswer === currentQ.correct && wrongAnswer < 4) {
                                wrongAnswer++;
                            }
                            if (wrongAnswer >= 4) wrongAnswer = (currentQ.correct + 1) % 4;
                            
                            console.log('‚ö†Ô∏è Auto-answering for player', pid, 'with wrong cunning answer', wrongAnswer, '?');
                            
                            database.ref(`answers/${pid}`).update({
                                answer: wrongAnswer,
                                type: 'cunning',  // Tip je cunning za minus bodove
                                pending: false,
                                phase2Answer: wrongAnswer,
                                phase2Type: 'cunning'
                            });
                            
                            // Dodaj cunningCount jer je dobio auto ? odgovor
                            console.log('‚≠ê Auto-incrementing cunningCount for player', pid);
                            database.ref(`players/${pid}/cunningCount`).transaction(val => {
                                const oldVal = val || 0;
                                const newVal = oldVal + 1;
                                console.log('  ‚Üí cunningCount transaction:', oldVal, '‚Üí', newVal);
                                return newVal;
                            });
                        } else if (data.pending && data.phase2Answer !== undefined) {
                            console.log('‚è≠Ô∏è Skipping auto-answer for player', pid, '- already chose in cunning phase');
                        } else {
                            console.log('‚úÖ Player', pid, 'already answered or no auto-answer needed');
                        }
                    });
                });
            });
        }

        function showCorrectAnswer() {
            const round = settings.rounds[(gameState.currentRound || 1) - 1];
            if (!round) return;
            
            console.log('üìä Showing correct answer');
            
            // PROVJERA: Je li ovo zadnje pitanje u krugu?
            const currentQuestionNum = (gameState.currentQuestion || 0) + 1;
            const totalQuestionsInRound = round.questions || 10;
            const isLastQuestion = currentQuestionNum >= totalQuestionsInRound;
            
            console.log('üîç SHOW ANSWER CHECK:', {
                currentQuestionNum,
                totalQuestionsInRound,
                isLastQuestion
            });
            
            // Koristi server timestamp
            database.ref('.info/serverTimeOffset').once('value').then(offsetSnap => {
                const offset = offsetSnap.val() || 0;
                const serverTime = Date.now() + offset;
                
                database.ref('gameState').update({
                    phase: 'showAnswer',
                    timerEnd: serverTime + (round.timeAnswer * 1000)
                });
                calculateScores();
                
                if (isLastQuestion) {
                    // ZADNJE PITANJE - preskoƒçi pause, idi direktno na roundEnd
                    console.log('‚è≠Ô∏è ADMIN: Zadnje pitanje - after showAnswer, going directly to roundEnd (skip pause)');
                    setTimeout(() => {
                        database.ref('gameState').once('value').then(snap => {
                            const state = snap.val();
                            if (state && state.autoMode && state.phase === 'showAnswer') {
                                console.log('üèÅ Calling nextQuestion which will set roundEnd');
                                nextQuestion(); // This will set phase: 'roundEnd'
                            }
                        });
                    }, round.timeAnswer * 1000);
                } else {
                    // NIJE zadnje - normalni flow sa pause
                    console.log(`‚è∞ Setting timeout for pause: ${round.timeAnswer}s`);
                    setTimeout(() => {
                        console.log('‚è∞ TIMEOUT REACHED - checking if should start pause');
                        database.ref('gameState').once('value').then(snap => {
                            const state = snap.val();
                            console.log('üìä Current state:', {
                                autoMode: state?.autoMode,
                                phase: state?.phase,
                                willStartPause: state && state.autoMode && state.phase === 'showAnswer'
                            });
                            if (state && state.autoMode && state.phase === 'showAnswer') {
                                console.log('‚è∏Ô∏è Auto starting pause');
                                startPause();
                            } else {
                                console.log('‚ùå NOT starting pause - conditions not met');
                            }
                        });
                    }, round.timeAnswer * 1000);
                }
            });
        }

        function startPause() {
            const round = settings.rounds[(gameState.currentRound || 1) - 1];
            if (!round) return;
            
            // PROVJERA: Je li ovo zadnje pitanje u krugu?
            const currentQuestionNum = (gameState.currentQuestion || 0) + 1;
            const totalQuestionsInRound = round.questions || 10;
            
            console.log('üîç START PAUSE CHECK:', {
                currentQuestionNum,
                totalQuestionsInRound,
                isLastQuestion: currentQuestionNum >= totalQuestionsInRound
            });
            
            if (currentQuestionNum >= totalQuestionsInRound) {
                console.log('‚è≠Ô∏è ADMIN: Zadnje pitanje - preskaƒçem pause, pozivam nextQuestion()');
                // Odmah pozovi nextQuestion koji ƒáe postaviti roundEnd
                setTimeout(() => nextQuestion(), 100);
                return;
            }
            
            console.log('‚è∏Ô∏è ADMIN: Starting pause (not last question)');
            
            // Koristi server timestamp
            database.ref('.info/serverTimeOffset').once('value').then(offsetSnap => {
                const offset = offsetSnap.val() || 0;
                const serverTime = Date.now() + offset;
                
                const timerEnd = round.pauseRound === 'manual' ? null : serverTime + (round.timePause * 1000);
                
                // Clear answers prije pause da se ne vide u leaderboardu
                database.ref('answers').set({});
                
                database.ref('gameState').update({
                    phase: 'pause',
                    timerEnd: timerEnd
                });
                
                // AUTO: Nakon pauze -> sljedeƒáe pitanje (ako nije manual)
                if (round.pauseRound !== 'manual') {
                    setTimeout(() => {
                        database.ref('gameState').once('value').then(snap => {
                            const state = snap.val();
                            if (state && state.autoMode && state.phase === 'pause') {
                                console.log('‚è≠Ô∏è Auto next question');
                                nextQuestion();
                            }
                        });
                    }, round.timePause * 1000);
                }
            });
        }

        function calculateScores() {
            const currentQ = questions[gameState.currentQuestion];
            const round = settings.rounds[gameState.currentRound - 1];
            
            console.log('üìä ========== calculateScores START ==========');
            console.log('Round:', gameState.currentRound, 'Question:', gameState.currentQuestion + 1);
            console.log('This is the ONLY place where totalTime gets added!');
            
            Object.entries(answers).forEach(([pid, data]) => {
                const correct = currentQ.correct === data.answer;
                let points = 0;
                
                if (data.type === 'exclamation') {
                    points = correct ? round.values[0] : round.values[4];
                } else if (data.type === 'period') {
                    points = correct ? round.values[1] : round.values[2];
                } else if (data.type === 'cunning') {
                    points = correct ? round.values[1] : round.values[3];
                }
                
                const player = players[pid];
                const timeToAdd = data.timestamp || 0;
                
                console.log(`‚è±Ô∏è ${player?.name || pid}:`);
                console.log(`   Type: ${data.type}`);
                console.log(`   Timestamp from answer: ${timeToAdd}ms (${(timeToAdd/1000).toFixed(1)}s)`);
                console.log(`   Current totalTime: ${player?.totalTime || 0}ms (${((player?.totalTime || 0)/1000).toFixed(1)}s)`);
                console.log(`   NEW totalTime: ${(player?.totalTime || 0) + timeToAdd}ms (${(((player?.totalTime || 0) + timeToAdd)/1000).toFixed(1)}s)`);
                
                database.ref(`players/${pid}`).update({
                    score: (player.score || 0) + points,
                    exclamationCount: (player.exclamationCount || 0) + (data.type === 'exclamation' ? 1 : 0),
                    totalTime: (player.totalTime || 0) + timeToAdd
                    // cunningCount se NE dodaje ovdje - dodaje se u autoAnswerPendingPlayers
                });
            });
            
            console.log('üìä ========== calculateScores END ==========');
        }

        function nextQuestion() {
            const round = settings.rounds[gameState.currentRound - 1];
            const nextQ = (gameState.currentQuestion || 0) + 1;
            
            console.log('üìå Next question:', nextQ, 'Round questions:', round.questions);
            
            // Provjera da li je kraj kruga
            if (nextQ >= round.questions) {
                console.log('üèÅ Kraj kruga!');
                
                // Keep autoMode if autoNextRound is enabled
                const keepAuto = round.autoNextRound === true;
                
                // Koristi server timestamp za roundEnd timer
                database.ref('.info/serverTimeOffset').once('value').then(offsetSnap => {
                    const offset = offsetSnap.val() || 0;
                    const serverTime = Date.now() + offset;
                    const roundEndTimer = settings.roundEndTimer || 10;
                    const timerEnd = serverTime + (roundEndTimer * 1000);
                    
                    database.ref('gameState').update({
                        phase: 'roundEnd',
                        timerEnd: timerEnd,
                        autoMode: keepAuto
                    });
                    console.log('üîß RoundEnd autoMode:', keepAuto, 'Timer:', roundEndTimer + 's');
                    
                    // AUTO: Nakon roundEnd timera -> nextRound (ako je autoNextRound)
                    if (keepAuto) {
                        setTimeout(() => {
                            database.ref('gameState').once('value').then(snap => {
                                const state = snap.val();
                                if (state && state.autoMode && state.phase === 'roundEnd') {
                                    console.log('‚è≠Ô∏è Auto next round');
                                    nextRound();
                                }
                            });
                        }, roundEndTimer * 1000);
                    }
                });
                return;
            }
            
            // Update to next question - postavi answering odmah da nema flash pause
            database.ref('gameState').update({
                currentQuestion: nextQ,
                phase: 'answering',
                autoMode: true
            });
            database.ref('answers').set({});
            
            // AUTO: Pokreni sljedeƒáe pitanje
            setTimeout(() => {
                database.ref('gameState').once('value').then(snap => {
                    const state = snap.val();
                    if (state && state.autoMode) {
                        console.log('‚ñ∂Ô∏è Auto starting question immediately:', nextQ);
                        startQuestion();
                    }
                });
            }, 100);
        }

        function nextRound() {
            const nextR = gameState.currentRound + 1;
            
            // Provjera da li je kraj kviza
            if (nextR > settings.numRounds) {
                database.ref('gameState').update({
                    phase: 'gameEnd',
                    timerEnd: null
                });
                return;
            }
            
            // Koristi server timestamp za waiting timer izmeƒëu krugova
            database.ref('.info/serverTimeOffset').once('value').then(offsetSnap => {
                const offset = offsetSnap.val() || 0;
                const serverTime = Date.now() + offset;
                const noviKrugTimer = settings.noviKrugTimer || 5;
                const timerEnd = serverTime + (noviKrugTimer * 1000);
                
                database.ref('gameState').update({
                    currentRound: nextR,
                    currentQuestion: 0,
                    phase: 'waiting',
                    timerEnd: timerEnd,
                    autoMode: true
                });
                console.log('‚è∞ Waiting za novi krug:', noviKrugTimer + 's');
                
                // AUTO: Nakon waiting timera -> prvo pitanje novog kruga
                setTimeout(() => {
                    database.ref('gameState').once('value').then(snap => {
                        const state = snap.val();
                        if (state && state.autoMode && state.phase === 'waiting') {
                            console.log('‚ñ∂Ô∏è Auto starting first question of round', nextR);
                            startQuestion();
                        }
                    });
                }, noviKrugTimer * 1000);
            });
            database.ref('answers').set({});
        }
        
        function autoKickPlayers(remainingCount) {
            database.ref('players').once('value').then(snap => {
                const players = snap.val() || {};
                const sorted = Object.entries(players)
                    .map(([id, data]) => ({id, ...data}))
                    .sort((a, b) => {
                        // Sort by score, then by total time (lower is better)
                        if (b.score !== a.score) return b.score - a.score;
                        return (a.totalTime || 0) - (b.totalTime || 0);
                    });
                
                console.log('üìä Current standings:', sorted.map(p => `${p.name}: ${p.score}‚Ç¨`));
                
                // Kick players beyond remainingCount and save their frozen rank
                sorted.forEach((player, idx) => {
                    if (idx >= remainingCount) {
                        const frozenRank = idx + 1; // Their rank when eliminated
                        console.log(`üö´ Kicking player ${frozenRank}: ${player.name} (${player.score}‚Ç¨)`);
                        database.ref(`players/${player.id}`).update({
                            eliminated: true,
                            eliminatedRound: gameState.currentRound,
                            eliminatedRank: frozenRank  // Save frozen position
                        });
                    }
                });
            });
        }

        function pauseGame() {
            database.ref('gameState').update({ 
                autoMode: false,
                phase: 'paused', 
                timerEnd: null 
            });
        }

        function resumeGame() {
            database.ref('gameState').update({ 
                autoMode: true,
                phase: 'waiting'
            });
            setTimeout(() => {
                database.ref('gameState').once('value').then(snap => {
                    const state = snap.val();
                    if (state && state.autoMode) startQuestion();
                });
            }, 2000);
        }

        function resetPlayers() {
            if (confirm('‚ùå RESET PLAYERS - All players will be deleted! Are you sure?')) {
                database.ref('players').set({}).then(() => {
                    alert('‚úÖ All players deleted!');
                });
            }
        }

        function kickPlayer(playerId, playerName) {
            if (confirm(`‚ùå Kick player "${playerName}" from game?`)) {
                database.ref(`players/${playerId}`).remove().then(() => {
                    // Ukloni i njegove odgovore
                    database.ref(`answers/${playerId}`).remove();
                    console.log(`‚úÖ Igraƒç ${playerName} kicked from game`);
                });
            }
        }

        function resetGame() {
            if (confirm('‚ùå RESET QUIZ - The entire game, all players and answers will be deleted! Are you sure?')) {
                database.ref('gameState').set({
                    phase: 'waiting',
                    currentRound: 1,
                    currentQuestion: 0,
                    isActive: false,
                    autoMode: false,
                    timerEnd: null
                });
                database.ref('players').set({});
                database.ref('answers').set({});
                alert('‚úÖ Quiz reset!');
            }
        }

        function exportData() {
            let csv = 'Igraƒç,Score,Cunning(?),Uskliƒçno(!),Time\n';
            Object.values(players).forEach(p => {
                csv += `${p.name},${p.score || 0},${p.cunningCount || 0},${p.exclamationCount || 0},${p.totalTime || 0}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'cunning_rezultati.csv';
            a.click();
        }

        function loadCSV() {
            const file = document.getElementById('csvFile').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const lines = e.target.result.split('\n');
                const newQuestions = [];
                
                lines.forEach((line, idx) => {
                    if (idx === 0 || !line.trim()) return; // Skip header
                    const parts = line.split(',').map(s => s.trim());
                    if (parts.length >= 7 && parts[1]) {
                        newQuestions.push({
                            round: parseInt(parts[0]),
                            text: parts[1],
                            answers: [parts[2], parts[3], parts[4], parts[5]],
                            correct: parseInt(parts[6])
                        });
                    }
                });
                
                if (newQuestions.length > 0) {
                    database.ref('questions').set(newQuestions).then(() => {
                        alert(`‚úÖ Loaded ${newQuestions.length} questions!`);
                    });
                } else {
                    alert('‚ùå No valid questions in CSV file!');
                }
            };
            reader.readAsText(file);
        }

        function toggleAddQuestion() {
            const form = document.getElementById('addQuestionForm');
            const btn = document.getElementById('btnShowAddQuestion');
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                btn.classList.add('hidden');
            } else {
                form.classList.add('hidden');
                btn.classList.remove('hidden');
            }
        }

        function updateQuestionsList() {
            const container = document.getElementById('questionsList');
            const count = document.getElementById('questionCount2');
            count.textContent = questions.length;
            
            if (questions.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No questions added</p>';
                return;
            }
            
            const html = questions.map((q, idx) => `
                <div class="p-3 bg-white rounded mb-2 border border-gray-200">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <span class="font-bold" style="color: #ea580c;">${idx + 1}.</span>
                            <span class="font-bold">Round ${q.round}:</span>
                            <span class="ml-2">${q.text}</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editQuestion(${idx})" class="text-blue-600 hover:text-blue-800 text-sm">‚úèÔ∏è Edit</button>
                            <button onclick="deleteQuestion(${idx})" class="text-red-600 hover:text-red-800 text-sm">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600 ml-4">
                        <div>A: ${q.answers[0]}</div>
                        <div>B: ${q.answers[1]}</div>
                        <div>C: ${q.answers[2]}</div>
                        <div>D: ${q.answers[3]}</div>
                        <div class="mt-1 font-bold text-green-600">Correct: ${String.fromCharCode(65 + q.correct)}</div>
                    </div>
                </div>
            `).join('');
            container.innerHTML = html;
        }

        function deleteQuestion(index) {
            if (confirm('Delete this question?')) {
                questions.splice(index, 1);
                database.ref('questions').set(questions);
            }
        }

        function editQuestion(index) {
            const q = questions[index];
            
            // Popuni formu s postojeƒáim podacima
            document.getElementById('newQuestionText').value = q.text;
            document.getElementById('newAnswerA').value = q.answers[0];
            document.getElementById('newAnswerB').value = q.answers[1];
            document.getElementById('newAnswerC').value = q.answers[2];
            document.getElementById('newAnswerD').value = q.answers[3];
            document.getElementById('newQuestionRound').value = q.round;
            document.getElementById('newQuestionCorrect').value = q.correct;
            
            // Promijeni gumb u "Update"
            const addBtn = document.querySelector('#addQuestionForm button[onclick="addQuestionManually()"]');
            addBtn.textContent = '‚úÖ Update Question';
            addBtn.setAttribute('onclick', `updateQuestion(${index})`);
            
            // Prika≈æi formu
            const form = document.getElementById('addQuestionForm');
            const btn = document.getElementById('btnShowAddQuestion');
            form.classList.remove('hidden');
            btn.classList.add('hidden');
            
            // Scroll do forme
            form.scrollIntoView({ behavior: 'smooth' });
        }

        function updateQuestion(index) {
            const text = document.getElementById('newQuestionText').value.trim();
            const answerA = document.getElementById('newAnswerA').value.trim();
            const answerB = document.getElementById('newAnswerB').value.trim();
            const answerC = document.getElementById('newAnswerC').value.trim();
            const answerD = document.getElementById('newAnswerD').value.trim();
            const round = parseInt(document.getElementById('newQuestionRound').value);
            const correct = parseInt(document.getElementById('newQuestionCorrect').value);

            if (!text || !answerA || !answerB || !answerC || !answerD) {
                alert('‚ùå Fill in all fields!');
                return;
            }

            questions[index] = {
                round: round,
                text: text,
                answers: [answerA, answerB, answerC, answerD],
                correct: correct
            };

            database.ref('questions').set(questions).then(() => {
                alert('‚úÖ Question updated!');
                // Clear form i vrati gumb na "Add"
                document.getElementById('newQuestionText').value = '';
                document.getElementById('newAnswerA').value = '';
                document.getElementById('newAnswerB').value = '';
                document.getElementById('newAnswerC').value = '';
                document.getElementById('newAnswerD').value = '';
                
                const addBtn = document.querySelector('#addQuestionForm button');
                addBtn.textContent = '‚úÖ Add Question';
                addBtn.setAttribute('onclick', 'addQuestionManually()');
                
                toggleAddQuestion();
            });
        }

        function addQuestionManually() {
            const text = document.getElementById('newQuestionText').value.trim();
            const answerA = document.getElementById('newAnswerA').value.trim();
            const answerB = document.getElementById('newAnswerB').value.trim();
            const answerC = document.getElementById('newAnswerC').value.trim();
            const answerD = document.getElementById('newAnswerD').value.trim();
            const round = parseInt(document.getElementById('newQuestionRound').value);
            const correct = parseInt(document.getElementById('newQuestionCorrect').value);

            if (!text || !answerA || !answerB || !answerC || !answerD) {
                alert('‚ùå Fill in all fields!');
                return;
            }

            const newQuestion = {
                round: round,
                text: text,
                answers: [answerA, answerB, answerC, answerD],
                correct: correct
            };

            database.ref('questions').once('value').then(snap => {
                const existingQuestions = snap.val() || [];
                existingQuestions.push(newQuestion);
                database.ref('questions').set(existingQuestions).then(() => {
                    alert('‚úÖ Question added!');
                    // Clear form
                    document.getElementById('newQuestionText').value = '';
                    document.getElementById('newAnswerA').value = '';
                    document.getElementById('newAnswerB').value = '';
                    document.getElementById('newAnswerC').value = '';
                    document.getElementById('newAnswerD').value = '';
                    toggleAddQuestion();
                });
            });
        }

        // Initialize default settings on first load
        database.ref('settings').once('value').then(snap => {
            if (!snap.val()) {
                database.ref('settings').set(defaultSettings);
            }
        });

        // Initialize default questions in English if none exist
        database.ref('questions').once('value').then(snap => {
            if (!snap.val() || snap.val().length === 0) {
                const defaultQuestions = [
                    { round: 1, text: "What is the capital of France?", answers: ["London", "Berlin", "Paris", "Madrid"], correct: 2 },
                    { round: 1, text: "Which planet is known as the Red Planet?", answers: ["Venus", "Mars", "Jupiter", "Saturn"], correct: 1 },
                    { round: 1, text: "What is 2 + 2?", answers: ["3", "4", "5", "6"], correct: 1 },
                    { round: 1, text: "Who painted the Mona Lisa?", answers: ["Picasso", "Van Gogh", "Da Vinci", "Rembrandt"], correct: 2 },
                    { round: 1, text: "What is the largest ocean on Earth?", answers: ["Atlantic", "Indian", "Arctic", "Pacific"], correct: 3 },
                    { round: 1, text: "How many continents are there?", answers: ["5", "6", "7", "8"], correct: 2 },
                    { round: 1, text: "What is the chemical symbol for gold?", answers: ["Go", "Gd", "Au", "Ag"], correct: 2 },
                    { round: 1, text: "Which country has the most population?", answers: ["India", "China", "USA", "Indonesia"], correct: 1 },
                    { round: 1, text: "What year did World War II end?", answers: ["1943", "1944", "1945", "1946"], correct: 2 },
                    { round: 1, text: "What is the smallest prime number?", answers: ["0", "1", "2", "3"], correct: 2 },
                    
                    { round: 2, text: "What is H2O?", answers: ["Hydrogen", "Oxygen", "Water", "Salt"], correct: 2 },
                    { round: 2, text: "Who wrote Romeo and Juliet?", answers: ["Dickens", "Shakespeare", "Austen", "Hemingway"], correct: 1 },
                    { round: 2, text: "How many legs does a spider have?", answers: ["6", "8", "10", "12"], correct: 1 },
                    { round: 2, text: "What is the speed of light?", answers: ["300,000 km/s", "150,000 km/s", "450,000 km/s", "600,000 km/s"], correct: 0 },
                    { round: 2, text: "Which vitamin comes from the sun?", answers: ["Vitamin A", "Vitamin B", "Vitamin C", "Vitamin D"], correct: 3 },
                    { round: 2, text: "What is the capital of Japan?", answers: ["Seoul", "Beijing", "Tokyo", "Bangkok"], correct: 2 },
                    { round: 2, text: "How many sides does a hexagon have?", answers: ["5", "6", "7", "8"], correct: 1 },
                    { round: 2, text: "What is the largest mammal?", answers: ["Elephant", "Blue Whale", "Giraffe", "Hippo"], correct: 1 },
                    { round: 2, text: "Which gas do plants absorb?", answers: ["Oxygen", "Nitrogen", "CO2", "Hydrogen"], correct: 2 },
                    { round: 2, text: "What is the tallest mountain?", answers: ["K2", "Everest", "Kilimanjaro", "Denali"], correct: 1 },
                    
                    { round: 3, text: "How many hours in a day?", answers: ["22", "23", "24", "25"], correct: 2 },
                    { round: 3, text: "What color is a ruby?", answers: ["Blue", "Green", "Red", "Yellow"], correct: 2 },
                    { round: 3, text: "Which animal is the fastest?", answers: ["Lion", "Cheetah", "Horse", "Eagle"], correct: 1 },
                    { round: 3, text: "What is the square root of 144?", answers: ["10", "11", "12", "13"], correct: 2 },
                    { round: 3, text: "How many days in a leap year?", answers: ["365", "366", "367", "364"], correct: 1 },
                    { round: 3, text: "What is the smallest country?", answers: ["Monaco", "Vatican", "Malta", "Andorra"], correct: 1 },
                    { round: 3, text: "Which planet is closest to the sun?", answers: ["Venus", "Earth", "Mercury", "Mars"], correct: 2 },
                    { round: 3, text: "How many strings on a guitar?", answers: ["4", "5", "6", "7"], correct: 2 },
                    { round: 3, text: "What is the freezing point of water?", answers: ["-1¬∞C", "0¬∞C", "1¬∞C", "32¬∞C"], correct: 1 },
                    { round: 3, text: "Which ocean is the smallest?", answers: ["Atlantic", "Indian", "Arctic", "Pacific"], correct: 2 },
                    
                    { round: 4, text: "How many colors in a rainbow?", answers: ["5", "6", "7", "8"], correct: 2 },
                    { round: 4, text: "What is the boiling point of water?", answers: ["90¬∞C", "95¬∞C", "100¬∞C", "105¬∞C"], correct: 2 },
                    { round: 4, text: "Which country invented pizza?", answers: ["France", "Italy", "Greece", "Spain"], correct: 1 },
                    { round: 4, text: "How many teeth in adult human?", answers: ["28", "30", "32", "34"], correct: 2 },
                    { round: 4, text: "What is the longest river?", answers: ["Amazon", "Nile", "Yangtze", "Mississippi"], correct: 1 },
                    { round: 4, text: "How many players in soccer team?", answers: ["9", "10", "11", "12"], correct: 2 },
                    { round: 4, text: "Which metal is liquid at room temp?", answers: ["Iron", "Gold", "Mercury", "Silver"], correct: 2 },
                    { round: 4, text: "What is the capital of Australia?", answers: ["Sydney", "Melbourne", "Canberra", "Perth"], correct: 2 },
                    { round: 4, text: "How many minutes in an hour?", answers: ["50", "55", "60", "65"], correct: 2 },
                    { round: 4, text: "Which animal builds dams?", answers: ["Otter", "Beaver", "Muskrat", "Platypus"], correct: 1 },
                    
                    { round: 5, text: "What is the currency of UK?", answers: ["Euro", "Pound", "Dollar", "Franc"], correct: 1 },
                    { round: 5, text: "How many Olympic rings?", answers: ["4", "5", "6", "7"], correct: 1 },
                    { round: 5, text: "Which fruit has seeds on outside?", answers: ["Apple", "Orange", "Strawberry", "Banana"], correct: 2 },
                    { round: 5, text: "What is the hardest natural substance?", answers: ["Gold", "Iron", "Diamond", "Platinum"], correct: 2 },
                    { round: 5, text: "How many bones in human body?", answers: ["196", "206", "216", "226"], correct: 1 },
                    { round: 5, text: "Which planet has rings?", answers: ["Jupiter", "Saturn", "Uranus", "All"], correct: 3 },
                    { round: 5, text: "What is the main ingredient in bread?", answers: ["Rice", "Wheat", "Corn", "Oats"], correct: 1 },
                    { round: 5, text: "How many states in USA?", answers: ["48", "49", "50", "51"], correct: 2 },
                    { round: 5, text: "Which bird can't fly?", answers: ["Penguin", "Sparrow", "Eagle", "Parrot"], correct: 0 },
                    { round: 5, text: "What is the largest organ in human?", answers: ["Heart", "Liver", "Skin", "Brain"], correct: 2 },
                    
                    { round: 6, text: "How many seconds in a minute?", answers: ["50", "55", "60", "65"], correct: 2 },
                    { round: 6, text: "What is the main gas in air?", answers: ["Oxygen", "Nitrogen", "CO2", "Hydrogen"], correct: 1 },
                    { round: 6, text: "Which is the hottest planet?", answers: ["Mercury", "Venus", "Mars", "Jupiter"], correct: 1 },
                    { round: 6, text: "How many cards in a deck?", answers: ["48", "50", "52", "54"], correct: 2 },
                    { round: 6, text: "What is the capital of Italy?", answers: ["Venice", "Milan", "Rome", "Naples"], correct: 2 },
                    { round: 6, text: "How many months have 31 days?", answers: ["6", "7", "8", "9"], correct: 1 },
                    { round: 6, text: "Which animal is known as King of Jungle?", answers: ["Tiger", "Lion", "Elephant", "Bear"], correct: 1 },
                    { round: 6, text: "What is the symbol for iron?", answers: ["Ir", "Fe", "In", "Fr"], correct: 1 },
                    { round: 6, text: "How many zeros in a billion?", answers: ["6", "7", "8", "9"], correct: 3 },
                    { round: 6, text: "Which is the smallest planet?", answers: ["Venus", "Mars", "Mercury", "Pluto"], correct: 2 }
                ];
                
                database.ref('questions').set(defaultQuestions).then(() => {
                    console.log('‚úÖ Default English questions initialized');
                });
            }
        });
    </script>
</body>
</html>