<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lukavac - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-900 via-orange-900 to-gray-900 min-h-screen p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6 border-2 border-orange-500">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold text-orange-500">âš™ï¸ LUKAVAC - Admin Panel</h1>
                <a href="index.html" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded">â† Nazad</a>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-gray-700 p-4 rounded">
                    <p class="text-white">Krug: <span class="text-orange-500 font-bold" id="currentRound">1</span></p>
                    <p class="text-white">Pitanje: <span class="text-orange-500 font-bold" id="currentQuestion">1</span></p>
                    <p class="text-white">Status: <span class="text-orange-500 font-bold" id="gamePhase">waiting</span></p>
                </div>
                <div class="bg-gray-700 p-4 rounded">
                    <p class="text-white">IgraÄi: <span class="text-orange-500 font-bold" id="playerCount">0</span></p>
                    <p class="text-white">Pitanja: <span class="text-orange-500 font-bold" id="questionCount">0</span></p>
                </div>
            </div>

            <div class="flex flex-wrap gap-3">
                <button onclick="initializeGame()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                    ğŸ® Inicijaliziraj igru
                </button>
                <button onclick="startQuestion()" id="btnStart" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                    â–¶ï¸ Pokreni pitanje (20s)
                </button>
                <button onclick="showAnswers()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">
                    ğŸ‘ï¸ PrikaÅ¾i odgovore (5s)
                </button>
                <button onclick="showResults()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded">
                    ğŸ“Š PrikaÅ¾i rezultate
                </button>
                <button onclick="nextQuestion()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded">
                    â­ï¸ SljedeÄ‡e pitanje
                </button>
                <button onclick="nextRound()" class="bg-pink-600 hover:bg-pink-700 text-white px-4 py-2 rounded">
                    ğŸ”„ SljedeÄ‡i krug
                </button>
                <button onclick="resetGame()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                    ğŸ—‘ï¸ Reset
                </button>
            </div>
        </div>

        <!-- Add Question -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6 border-2 border-orange-500">
            <h2 class="text-xl font-bold text-orange-500 mb-4">â• Dodaj novo pitanje</h2>
            <div class="space-y-3">
                <input type="text" id="newQuestionText" placeholder="Tekst pitanja" class="w-full bg-gray-700 text-white p-2 rounded">
                <input type="text" id="newAnswer0" placeholder="Odgovor A" class="w-full bg-gray-700 text-white p-2 rounded">
                <input type="text" id="newAnswer1" placeholder="Odgovor B" class="w-full bg-gray-700 text-white p-2 rounded">
                <input type="text" id="newAnswer2" placeholder="Odgovor C" class="w-full bg-gray-700 text-white p-2 rounded">
                <input type="text" id="newAnswer3" placeholder="Odgovor D" class="w-full bg-gray-700 text-white p-2 rounded">
                <div class="flex gap-3">
                    <select id="newCorrect" class="bg-gray-700 text-white p-2 rounded">
                        <option value="0">A - ToÄan</option>
                        <option value="1">B - ToÄan</option>
                        <option value="2">C - ToÄan</option>
                        <option value="3">D - ToÄan</option>
                    </select>
                    <select id="newRound" class="bg-gray-700 text-white p-2 rounded">
                        <option value="1">Krug 1</option>
                        <option value="2">Krug 2</option>
                        <option value="3">Krug 3</option>
                        <option value="4">Krug 4</option>
                        <option value="5">Krug 5</option>
                        <option value="6">Krug 6</option>
                    </select>
                    <input type="number" id="newValue" placeholder="Vrijednost" value="10" class="bg-gray-700 text-white p-2 rounded w-32">
                    <button onclick="addQuestion()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded">
                        Dodaj pitanje
                    </button>
                </div>
            </div>
        </div>

        <!-- Players List -->
        <div class="bg-gray-800 rounded-lg p-6 border-2 border-orange-500">
            <h2 class="text-xl font-bold text-orange-500 mb-4">ğŸ‘¥ IgraÄi</h2>
            <div id="playersList" class="grid grid-cols-2 gap-3">
                <!-- Dynamically populated -->
            </div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        let gameState = null;
        let players = {};
        let questions = [];

        // Listen to database changes
        database.ref('gameState').on('value', (snap) => {
            gameState = snap.val() || {};
            updateUI();
        });

        database.ref('players').on('value', (snap) => {
            players = snap.val() || {};
            updateUI();
            updatePlayersList();
        });

        database.ref('questions').on('value', (snap) => {
            questions = snap.val() || [];
            updateUI();
        });

        function updateUI() {
            document.getElementById('currentRound').textContent = gameState.currentRound || 1;
            document.getElementById('currentQuestion').textContent = (gameState.currentQuestion || 0) + 1;
            document.getElementById('gamePhase').textContent = gameState.phase || 'waiting';
            document.getElementById('playerCount').textContent = Object.keys(players).length;
            document.getElementById('questionCount').textContent = questions.length;
            
            const btnStart = document.getElementById('btnStart');
            btnStart.disabled = gameState.isActive;
            btnStart.className = gameState.isActive ? 
                'bg-gray-600 text-white px-4 py-2 rounded cursor-not-allowed' : 
                'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded';
        }

        function updatePlayersList() {
            const container = document.getElementById('playersList');
            const sorted = Object.entries(players)
                .map(([id, data]) => ({id, ...data}))
                .sort((a, b) => (b.score || 0) - (a.score || 0));
            
            container.innerHTML = sorted.map((player, idx) => `
                <div class="bg-gray-700 p-3 rounded">
                    <p class="text-white font-bold">${idx + 1}. ${player.name}</p>
                    <p class="text-orange-500">${player.score || 0} â‚¬</p>
                </div>
            `).join('');
        }

        function initializeGame() {
            if (confirm('Å½eliÅ¡ inicijalizirati novu igru? Ovo Ä‡e resetirati sve podatke!')) {
                database.ref('questions').set(INITIAL_QUESTIONS);
                database.ref('gameState').set({
                    currentRound: 1,
                    currentQuestion: 0,
                    isActive: false,
                    timerEnd: null,
                    showResults: false,
                    phase: 'waiting'
                });
                database.ref('players').set({});
                database.ref('answers').set({});
                alert('âœ… Igra inicijalizirana!');
            }
        }

        function startQuestion() {
            const now = Date.now();
            database.ref('gameState').update({
                isActive: true,
                timerEnd: now + 20000,
                showResults: false,
                phase: 'answering'
            });
        }

        function showAnswers() {
            database.ref('gameState').update({
                phase: 'showing_answers',
                timerEnd: Date.now() + 5000
            });
        }

        function showResults() {
            database.ref('gameState').update({
                showResults: true,
                phase: 'results',
                isActive: false
            });
            
            // Calculate scores
            calculateScores();
        }

        function calculateScores() {
            database.ref('answers').once('value').then(answersSnap => {
                const answers = answersSnap.val() || {};
                const currentQ = questions[gameState.currentQuestion];
                
                Object.entries(answers).forEach(([playerId, answerData]) => {
                    const correct = currentQ.correct === answerData.answer;
                    let points = 0;
                    
                    if (answerData.type === 'exclamation') {
                        points = correct ? currentQ.value : -currentQ.value;
                    } else if (answerData.type === 'period') {
                        points = correct ? currentQ.value / 2 : 0;
                    } else if (answerData.type === 'lukavac') {
                        points = correct ? currentQ.value / 2 : -currentQ.value / 2;
                    }
                    
                    database.ref(`players/${playerId}`).once('value').then(playerSnap => {
                        const currentScore = playerSnap.val()?.score || 0;
                        database.ref(`players/${playerId}/score`).set(currentScore + points);
                    });
                });
            });
        }

        function nextQuestion() {
            const nextQ = (gameState.currentQuestion || 0) + 1;
            database.ref('gameState').update({
                currentQuestion: nextQ,
                isActive: false,
                showResults: false,
                timerEnd: null,
                phase: 'waiting'
            });
            database.ref('answers').set({});
        }

        function nextRound() {
            const nextR = (gameState.currentRound || 1) + 1;
            database.ref('gameState').update({
                currentRound: nextR,
                currentQuestion: 0,
                isActive: false,
                showResults: false,
                timerEnd: null,
                phase: 'waiting'
            });
            database.ref('answers').set({});
        }

        function resetGame() {
            if (confirm('Sigurno Å¾eliÅ¡ resetirati cijelu igru?')) {
                initializeGame();
            }
        }

        function addQuestion() {
            const text = document.getElementById('newQuestionText').value;
            const answers = [
                document.getElementById('newAnswer0').value,
                document.getElementById('newAnswer1').value,
                document.getElementById('newAnswer2').value,
                document.getElementById('newAnswer3').value
            ];
            const correct = parseInt(document.getElementById('newCorrect').value);
            const round = parseInt(document.getElementById('newRound').value);
            const value = parseInt(document.getElementById('newValue').value);
            
            if (!text || answers.some(a => !a)) {
                alert('Popuni sva polja!');
                return;
            }
            
            const newQuestion = { text, answers, correct, round, value };
            const updated = [...questions, newQuestion];
            database.ref('questions').set(updated);
            
            // Clear form
            document.getElementById('newQuestionText').value = '';
            document.getElementById('newAnswer0').value = '';
            document.getElementById('newAnswer1').value = '';
            document.getElementById('newAnswer2').value = '';
            document.getElementById('newAnswer3').value = '';
            
            alert('âœ… Pitanje dodano!');
        }
    </script>
</body>
</html>