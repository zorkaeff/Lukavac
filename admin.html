<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lukavac - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #f5e6d3 0%, #d97706 50%, #f5e6d3 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .btn-primary {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            transition: all 0.3s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(249, 115, 22, 0.4);
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="card p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-4xl font-bold" style="color: #ea580c;">ü¶ä LUKAVAC - Admin Panel</h1>
                    <p class="text-gray-600 mt-2">Kontrolni centar kviza</p>
                </div>
                <div class="flex gap-3">
                    <a href="index.html" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">‚Üê Nazad</a>
                    <button onclick="toggleSettings()" class="px-4 py-2 btn-primary text-white rounded-lg">
                        ‚öôÔ∏è Postavke
                    </button>
                </div>
            </div>
        </div>

        <!-- Timer and Round Info at TOP -->
        <div class="card p-4 mb-6">
            <div class="flex justify-between items-center">
                <div class="flex-1">
                    <p class="text-gray-600 text-sm">Timer</p>
                    <p class="text-3xl font-bold" style="color: #ea580c;" id="timerDisplay">--</p>
                </div>
                <div class="flex-1 text-center">
                    <p class="text-gray-600 text-sm">Status</p>
                    <p class="text-2xl font-bold" style="color: #ea580c;" id="gameStatus">ƒåekanje</p>
                </div>
                <div class="flex-1 text-right">
                    <p class="text-gray-600 text-sm">Krug <span class="font-bold" id="currentRound">1</span> | Pitanje <span class="font-bold" id="currentQuestion">0</span></p>
                    <p class="text-sm" style="color: #ea580c;" id="rewardDisplay">! = 10‚Ç¨ | . = 5‚Ç¨ | ? = 2‚Ç¨</p>
                </div>
            </div>
        </div>

        <!-- Game Controls -->
        <div class="card p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4" style="color: #ea580c;">Kontrole Igre</h2>
            <div class="flex flex-wrap gap-3">
                <button onclick="startGame()" class="px-6 py-3 btn-primary text-white rounded-lg font-bold">
                    ‚ñ∂Ô∏è POKRENI KVIZ
                </button>
                <button onclick="pauseGame()" class="px-6 py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-bold">
                    ‚è∏Ô∏è Pauza
                </button>
                <button onclick="resumeGame()" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold">
                    ‚ñ∂Ô∏è Nastavi
                </button>
                <button onclick="nextQuestion()" class="px-6 py-3 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg font-bold">
                    ‚è≠Ô∏è Sljedeƒáe Pitanje
                </button>
                <button onclick="nextRound()" class="px-6 py-3 bg-pink-600 hover:bg-pink-700 text-white rounded-lg font-bold">
                    üîÑ Sljedeƒái Krug
                </button>
                <button onclick="resetPlayers()" class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold">
                    üë• Reset Igraƒça
                </button>
                <button onclick="resetGame()" class="px-6 py-3 bg-red-800 hover:bg-red-900 text-white rounded-lg font-bold">
                    üóëÔ∏è Reset Kviza
                </button>
                <button onclick="exportData()" class="px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-bold">
                    üì• Export CSV
                </button>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-6">
            <!-- Leaderboard -->
            <div class="card p-6">
                <h2 class="text-2xl font-bold mb-4" style="color: #ea580c;">üèÜ Poredak (Igraƒça: <span id="playerCount">0</span>)</h2>
                <div id="eliminationLine" class="hidden mb-3 p-2 bg-red-100 border-2 border-red-500 rounded text-center text-red-700 font-bold">
                    ‚ö†Ô∏è CRTA ISPADANJA ‚ö†Ô∏è
                </div>
                <div id="leaderboard" class="space-y-2">
                    <!-- Dynamically populated -->
                </div>
            </div>

            <!-- Current Answers -->
            <div class="card p-6">
                <h2 class="text-2xl font-bold mb-4" style="color: #ea580c;">üìä Trenutni Odgovori</h2>
                <div id="currentAnswers" class="space-y-2">
                    <!-- Dynamically populated -->
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 overflow-y-auto z-50">
        <div class="card p-8 max-w-6xl w-full max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold" style="color: #ea580c;">‚öôÔ∏è Postavke Kviza</h2>
                <button onclick="toggleSettings()" class="text-3xl hover:text-red-600">√ó</button>
            </div>

            <!-- Basic Settings -->
            <div class="mb-6">
                <h3 class="text-xl font-bold mb-3" style="color: #ea580c;">Osnovne Postavke</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-2">Naziv Kviza</label>
                        <input type="text" id="quizName" value="LUKAVAC DANA" class="w-full p-2 border-2 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">≈†ifra za Ulaz</label>
                        <input type="text" id="quizPassword" value="1234" class="w-full p-2 border-2 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">Min. Broj Igraƒça</label>
                        <input type="number" id="minPlayers" value="2" min="2" max="999" class="w-full p-2 border-2 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">Max. Broj Igraƒça</label>
                        <input type="number" id="maxPlayersInput" value="8" min="2" max="999" class="w-full p-2 border-2 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">Broj Krugova</label>
                        <input type="number" id="numRounds" value="6" min="1" max="99" onchange="generateRoundSettings()" class="w-full p-2 border-2 rounded-lg">
                    </div>
                </div>
            </div>

            <!-- Round Settings -->
            <div class="mb-6">
                <h3 class="text-xl font-bold mb-3" style="color: #ea580c;">Postavke po Krugovima</h3>
                <div id="roundSettings">
                    <!-- Dynamically generated -->
                </div>
            </div>

            <!-- Questions Management -->
            <div class="mb-6">
                <h3 class="text-xl font-bold mb-3" style="color: #ea580c;">üìù Upravljanje Pitanjima</h3>
                
                <!-- Questions List -->
                <div class="mb-4 p-4 rounded-lg max-h-96 overflow-y-auto" style="background: #f5e6d3;">
                    <h4 class="font-bold mb-2">Dodana pitanja (<span id="questionCount2">0</span>):</h4>
                    <div id="questionsList" class="space-y-2 text-sm">
                        <!-- Dynamically populated -->
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-2">Uƒçitaj CSV File</label>
                    <input type="file" id="csvFile" accept=".csv" onchange="loadCSV()" class="w-full p-2 border-2 rounded-lg">
                    <p class="text-xs text-gray-600 mt-1">Format: round,text,answer_a,answer_b,answer_c,answer_d,correct</p>
                </div>
                
                <button onclick="toggleAddQuestion()" id="btnShowAddQuestion" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold mb-2">
                    ‚ûï Dodaj Pitanje Ruƒçno
                </button>

                <div id="addQuestionForm" class="hidden p-4 bg-gray-50 rounded-lg mb-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold mb-1">Krug</label>
                            <input type="number" id="newQuestionRound" value="1" min="1" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-xs font-bold mb-1">Toƒçan odgovor</label>
                            <select id="newQuestionCorrect" class="w-full p-2 border rounded">
                                <option value="0">A</option>
                                <option value="1">B</option>
                                <option value="2">C</option>
                                <option value="3">D</option>
                            </select>
                        </div>
                    </div>
                    <label class="block text-xs font-bold mb-1 mt-2">Tekst pitanja</label>
                    <textarea id="newQuestionText" class="w-full p-2 border rounded mb-2" rows="2"></textarea>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs font-bold mb-1">Odgovor A</label>
                            <input type="text" id="newAnswerA" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-xs font-bold mb-1">Odgovor B</label>
                            <input type="text" id="newAnswerB" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-xs font-bold mb-1">Odgovor C</label>
                            <input type="text" id="newAnswerC" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-xs font-bold mb-1">Odgovor D</label>
                            <input type="text" id="newAnswerD" class="w-full p-2 border rounded">
                        </div>
                    </div>
                    
                    <div class="flex gap-2 mt-3">
                        <button onclick="addQuestionManually()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded font-bold">
                            ‚úÖ Spremi
                        </button>
                        <button onclick="toggleAddQuestion()" class="px-4 py-2 bg-gray-400 hover:bg-gray-500 text-white rounded font-bold">
                            ‚úñÔ∏è Odustani
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="saveSettings()" class="flex-1 py-3 btn-primary text-white rounded-lg font-bold">
                    üíæ Spremi Postavke
                </button>
                <button onclick="toggleSettings()" class="px-6 py-3 bg-gray-400 hover:bg-gray-500 text-white rounded-lg font-bold">
                    Zatvori
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Question Modal -->
    <div id="editQuestionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="card p-6 max-w-2xl w-full">
            <h3 class="text-2xl font-bold mb-4" style="color: #ea580c;">‚úèÔ∏è Uredi Pitanje</h3>
            
            <div class="mb-3">
                <label class="block text-sm font-bold mb-1">Krug</label>
                <input type="number" id="editQuestionRound" class="w-full p-2 border-2 rounded-lg">
            </div>
            
            <div class="mb-3">
                <label class="block text-sm font-bold mb-1">Tekst Pitanja</label>
                <textarea id="editQuestionText" class="w-full p-2 border-2 rounded-lg" rows="3"></textarea>
            </div>
            
            <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                    <label class="block text-sm font-bold mb-1">Odgovor A</label>
                    <input type="text" id="editAnswerA" class="w-full p-2 border-2 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Odgovor B</label>
                    <input type="text" id="editAnswerB" class="w-full p-2 border-2 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Odgovor C</label>
                    <input type="text" id="editAnswerC" class="w-full p-2 border-2 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Odgovor D</label>
                    <input type="text" id="editAnswerD" class="w-full p-2 border-2 rounded-lg">
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-bold mb-1">Toƒçan Odgovor</label>
                <select id="editQuestionCorrect" class="w-full p-2 border-2 rounded-lg">
                    <option value="0">A</option>
                    <option value="1">B</option>
                    <option value="2">C</option>
                    <option value="3">D</option>
                </select>
            </div>
            
            <div class="flex gap-3">
                <button onclick="saveEditedQuestion()" class="flex-1 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold">
                    ‚úÖ Spremi Promjene
                </button>
                <button onclick="closeEditModal()" class="px-6 py-2 bg-gray-400 hover:bg-gray-500 text-white rounded-lg font-bold">
                    Odustani
                </button>
            </div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        let gameState = {};
        let players = {};
        let settings = {};
        let questions = [];
        let currentQuestion = null;
        let timerInterval = null;
        let allAnswers = {};
        let editingQuestionIndex = -1;

        const defaultSettings = {
            quizName: 'LUKAVAC DANA',
            password: '1234',
            minPlayers: 2,
            maxPlayers: 8,
            rounds: [
                { 
                    numQuestions: 3,
                    eliminatePlayers: 2, 
                    time1: 20, time2: 10, timePause: 3, timeAnswer: 5,
                    rewardExclamation: 10, rewardPeriod: 5, rewardLukavac: 2
                },
                { 
                    numQuestions: 3,
                    eliminatePlayers: 1, 
                    time1: 20, time2: 10, timePause: 3, timeAnswer: 5,
                    rewardExclamation: 20, rewardPeriod: 10, rewardLukavac: 5
                },
                { 
                    numQuestions: 3,
                    eliminatePlayers: 1, 
                    time1: 20, time2: 10, timePause: 3, timeAnswer: 5,
                    rewardExclamation: 30, rewardPeriod: 15, rewardLukavac: 7
                },
                { 
                    numQuestions: 3,
                    eliminatePlayers: 1, 
                    time1: 20, time2: 10, timePause: 3, timeAnswer: 5,
                    rewardExclamation: 40, rewardPeriod: 20, rewardLukavac: 10
                },
                { 
                    numQuestions: 3,
                    eliminatePlayers: 1, 
                    time1: 20, time2: 10, timePause: 3, timeAnswer: 5,
                    rewardExclamation: 50, rewardPeriod: 25, rewardLukavac: 12
                },
                { 
                    numQuestions: 3,
                    eliminatePlayers: 1, 
                    time1: 20, time2: 10, timePause: 3, timeAnswer: 5,
                    rewardExclamation: 60, rewardPeriod: 30, rewardLukavac: 15
                }
            ]
        };

        // Firebase listeners
        database.ref('settings').on('value', snap => {
            settings = snap.val() || defaultSettings;
            loadSettingsToForm();
            updateRewardDisplay();
        });

        database.ref('gameState').on('value', snap => {
            gameState = snap.val() || {};
            updateStatus();
            startTimer();
        });

        database.ref('players').on('value', snap => {
            players = snap.val() || {};
            updateLeaderboard();
        });

        database.ref('questions').on('value', snap => {
            questions = snap.val() || [];
            updateQuestionsList();
            loadCurrentQuestion();
        });

        database.ref('answers').on('value', snap => {
            allAnswers = snap.val() || {};
            showCurrentAnswers();
        });

        function loadCurrentQuestion() {
            if (gameState.currentQuestion !== undefined && questions.length > 0) {
                currentQuestion = questions[gameState.currentQuestion];
            }
        }

        function updateRewardDisplay() {
            if (!gameState.currentRound || !settings.rounds) return;
            const round = settings.rounds[gameState.currentRound - 1];
            if (!round) return;
            
            document.getElementById('rewardDisplay').textContent = 
                `! = ${round.rewardExclamation}‚Ç¨ | . = ${round.rewardPeriod}‚Ç¨ | ? = ${round.rewardLukavac}‚Ç¨`;
        }

        function updateStatus() {
            const phaseNames = {
                waiting: 'ƒåekanje',
                answering: 'Odgovaranje (Faza 1)',
                lukavac: 'Lukavac (Faza 2)',
                pause: 'Pauza',
                showAnswer: 'Prikaz Odgovora',
                roundEnd: 'Kraj Kruga',
                gameEnd: 'Kraj Igre',
                paused: 'Pauzirano'
            };
            document.getElementById('gameStatus').textContent = phaseNames[gameState.phase] || 'Nepoznato';
            document.getElementById('playerCount').textContent = Object.keys(players).length;
            document.getElementById('currentRound').textContent = gameState.currentRound || 1;
            document.getElementById('currentQuestion').textContent = (gameState.currentQuestion || 0) + 1;
            updateRewardDisplay();
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (!gameState.timerEnd) {
                    document.getElementById('timerDisplay').textContent = '--';
                    return;
                }
                const timeLeft = Math.max(0, Math.ceil((gameState.timerEnd - Date.now()) / 1000));
                document.getElementById('timerDisplay').textContent = timeLeft + 's';
                if (timeLeft === 0) clearInterval(timerInterval);
            }, 100);
        }

        function updateLeaderboard() {
            const sorted = Object.entries(players)
                .map(([id, data]) => ({ id, ...data }))
                .sort((a, b) => {
                    if (b.score !== a.score) return b.score - a.score;
                    if (b.lukavacCount !== a.lukavacCount) return b.lukavacCount - a.lukavacCount;
                    if (b.exclamationCount !== a.exclamationCount) return b.exclamationCount - a.exclamationCount;
                    return a.totalTime - b.totalTime;
                });

            // Prika≈æi crtu ispadanja
            const currentRound = gameState.currentRound || 1;
            const roundSettings = settings.rounds ? settings.rounds[currentRound - 1] : null;
            const toEliminate = roundSettings ? roundSettings.eliminatePlayers : 1;
            const eliminationIndex = sorted.length - toEliminate;

            const html = sorted.map((player, idx) => {
                const timeInMs = player.totalTime || 0;
                const scoreChange = player.lastScoreChange || 0;
                const scoreChangeText = scoreChange !== 0 ? ` (${scoreChange > 0 ? '+' : ''}${scoreChange}‚Ç¨)` : '';
                
                const isAboveLine = idx < eliminationIndex;
                const borderStyle = idx === eliminationIndex - 1 && gameState.phase !== 'gameEnd' ? 
                    'border-b-4 border-red-500' : '';
                
                return `
                <div class="flex justify-between items-center p-3 rounded-lg ${borderStyle}" style="background: #f5e6d3;">
                    <div class="flex items-center gap-3">
                        <span class="text-xl font-bold" style="color: #ea580c;">${idx + 1}.</span>
                        <span class="font-bold">${player.name}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-xl font-bold" style="color: #ea580c;">${player.score || 0}‚Ç¨${scoreChangeText}</span>
                        <span class="text-xs text-gray-600">‚è±Ô∏è${timeInMs}ms</span>
                        <button onclick="kickPlayer('${player.id}')" class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-xs font-bold">
                            ‚ùå Izbaci
                        </button>
                    </div>
                </div>
            `}).join('');
            
            document.getElementById('leaderboard').innerHTML = html || '<p class="text-gray-500">Nema igraƒça</p>';
            
            // Prika≈æi upozorenje o crti ispadanja
            if (sorted.length > 0 && gameState.phase !== 'gameEnd' && toEliminate > 0) {
                document.getElementById('eliminationLine').classList.remove('hidden');
                document.getElementById('eliminationLine').textContent = 
                    `‚ö†Ô∏è CRTA ISPADANJA - Ispada ${toEliminate} igraƒça ‚ö†Ô∏è`;
            } else {
                document.getElementById('eliminationLine').classList.add('hidden');
            }
        }

        function showCurrentAnswers() {
            if (!currentQuestion || !gameState.phase || gameState.phase === 'waiting') {
                document.getElementById('currentAnswers').innerHTML = '<p class="text-gray-500">Nema trenutnih odgovora</p>';
                return;
            }

            const correctAnswer = currentQuestion.correct;
            const showCorrectness = gameState.phase === 'showAnswer' || gameState.phase === 'lukavac';

            const html = Object.entries(allAnswers).map(([pid, data]) => {
                const player = players[pid];
                if (!player) return '';
                
                if (data.pending && data.answer === -1) {
                    return `
                        <div class="p-2 rounded-lg text-center" style="background: #a855f7;">
                            <p class="text-white font-bold text-sm">${player.name}</p>
                            <p class="text-white text-xl font-bold">? (ƒçeka)</p>
                            <p class="text-white text-xs">${data.timestamp}ms</p>
                        </div>
                    `;
                }
                
                const answerLabel = data.answer >= 0 ? String.fromCharCode(65 + data.answer) : '?';
                const typeSymbol = data.type === 'exclamation' ? '!' : data.type === 'period' ? '.' : '?';
                
                let bgColor;
                if (showCorrectness && data.answer >= 0) {
                    bgColor = data.answer === correctAnswer ? '#10b981' : '#ef4444';
                } else {
                    bgColor = data.type === 'exclamation' ? '#ef4444' :
                              data.type === 'period' ? '#3b82f6' : '#a855f7';
                }
                
                return `
                    <div class="p-2 rounded-lg text-center" style="background: ${bgColor};">
                        <p class="text-white font-bold text-sm">${player.name}</p>
                        <p class="text-white text-xl font-bold">${answerLabel}${typeSymbol}</p>
                        <p class="text-white text-xs">${data.timestamp || 0}ms</p>
                    </div>
                `;
            }).join('');
            document.getElementById('currentAnswers').innerHTML = html || '<p class="text-gray-500">Nema odgovora</p>';
        }

        function kickPlayer(playerId) {
            const player = players[playerId];
            if (!player) return;
            
            if (confirm(`Sigurno ≈æeli≈° izbaciti igraƒça "${player.name}"?`)) {
                database.ref(`players/${playerId}`).remove();
                database.ref(`answers/${playerId}`).remove();
                alert(`‚úÖ Igraƒç "${player.name}" je izbaƒçen!`);
            }
        }

        function toggleSettings() {
            document.getElementById('settingsModal').classList.toggle('hidden');
        }

        function loadSettingsToForm() {
            document.getElementById('quizName').value = settings.quizName || 'LUKAVAC';
            document.getElementById('quizPassword').value = settings.password || '1234';
            document.getElementById('minPlayers').value = settings.minPlayers || 2;
            document.getElementById('maxPlayersInput').value = settings.maxPlayers || 8;
            document.getElementById('numRounds').value = (settings.rounds || []).length || 6;
            generateRoundSettings();
        }

        function generateRoundSettings() {
            const numRounds = parseInt(document.getElementById('numRounds').value);
            const container = document.getElementById('roundSettings');
            let html = '';
            
            for (let i = 0; i < numRounds; i++) {
                const round = (settings.rounds && settings.rounds[i]) || { 
                    numQuestions: 3,
                    eliminatePlayers: i === 0 ? 2 : 1,
                    time1: 20, time2: 10, timePause: 3, timeAnswer: 5,
                    rewardExclamation: (i+1)*10, rewardPeriod: (i+1)*5, rewardLukavac: (i+1)*2
                };
                html += `
                    <div class="p-4 mb-3 rounded-lg" style="background: #f5e6d3;">
                        <h4 class="font-bold mb-2">Krug ${i+1}</h4>
                        <div class="grid grid-cols-4 gap-2 text-sm mb-2">
                            <div>
                                <label class="block text-xs font-bold mb-1">Broj pitanja</label>
                                <input type="number" id="r${i}_numQuestions" value="${round.numQuestions || 3}" min="1" max="99" class="w-full p-1 border rounded">
                            </div>
                            <div>
                                <label class="block text-xs font-bold mb-1">Ispada igraƒça</label>
                                <input type="number" id="r${i}_eliminatePlayers" value="${round.eliminatePlayers || 1}" min="0" max="99" class="w-full p-1 border rounded">
                            </div>
                            <div>
                                <label class="block text-xs font-bold mb-1">Vrijeme 1 (s)</label>
                                <input type="number" id="r${i}_time1" value="${round.time1}" min="5" max="999" class="w-full p-1 border rounded">
                            </div>
                            <div>
                                <label class="block text-xs font-bold mb-1">Vrijeme 2 (s)</label>
                                <input type="number" id="r${i}_time2" value="${round.time2}" min="5" max="999" class="w-full p-1 border rounded">
                            </div>
                        </div>
                        <div class="grid grid-cols-5 gap-2 text-sm">
                            <div>
                                <label class="block text-xs font-bold mb-1">Pauza (s)</label>
                                <input type="number" id="r${i}_timePause" value="${round.timePause}" min="1" max="60" class="w-full p-1 border rounded">
                            </div>
                            <div>
                                <label class="block text-xs font-bold mb-1">Prikaz odg. (s)</label>
                                <input type="number" id="r${i}_timeAnswer" value="${round.timeAnswer}" min="1" max="60" class="w-full p-1 border rounded">
                            </div>
                            <div>
                                <label class="block text-xs font-bold mb-1">Nagrada ! (‚Ç¨)</label>
                                <input type="number" id="r${i}_rewardExclamation" value="${round.rewardExclamation || round.reward*2 || 10}" min="1" max="9999" class="w-full p-1 border rounded">
                            </div>
                            <div>
                                <label class="block text-xs font-bold mb-1">Nagrada . (‚Ç¨)</label>
                                <input type="number" id="r${i}_rewardPeriod" value="${round.rewardPeriod || round.reward || 5}" min="1" max="9999" class="w-full p-1 border rounded">
                            </div>
                            <div>
                                <label class="block text-xs font-bold mb-1">Nagrada ? (‚Ç¨)</label>
                                <input type="number" id="r${i}_rewardLukavac" value="${round.rewardLukavac || Math.floor((round.reward || 5)/2) || 2}" min="1" max="9999" class="w-full p-1 border rounded">
                            </div>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function saveSettings() {
            const numRounds = parseInt(document.getElementById('numRounds').value);
            const rounds = [];
            
            for (let i = 0; i < numRounds; i++) {
                rounds.push({
                    numQuestions: parseInt(document.getElementById(`r${i}_numQuestions`).value),
                    eliminatePlayers: parseInt(document.getElementById(`r${i}_eliminatePlayers`).value),
                    time1: parseInt(document.getElementById(`r${i}_time1`).value),
                    time2: parseInt(document.getElementById(`r${i}_time2`).value),
                    timePause: parseInt(document.getElementById(`r${i}_timePause`).value),
                    timeAnswer: parseInt(document.getElementById(`r${i}_timeAnswer`).value),
                    rewardExclamation: parseInt(document.getElementById(`r${i}_rewardExclamation`).value),
                    rewardPeriod: parseInt(document.getElementById(`r${i}_rewardPeriod`).value),
                    rewardLukavac: parseInt(document.getElementById(`r${i}_rewardLukavac`).value)
                });
            }

            const newSettings = {
                quizName: document.getElementById('quizName').value,
                password: document.getElementById('quizPassword').value,
                minPlayers: parseInt(document.getElementById('minPlayers').value),
                maxPlayers: parseInt(document.getElementById('maxPlayersInput').value),
                rounds: rounds
            };

            database.ref('settings').set(newSettings).then(() => {
                alert('‚úÖ Postavke spremljene!');
                toggleSettings();
            });
        }

        function startGame() {
            const playerCount = Object.keys(players).length;
            if (playerCount < (settings.minPlayers || 2)) {
                alert(`‚ùå Potrebno je najmanje ${settings.minPlayers || 2} igraƒça!`);
                return;
            }

            if (!questions || questions.length === 0) {
                alert('‚ùå Nema dodanih pitanja! Dodaj pitanja prvo.');
                return;
            }

            database.ref('gameState').set({
                phase: 'waiting',
                currentRound: 1,
                currentQuestion: 0,
                isActive: true,
                autoMode: true,
                timerEnd: null
            });

            database.ref('answers').set({});

            setTimeout(() => startQuestion(), 2000);
        }

        function startQuestion() {
            database.ref('gameState').once('value').then(snap => {
                const state = snap.val();
                if (!state || !state.autoMode) return;

                const round = settings.rounds[state.currentRound - 1];
                if (!round) return;

                database.ref('answers').set({});

                database.ref('gameState').update({
                    phase: 'answering',
                    timerEnd: Date.now() + (round.time1 * 1000)
                });

                setTimeout(() => {
                    database.ref('gameState').once('value').then(s => {
                        if (s.val() && s.val().autoMode) startLukavacPhase();
                    });
                }, round.time1 * 1000);
            });
        }

        function startLukavacPhase() {
            database.ref('gameState').once('value').then(snap => {
                const state = snap.val();
                if (!state || !state.autoMode) return;

                const round = settings.rounds[state.currentRound - 1];
                if (!round) return;

                database.ref('gameState').update({
                    phase: 'lukavac',
                    timerEnd: Date.now() + (round.time2 * 1000)
                });

                setTimeout(() => {
                    database.ref('gameState').once('value').then(s => {
                        if (s.val() && s.val().autoMode) startPausePhase();
                    });
                }, round.time2 * 1000);
            });
        }

        function startPausePhase() {
            database.ref('gameState').once('value').then(snap => {
                const state = snap.val();
                if (!state || !state.autoMode) return;

                const round = settings.rounds[state.currentRound - 1];
                if (!round) return;

                database.ref('gameState').update({
                    phase: 'pause',
                    timerEnd: Date.now() + (round.timePause * 1000)
                });

                setTimeout(() => {
                    database.ref('gameState').once('value').then(s => {
                        if (s.val() && s.val().autoMode) showAnswerPhase();
                    });
                }, round.timePause * 1000);
            });
        }

        function showAnswerPhase() {
            database.ref('gameState').once('value').then(snap => {
                const state = snap.val();
                if (!state || !state.autoMode) return;

                const round = settings.rounds[state.currentRound - 1];
                if (!round) return;

                calculateScores();

                database.ref('gameState').update({
                    phase: 'showAnswer',
                    timerEnd: Date.now() + (round.timeAnswer * 1000)
                });

                setTimeout(() => {
                    database.ref('gameState').once('value').then(s => {
                        if (s.val() && s.val().autoMode) checkNextQuestion();
                    });
                }, round.timeAnswer * 1000);
            });
        }

        function calculateScores() {
            database.ref('gameState').once('value').then(stateSnap => {
                const state = stateSnap.val();
                const currentRoundNum = state.currentRound;
                const currentQIndex = state.currentQuestion;
                const round = settings.rounds[currentRoundNum - 1];
                
                database.ref('questions').once('value').then(qSnap => {
                    const allQuestions = qSnap.val() || [];
                    const question = allQuestions[currentQIndex];
                    if (!question) return;

                    database.ref('answers').once('value').then(answersSnap => {
                        const answers = answersSnap.val() || {};
                        
                        database.ref('players').once('value').then(playersSnap => {
                            const currentPlayers = playersSnap.val() || {};
                            const updates = {};

                            Object.entries(currentPlayers).forEach(([pid, player]) => {
                                const answer = answers[pid];
                                let scoreChange = 0;

                                if (answer && answer.answer === question.correct) {
                                    if (answer.type === 'exclamation') {
                                        scoreChange = round.rewardExclamation;
                                    } else if (answer.type === 'period') {
                                        scoreChange = round.rewardPeriod;
                                    } else if (answer.type === 'lukavac') {
                                        scoreChange = round.rewardLukavac;
                                    }
                                }

                                const newScore = (player.score || 0) + scoreChange;
                                updates[`players/${pid}/score`] = newScore;
                                updates[`players/${pid}/lastScoreChange`] = scoreChange;

                                if (answer && answer.type === 'lukavac') {
                                    updates[`players/${pid}/lukavacCount`] = (player.lukavacCount || 0) + 1;
                                }
                                if (answer && answer.type === 'exclamation') {
                                    updates[`players/${pid}/exclamationCount`] = (player.exclamationCount || 0) + 1;
                                }
                                if (answer && answer.timestamp) {
                                    updates[`players/${pid}/totalTime`] = (player.totalTime || 0) + answer.timestamp;
                                }
                            });

                            database.ref().update(updates);
                        });
                    });
                });
            });
        }

        function checkNextQuestion() {
            database.ref('gameState').once('value').then(snap => {
                const state = snap.val();
                if (!state || !state.autoMode) return;

                const currentRound = state.currentRound;
                const roundSettings = settings.rounds[currentRound - 1];
                const roundQuestions = questions.filter(q => q.round === currentRound);
                const currentIndexInRound = roundQuestions.findIndex((_, idx) => 
                    questions.indexOf(roundQuestions[idx]) === state.currentQuestion
                );

                // Provjeri jesmo li zavr≈°ili s brojem pitanja za ovaj krug
                if (currentIndexInRound < roundQuestions.length - 1 && 
                    currentIndexInRound + 1 < roundSettings.numQuestions) {
                    const nextQuestion = roundQuestions[currentIndexInRound + 1];
                    const nextGlobalIndex = questions.indexOf(nextQuestion);
                    
                    database.ref('gameState').update({
                        currentQuestion: nextGlobalIndex
                    });
                    setTimeout(() => startQuestion(), 1000);
                } else {
                    endRound();
                }
            });
        }

        function endRound() {
            database.ref('gameState').once('value').then(snap => {
                const state = snap.val();
                if (!state || !state.autoMode) return;

                database.ref('gameState').update({
                    phase: 'roundEnd',
                    timerEnd: Date.now() + 5000
                });

                setTimeout(() => eliminatePlayers(), 3000);
            });
        }

        function eliminatePlayers() {
            database.ref('gameState').once('value').then(stateSnap => {
                const state = stateSnap.val();
                const roundSettings = settings.rounds[state.currentRound - 1];
                const toEliminate = roundSettings.eliminatePlayers;

                database.ref('players').once('value').then(snap => {
                    const currentPlayers = snap.val() || {};
                    const sorted = Object.entries(currentPlayers)
                        .map(([id, data]) => ({ id, ...data }))
                        .sort((a, b) => {
                            if (b.score !== a.score) return b.score - a.score;
                            if (b.lukavacCount !== a.lukavacCount) return b.lukavacCount - a.lukavacCount;
                            if (b.exclamationCount !== a.exclamationCount) return b.exclamationCount - a.exclamationCount;
                            return a.totalTime - b.totalTime;
                        });

                    const toKeep = sorted.slice(0, sorted.length - toEliminate);
                    const toRemove = sorted.slice(sorted.length - toEliminate);

                    toRemove.forEach(player => {
                        database.ref(`players/${player.id}`).remove();
                    });

                    setTimeout(() => checkNextRound(), 2000);
                });
            });
        }

        function checkNextRound() {
            database.ref('gameState').once('value').then(snap => {
                const state = snap.val();
                if (!state || !state.autoMode) return;

                database.ref('players').once('value').then(pSnap => {
                    const remaining = Object.keys(pSnap.val() || {}).length;

                    if (remaining <= 1 || state.currentRound >= settings.rounds.length) {
                        database.ref('gameState').update({
                            phase: 'gameEnd'
                        });
                    } else {
                        const nextRound = state.currentRound + 1;
                        const firstQuestionOfNextRound = questions.find(q => q.round === nextRound);
                        const nextQuestionIndex = questions.indexOf(firstQuestionOfNextRound);

                        database.ref('gameState').update({
                            currentRound: nextRound,
                            currentQuestion: nextQuestionIndex,
                            phase: 'waiting'
                        });

                        setTimeout(() => startQuestion(), 2000);
                    }
                });
            });
        }

        function nextQuestion() {
            database.ref('gameState').once('value').then(snap => {
                const state = snap.val();
                const currentRound = state.currentRound;
                const roundQuestions = questions.filter(q => q.round === currentRound);
                const currentIndexInRound = roundQuestions.findIndex((_, idx) => 
                    questions.indexOf(roundQuestions[idx]) === state.currentQuestion
                );

                if (currentIndexInRound < roundQuestions.length - 1) {
                    const nextQuestion = roundQuestions[currentIndexInRound + 1];
                    const nextGlobalIndex = questions.indexOf(nextQuestion);
                    database.ref('gameState').update({
                        currentQuestion: nextGlobalIndex,
                        phase: 'waiting',
                        autoMode: true
                    });
                    setTimeout(() => startQuestion(), 1000);
                } else {
                    alert('Nema vi≈°e pitanja u ovom krugu!');
                }
            });
        }

        function nextRound() {
            database.ref('gameState').once('value').then(snap => {
                const state = snap.val();
                if (state.currentRound >= settings.rounds.length) {
                    alert('Nema vi≈°e krugova!');
                    return;
                }

                const nextRound = state.currentRound + 1;
                const firstQuestionOfNextRound = questions.find(q => q.round === nextRound);
                if (!firstQuestionOfNextRound) {
                    alert('Nema pitanja za sljedeƒái krug!');
                    return;
                }
                const nextQuestionIndex = questions.indexOf(firstQuestionOfNextRound);

                database.ref('gameState').update({
                    currentRound: nextRound,
                    currentQuestion: nextQuestionIndex,
                    phase: 'waiting',
                    autoMode: true
                });

                setTimeout(() => startQuestion(), 1000);
            });
        }

        function pauseGame() {
            database.ref('gameState').update({ 
                autoMode: false,
                phase: 'paused', 
                timerEnd: null 
            });
        }

        function resumeGame() {
            database.ref('gameState').update({ 
                autoMode: true,
                phase: 'waiting'
            });
            setTimeout(() => {
                database.ref('gameState').once('value').then(snap => {
                    const state = snap.val();
                    if (state && state.autoMode) startQuestion();
                });
            }, 2000);
        }

        function resetPlayers() {
            if (confirm('‚ùå RESET IGRAƒåA - Obrisat ƒáe se svi igraƒçi! Sigurno?')) {
                database.ref('players').set({}).then(() => {
                    alert('‚úÖ Svi igraƒçi obrisani!');
                });
            }
        }

        function resetGame() {
            if (confirm('‚ùå RESET KVIZA - Obrisat ƒáe se cijela igra, svi igraƒçi i odgovori! Sigurno?')) {
                database.ref('gameState').set({
                    phase: 'waiting',
                    currentRound: 1,
                    currentQuestion: 0,
                    isActive: false,
                    autoMode: false,
                    timerEnd: null
                });
                database.ref('players').set({});
                database.ref('answers').set({});
                alert('‚úÖ Kviz resetiran!');
            }
        }

        function exportData() {
            let csv = 'Igraƒç,Bodovi,Lukavac(?),Uskliƒçno(!),Vrijeme(ms)\n';
            Object.values(players).forEach(p => {
                csv += `${p.name},${p.score || 0},${p.lukavacCount || 0},${p.exclamationCount || 0},${p.totalTime || 0}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'lukavac_rezultati.csv';
            a.click();
        }

        function loadCSV() {
            const file = document.getElementById('csvFile').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const lines = e.target.result.split('\n');
                const newQuestions = [];
                
                lines.forEach((line, idx) => {
                    if (idx === 0 || !line.trim()) return;
                    const parts = line.split(',').map(s => s.trim());
                    if (parts.length >= 7 && parts[1]) {
                        newQuestions.push({
                            round: parseInt(parts[0]),
                            text: parts[1],
                            answers: [parts[2], parts[3], parts[4], parts[5]],
                            correct: parseInt(parts[6])
                        });
                    }
                });
                
                if (newQuestions.length > 0) {
                    database.ref('questions').set(newQuestions).then(() => {
                        alert(`‚úÖ Uƒçitano ${newQuestions.length} pitanja!`);
                    });
                } else {
                    alert('‚ùå Nema validnih pitanja u CSV fileu!');
                }
            };
            reader.readAsText(file);
        }

        function toggleAddQuestion() {
            const form = document.getElementById('addQuestionForm');
            const btn = document.getElementById('btnShowAddQuestion');
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                btn.classList.add('hidden');
            } else {
                form.classList.add('hidden');
                btn.classList.remove('hidden');
            }
        }

        function updateQuestionsList() {
            const container = document.getElementById('questionsList');
            const count = document.getElementById('questionCount2');
            count.textContent = questions.length;
            
            if (questions.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Nema dodanih pitanja</p>';
                return;
            }
            
            const html = questions.map((q, idx) => `
                <div class="p-2 bg-white rounded flex justify-between items-center">
                    <div class="flex-1">
                        <span class="font-bold" style="color: #ea580c;">${idx + 1}.</span>
                        <span class="font-bold">Krug ${q.round}:</span>
                        ${q.text}
                        <span class="text-xs text-gray-600">(Toƒçno: ${String.fromCharCode(65 + q.correct)})</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editQuestion(${idx})" class="text-blue-600 hover:text-blue-800 text-xs font-bold">
                            ‚úèÔ∏è Uredi
                        </button>
                        <button onclick="deleteQuestion(${idx})" class="text-red-600 hover:text-red-800 text-xs font-bold">
                            üóëÔ∏è Obri≈°i
                        </button>
                    </div>
                </div>
            `).join('');
            container.innerHTML = html;
        }

        function editQuestion(index) {
            if (index < 0 || index >= questions.length) return;
            
            editingQuestionIndex = index;
            const q = questions[index];
            
            document.getElementById('editQuestionRound').value = q.round;
            document.getElementById('editQuestionText').value = q.text;
            document.getElementById('editAnswerA').value = q.answers[0];
            document.getElementById('editAnswerB').value = q.answers[1];
            document.getElementById('editAnswerC').value = q.answers[2];
            document.getElementById('editAnswerD').value = q.answers[3];
            document.getElementById('editQuestionCorrect').value = q.correct;
            
            document.getElementById('editQuestionModal').classList.remove('hidden');
        }

        function saveEditedQuestion() {
            if (editingQuestionIndex < 0 || editingQuestionIndex >= questions.length) {
                alert('‚ùå Gre≈°ka pri spremanju!');
                return;
            }
            
            const round = parseInt(document.getElementById('editQuestionRound').value);
            const text = document.getElementById('editQuestionText').value.trim();
            const answerA = document.getElementById('editAnswerA').value.trim();
            const answerB = document.getElementById('editAnswerB').value.trim();
            const answerC = document.getElementById('editAnswerC').value.trim();
            const answerD = document.getElementById('editAnswerD').value.trim();
            const correct = parseInt(document.getElementById('editQuestionCorrect').value);
            
            if (!text || !answerA || !answerB || !answerC || !answerD) {
                alert('‚ùå Popuni sva polja!');
                return;
            }
            
            questions[editingQuestionIndex] = {
                round: round,
                text: text,
                answers: [answerA, answerB, answerC, answerD],
                correct: correct
            };
            
            database.ref('questions').set(questions).then(() => {
                alert('‚úÖ Pitanje a≈æurirano!');
                closeEditModal();
            });
        }

        function closeEditModal() {
            document.getElementById('editQuestionModal').classList.add('hidden');
            editingQuestionIndex = -1;
        }

        function deleteQuestion(index) {
            if (confirm('Obrisati ovo pitanje?')) {
                questions.splice(index, 1);
                database.ref('questions').set(questions);
            }
        }

        function addQuestionManually() {
            const text = document.getElementById('newQuestionText').value.trim();
            const answerA = document.getElementById('newAnswerA').value.trim();
            const answerB = document.getElementById('newAnswerB').value.trim();
            const answerC = document.getElementById('newAnswerC').value.trim();
            const answerD = document.getElementById('newAnswerD').value.trim();
            const round = parseInt(document.getElementById('newQuestionRound').value);
            const correct = parseInt(document.getElementById('newQuestionCorrect').value);

            if (!text || !answerA || !answerB || !answerC || !answerD) {
                alert('‚ùå Popuni sva polja!');
                return;
            }

            const newQuestion = {
                round: round,
                text: text,
                answers: [answerA, answerB, answerC, answerD],
                correct: correct
            };

            database.ref('questions').once('value').then(snap => {
                const existingQuestions = snap.val() || [];
                existingQuestions.push(newQuestion);
                database.ref('questions').set(existingQuestions).then(() => {
                    alert('‚úÖ Pitanje dodano!');
                    document.getElementById('newQuestionText').value = '';
                    document.getElementById('newAnswerA').value = '';
                    document.getElementById('newAnswerB').value = '';
                    document.getElementById('newAnswerC').value = '';
                    document.getElementById('newAnswerD').value = '';
                    toggleAddQuestion();
                });
            });
        }

        // Initialize
        database.ref('settings').once('value').then(snap => {
            if (!snap.val()) {
                database.ref('settings').set(defaultSettings);
            }
        });
    </script>
</body>
</html>
